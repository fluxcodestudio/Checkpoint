---
phase: 03-claude-code-integration
plan: 02
type: execute
---

<objective>
Integrate Claude Code hooks with install/uninstall lifecycle.

Purpose: Make hooks installation automatic during project setup, with proper cleanup on uninstall.
Output: Updated install.sh and uninstall.sh with hooks management, config template with hooks settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-claude-code-integration/03-RESEARCH.md
@.planning/phases/03-claude-code-integration/03-01-SUMMARY.md (when available)

**Key files:**
@bin/install.sh
@bin/uninstall.sh
@templates/backup-config.sh
@templates/claude-settings.json (created in 03-01)
@.claude/hooks/backup-on-stop.sh (created in 03-01)

**Established patterns from Phase 2:**
- Conditional install based on config flag (WATCHER_ENABLED)
- Template copying with placeholder substitution
- Always cleanup on uninstall regardless of config

**From RESEARCH.md:**
- .claude/settings.json for project-scoped hooks
- .claude/settings.local.json for local overrides (gitignored)
- Hook scripts in .claude/hooks/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update config template with hooks settings</name>
  <files>templates/backup-config.sh</files>
  <action>
Add Claude Code hooks configuration section to templates/backup-config.sh (after the FILE WATCHER SETTINGS section):

```bash
# ==============================================================================
# CLAUDE CODE HOOKS SETTINGS
# ==============================================================================

# Enable Claude Code hooks for backup triggers (requires Claude Code CLI)
HOOKS_ENABLED=false

# Which events trigger backups (comma-separated)
# Options: stop (conversation end), edit (file changes), commit (git commits)
HOOKS_TRIGGERS="stop,edit,commit"
```

Do NOT modify existing settings - only ADD new section.
  </action>
  <verify>
grep -q "HOOKS_ENABLED" templates/backup-config.sh && echo "Hooks config added"
grep -q "HOOKS_TRIGGERS" templates/backup-config.sh && echo "Triggers config added"
  </verify>
  <done>
- templates/backup-config.sh updated with hooks section
- HOOKS_ENABLED, HOOKS_TRIGGERS documented
- Existing settings unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Update install.sh to install hooks</name>
  <files>bin/install.sh</files>
  <action>
Add hooks installation to install.sh (after watcher LaunchAgent section):

```bash
# Install Claude Code hooks if enabled
if [ "${HOOKS_ENABLED:-false}" = "true" ]; then
    echo "Installing Claude Code hooks..."

    # Create .claude/hooks directory
    mkdir -p "$PROJECT_DIR/.claude/hooks"

    # Copy hook scripts
    cp "$TEMPLATE_DIR/../.claude/hooks/backup-on-stop.sh" "$PROJECT_DIR/.claude/hooks/"
    cp "$TEMPLATE_DIR/../.claude/hooks/backup-on-edit.sh" "$PROJECT_DIR/.claude/hooks/"
    cp "$TEMPLATE_DIR/../.claude/hooks/backup-on-commit.sh" "$PROJECT_DIR/.claude/hooks/"

    # Make hooks executable
    chmod +x "$PROJECT_DIR/.claude/hooks/"*.sh

    # Merge hooks into existing .claude/settings.json or create new one
    CLAUDE_SETTINGS="$PROJECT_DIR/.claude/settings.json"
    HOOKS_TEMPLATE="$TEMPLATE_DIR/claude-settings.json"

    if [ -f "$CLAUDE_SETTINGS" ]; then
        # Backup existing settings
        cp "$CLAUDE_SETTINGS" "$CLAUDE_SETTINGS.backup.$(date +%Y%m%d%H%M%S)"

        # Merge hooks into existing settings using jq
        if command -v jq &> /dev/null; then
            jq -s '.[0] * .[1]' "$CLAUDE_SETTINGS" "$HOOKS_TEMPLATE" > "$CLAUDE_SETTINGS.tmp"
            mv "$CLAUDE_SETTINGS.tmp" "$CLAUDE_SETTINGS"
        else
            echo "  Warning: jq not found, cannot merge hooks into existing settings"
            echo "  Manually add hooks from $HOOKS_TEMPLATE to $CLAUDE_SETTINGS"
        fi
    else
        # Create new settings file
        mkdir -p "$PROJECT_DIR/.claude"
        cp "$HOOKS_TEMPLATE" "$CLAUDE_SETTINGS"
    fi

    echo "  Claude Code hooks installed (${HOOKS_TRIGGERS:-stop,edit,commit})"
fi
```

Key constraints:
- Do NOT break existing install logic
- Hooks install is OPTIONAL (only if HOOKS_ENABLED=true)
- Backup existing .claude/settings.json before merging
- Use jq for JSON merging (with fallback if not installed)
- Create .claude directory if it doesn't exist
  </action>
  <verify>
grep -q "HOOKS_ENABLED" bin/install.sh && echo "Hooks check in install.sh"
grep -q "backup-on-stop" bin/install.sh && echo "Hook script copy in install.sh"
bash -n bin/install.sh && echo "Syntax valid"
  </verify>
  <done>
- install.sh installs hooks when HOOKS_ENABLED=true
- Hook scripts copied to .claude/hooks/
- Settings merged into .claude/settings.json
- Existing settings backed up before merge
  </done>
</task>

<task type="auto">
  <name>Task 3: Update uninstall.sh to remove hooks</name>
  <files>bin/uninstall.sh</files>
  <action>
Add hooks cleanup to uninstall.sh (before or with existing cleanup):

```bash
# Remove Claude Code hooks if they exist
CLAUDE_HOOKS_DIR="$PROJECT_DIR/.claude/hooks"
if [ -d "$CLAUDE_HOOKS_DIR" ]; then
    # Remove backup hook scripts
    rm -f "$CLAUDE_HOOKS_DIR/backup-on-stop.sh"
    rm -f "$CLAUDE_HOOKS_DIR/backup-on-edit.sh"
    rm -f "$CLAUDE_HOOKS_DIR/backup-on-commit.sh"

    # Remove directory if empty
    rmdir "$CLAUDE_HOOKS_DIR" 2>/dev/null || true

    echo "  Claude Code hooks removed"
fi

# Remove hooks from .claude/settings.json if jq is available
CLAUDE_SETTINGS="$PROJECT_DIR/.claude/settings.json"
if [ -f "$CLAUDE_SETTINGS" ] && command -v jq &> /dev/null; then
    # Check if our hooks are in the settings
    if jq -e '.hooks.Stop[0].hooks[0].command | contains("backup-on-stop")' "$CLAUDE_SETTINGS" &> /dev/null; then
        # Remove our hook entries (preserving other hooks)
        jq 'del(.hooks.Stop[] | select(.hooks[].command | contains("backup-on")))
            | del(.hooks.PostToolUse[] | select(.hooks[].command | contains("backup-on")))
            | if .hooks.Stop == [] then del(.hooks.Stop) else . end
            | if .hooks.PostToolUse == [] then del(.hooks.PostToolUse) else . end
            | if .hooks == {} then del(.hooks) else . end' "$CLAUDE_SETTINGS" > "$CLAUDE_SETTINGS.tmp"
        mv "$CLAUDE_SETTINGS.tmp" "$CLAUDE_SETTINGS"
        echo "  Hooks removed from .claude/settings.json"
    fi
fi
```

Key constraints:
- Always cleanup hooks regardless of current config
- Only remove OUR hook scripts (backup-on-*.sh)
- Preserve other hooks in settings.json
- Don't fail if .claude directory or files don't exist
- Use jq for clean JSON manipulation (with check)
  </action>
  <verify>
grep -q "backup-on-stop" bin/uninstall.sh && echo "Hook cleanup in uninstall.sh"
grep -q "CLAUDE_HOOKS_DIR" bin/uninstall.sh && echo "Hooks dir cleanup in uninstall.sh"
bash -n bin/uninstall.sh && echo "Syntax valid"
  </verify>
  <done>
- uninstall.sh removes hook scripts
- uninstall.sh removes hooks from settings.json
- Cleanup is always attempted regardless of config
- Other hooks in settings.json are preserved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] templates/backup-config.sh has HOOKS_ENABLED, HOOKS_TRIGGERS
- [ ] bash -n bin/install.sh passes
- [ ] bash -n bin/uninstall.sh passes
- [ ] install.sh creates .claude/hooks/ and copies scripts
- [ ] install.sh merges hooks into .claude/settings.json
- [ ] uninstall.sh removes hooks scripts and settings
</verification>

<success_criteria>

- Config template updated with hooks settings
- install.sh conditionally installs hooks
- uninstall.sh cleans up hooks
- Phase 3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-claude-code-integration/03-02-SUMMARY.md`

Mark Phase 3 complete in ROADMAP.md and STATE.md
</output>
