---
phase: 03-claude-code-integration
plan: 01
type: execute
---

<objective>
Create Claude Code hook scripts for event-triggered backups.

Purpose: Implement hook scripts that trigger backups on Claude Code events (Stop, file edits, git commits).
Output: Hook scripts in .claude/hooks/, settings.json template with hook configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-claude-code-integration/03-RESEARCH.md
@.planning/phases/02-activity-triggers/02-01-SUMMARY.md
@.planning/phases/02-activity-triggers/02-02-SUMMARY.md

**Key files:**
@bin/smart-backup-trigger.sh
@bin/backup-daemon.sh
@templates/backup-config.sh

**Tech stack available:** Claude Code hooks (built-in), jq, bash
**Established patterns from Phase 2:**
- PID file tracking for background processes
- Config loading from .backup-config.sh
- Non-blocking background execution

**From RESEARCH.md - Don't hand-roll:**
- Event detection (use Claude Code hooks)
- Session tracking (use session_id from stdin)
- File path extraction (use jq on tool_input JSON)

**From RESEARCH.md - Key patterns:**
- Stop hook for conversation end
- PostToolUse with Edit|Write matcher for file changes
- PostToolUse with Bash(git commit*) matcher for commits
- Exit 0 always (non-blocking)
- Background execution for backup triggers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hook scripts for backup triggers</name>
  <files>.claude/hooks/backup-on-stop.sh, .claude/hooks/backup-on-edit.sh, .claude/hooks/backup-on-commit.sh</files>
  <action>
Create .claude/hooks/ directory and three hook scripts:

**backup-on-stop.sh** (Stop event - conversation end):
```bash
#!/usr/bin/env bash
# Trigger backup when Claude finishes responding
set -euo pipefail

# Read JSON from stdin
INPUT=$(cat)

# Extract working directory
CWD=$(echo "$INPUT" | jq -r '.cwd // empty')
[ -z "$CWD" ] && exit 0

cd "$CWD" || exit 0

# Check if backup config exists (project has backups enabled)
[ -f .backup-config.sh ] || exit 0

# Trigger backup in background (non-blocking)
./bin/smart-backup-trigger.sh &

exit 0
```

**backup-on-edit.sh** (PostToolUse Edit|Write - file changes):
```bash
#!/usr/bin/env bash
# Trigger backup after Claude edits/writes files
set -euo pipefail

INPUT=$(cat)
CWD=$(echo "$INPUT" | jq -r '.cwd // empty')
[ -z "$CWD" ] && exit 0

cd "$CWD" || exit 0
[ -f .backup-config.sh ] || exit 0

# Log edit event (optional, for debugging)
# FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // empty')
# echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") Edit: $FILE_PATH" >> ~/.claudecode-backups/logs/hook-events.log

# Trigger backup in background
./bin/smart-backup-trigger.sh &

exit 0
```

**backup-on-commit.sh** (PostToolUse Bash(git commit*) - git commits):
```bash
#!/usr/bin/env bash
# Trigger backup after Claude makes a git commit
set -euo pipefail

INPUT=$(cat)
CWD=$(echo "$INPUT" | jq -r '.cwd // empty')
[ -z "$CWD" ] && exit 0

cd "$CWD" || exit 0
[ -f .backup-config.sh ] || exit 0

# Trigger backup in background
./bin/smart-backup-trigger.sh &

exit 0
```

Key constraints:
- Always exit 0 (never block Claude with exit 2)
- Use background execution (& at end)
- Check for .backup-config.sh before triggering (project may not have backups)
- Use jq with fallback (// empty) for safe JSON parsing
- Scripts must be executable (chmod +x)
  </action>
  <verify>
bash -n .claude/hooks/backup-on-stop.sh (syntax check)
bash -n .claude/hooks/backup-on-edit.sh
bash -n .claude/hooks/backup-on-commit.sh
ls -la .claude/hooks/*.sh (shows executable permissions)
  </verify>
  <done>
- Three hook scripts created in .claude/hooks/
- All scripts pass syntax check
- All scripts are executable
- Scripts use jq for JSON parsing
- Scripts trigger smart-backup-trigger.sh in background
  </done>
</task>

<task type="auto">
  <name>Task 2: Create settings.json template with hooks configuration</name>
  <files>templates/claude-settings.json</files>
  <action>
Create templates/claude-settings.json with hook configuration:

```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "./.claude/hooks/backup-on-stop.sh",
            "timeout": 10
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "./.claude/hooks/backup-on-edit.sh",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "Bash(git commit*)",
        "hooks": [
          {
            "type": "command",
            "command": "./.claude/hooks/backup-on-commit.sh",
            "timeout": 10
          }
        ]
      }
    ]
  }
}
```

Key points:
- timeout: 10 (seconds) - short because hooks trigger background processes
- Stop hook has no matcher (fires on all Stop events)
- PostToolUse uses matchers to filter specific tools
- Edit|Write matches both Edit and Write tools
- Bash(git commit*) matches only git commit commands
  </action>
  <verify>
cat templates/claude-settings.json | jq . (validates JSON)
grep -q "backup-on-stop" templates/claude-settings.json && echo "Stop hook configured"
grep -q "Edit|Write" templates/claude-settings.json && echo "Edit hook configured"
  </verify>
  <done>
- templates/claude-settings.json created with valid JSON
- Stop hook configured for backup-on-stop.sh
- PostToolUse hooks configured for Edit|Write and git commit
- Timeout set to 10 seconds
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All three hook scripts exist and pass bash -n
- [ ] All hook scripts are executable (chmod +x)
- [ ] templates/claude-settings.json is valid JSON
- [ ] Hook scripts use jq for JSON parsing
- [ ] Hook scripts trigger smart-backup-trigger.sh in background
- [ ] All scripts exit 0 (non-blocking)
</verification>

<success_criteria>

- Hook scripts created for Stop, Edit/Write, and git commit events
- Settings template created with hook configuration
- All scripts executable and syntax-valid
- Non-blocking execution pattern used
</success_criteria>

<output>
After completion, create `.planning/phases/03-claude-code-integration/03-01-SUMMARY.md`
</output>
