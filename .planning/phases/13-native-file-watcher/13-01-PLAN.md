---
phase: 13-native-file-watcher
plan: 01
type: execute
---

<objective>
Create cross-platform file watcher abstraction and integrate into backup-watcher.sh.

Purpose: Replace the hardcoded fswatch dependency with a platform-aware wrapper supporting fswatch (macOS), inotifywait (Linux), and poll fallback — making backups editor-agnostic and cross-platform.
Output: New lib/platform/file-watcher.sh module, updated backup-watcher.sh using the abstraction, expanded exclude patterns.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research (critical — contains architecture patterns, code examples, pitfalls):
@.planning/phases/13-native-file-watcher/13-RESEARCH.md

# Prior phase summaries (dependency graph):
@.planning/phases/12-bootstrap-deduplication/12-01-SUMMARY.md
@.planning/phases/11-modularize-foundation/11-03-SUMMARY.md

# Key source files:
@bin/backup-watcher.sh
@bin/backup-watch.sh

# Codebase context:
@.planning/codebase/ARCHITECTURE.md

**Tech stack available:** Bash 3.2+, fswatch, inotify-tools, bootstrap.sh pattern
**Established patterns:** Bootstrap pattern (source bootstrap.sh as first init), module loader (lib/backup-lib.sh), include guards
**Constraining decisions:**
- Phase 11: Module loader sources all modules in dependency order from lib/
- Phase 12: Bootstrap pattern — all bin/ scripts use `source "$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"`
- Bash 3.2 compatibility required (no associative arrays, mapfile, coproc, |&, ${var,,})
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/platform/file-watcher.sh</name>
  <files>lib/platform/file-watcher.sh</files>
  <action>
Create new directory `lib/platform/` and file `lib/platform/file-watcher.sh`. This is a standalone module (NOT loaded by backup-lib.sh loader — sourced directly by backup-watcher.sh).

Include guard: `[ -n "${_FILE_WATCHER_LOADED:-}" ] && return || readonly _FILE_WATCHER_LOADED=1`

Functions to implement:

1. `detect_watcher()` — Returns "fswatch", "inotifywait", or "poll":
   - macOS (Darwin): prefer fswatch, fallback to poll
   - Linux: prefer inotifywait, then fswatch, then poll
   - Use `uname -s` and `command -v` (POSIX standard)

2. `_watcher_fswatch(dir, excludes...)` — fswatch backend:
   - Args: `-o -r --latency 1`
   - Build `-e` excludes from array (repeatable flag)
   - Output: one line per batch (count of changes)

3. `_watcher_inotifywait(dir, excludes...)` — inotifywait backend:
   - Events: `close_write,create,delete,move` (NOT modify — fires per write() syscall, see RESEARCH pitfall #2)
   - Single `--exclude` with `|` alternation (inotifywait only accepts ONE --exclude, see RESEARCH pitfall #1)
   - Args: `-m -r -q --format '%w%f'`
   - Output: one line per event (file path)

4. `_build_inotify_exclude(patterns...)` — Combine patterns into single regex:
   - Returns `(pattern1|pattern2|...)` format
   - Handle empty input gracefully

5. `_watcher_poll(dir, excludes...)` — Poll fallback:
   - Uses `find -newer` with marker file
   - POLL_INTERVAL from env (default 30s)
   - Excludes .git and node_modules in find args
   - Outputs "CHANGED" when files modified
   - Cleans up marker file on RETURN trap

6. `start_watcher(dir, excludes...)` — Unified entry point:
   - Calls detect_watcher(), dispatches to backend
   - Streams output to stdout for pipe consumption

7. `check_watcher_available()` — Returns backend name with helpful stderr warning if poll:
   - macOS: suggests `brew install fswatch`
   - Linux: suggests `apt install inotify-tools` / `yum install inotify-tools` / `apk add inotify-tools`

All functions must be Bash 3.2 compatible. No associative arrays, no mapfile, no `${var,,}`.
  </action>
  <verify>
bash -n lib/platform/file-watcher.sh (syntax check passes)
source lib/platform/file-watcher.sh && detect_watcher (returns "fswatch" on macOS)
source lib/platform/file-watcher.sh && _build_inotify_exclude "\.git" "node_modules" "dist/" (returns regex string)
  </verify>
  <done>
lib/platform/file-watcher.sh exists, passes syntax check, detect_watcher returns correct backend for current platform, _build_inotify_exclude produces correct regex, all 7 functions defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate platform wrapper into backup-watcher.sh and expand exclude patterns</name>
  <files>bin/backup-watcher.sh</files>
  <action>
Modify backup-watcher.sh to use the platform abstraction layer:

**A. Source the platform wrapper** (after bootstrap.sh + config load):
```
source "$LIB_DIR/platform/file-watcher.sh"
```

**B. Expand DEFAULT_EXCLUDES array** — Add missing patterns from RESEARCH exclude_improvements section:
- Add: `\.hg`, `\.svn`, `vendor/`, `\.venv`, `venv/`, `bower_components`, `\.idea`, `\.swo$`, `4913`, `\.\#`, `\.terraform`, `\.parcel-cache`, `\.nuxt/`
- Keep ALL existing 14 patterns
- Organize with category comments (Version control, Dependencies, Build output, IDE/Editor, OS metadata, Project-specific, Compiled)

**C. Remove hardcoded fswatch exclude building** — Delete the `FSWATCH_EXCLUDES` loop (L77-87). Custom excludes from WATCHER_EXCLUDES should be appended to DEFAULT_EXCLUDES array instead.

**D. Replace fswatch check and invocation** (L175-195):
- Remove `command -v fswatch` check
- Replace with `check_watcher_available` call
- Log detected backend
- Warn if poll mode

**E. Replace fswatch pipeline** (L186-195):
- Replace `fswatch -o -r "${FSWATCH_EXCLUDES[@]}" "$PROJECT_DIR" | while read -r _count; do` with platform-agnostic:
```bash
start_watcher "$PROJECT_DIR" "${DEFAULT_EXCLUDES[@]}" | while read -r _event; do
    log "File change detected (via $WATCHER_BACKEND)"
    reset_timer
done &
```
- Store PID as WATCHER_PID (rename from FSWATCH_PID)

**F. Update cleanup function** to use WATCHER_PID instead of FSWATCH_PID.

**G. Update log messages** — change "fswatch" references to generic "watcher" or include backend name.

Do NOT modify the debounce logic (reset_timer) — it's correct. Do NOT add session detection yet (that's Plan 02). Do NOT fix the 8 bugs yet (Plan 02).
  </action>
  <verify>
bash -n bin/backup-watcher.sh (syntax check passes)
grep "source.*file-watcher.sh" bin/backup-watcher.sh (platform wrapper sourced)
grep "start_watcher" bin/backup-watcher.sh (using unified interface)
grep "WATCHER_BACKEND\|WATCHER_PID" bin/backup-watcher.sh (renamed from FSWATCH)
grep "\.hg\|\.svn\|vendor/\|\.venv" bin/backup-watcher.sh (new exclude patterns present)
grep -c "fswatch" bin/backup-watcher.sh (should be 0 — no hardcoded fswatch references in main logic)
  </verify>
  <done>
backup-watcher.sh uses platform abstraction via start_watcher, DEFAULT_EXCLUDES expanded with ~13 new patterns, no hardcoded fswatch references in main logic, syntax check passes, WATCHER_PID used consistently
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n lib/platform/file-watcher.sh` passes
- [ ] `bash -n bin/backup-watcher.sh` passes
- [ ] `source lib/platform/file-watcher.sh && detect_watcher` returns expected backend
- [ ] No hardcoded `fswatch` calls remain in backup-watcher.sh main logic
- [ ] DEFAULT_EXCLUDES contains all original + new patterns (~27 patterns)
- [ ] WATCHER_EXCLUDES from config still appended correctly
- [ ] All code is Bash 3.2 compatible (no associative arrays, mapfile, etc.)
</verification>

<success_criteria>

- lib/platform/file-watcher.sh created with all 7 functions
- backup-watcher.sh uses platform wrapper instead of hardcoded fswatch
- DEFAULT_EXCLUDES expanded with ~13 additional patterns
- Both files pass bash -n syntax check
- Bash 3.2 compatible throughout
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-file-watcher/13-01-SUMMARY.md`
</output>
