---
phase: 13-native-file-watcher
plan: 03
type: execute
---

<objective>
Update watcher management CLI for cross-platform support and update config template to remove hooks settings.

Purpose: Ensure backup-watch.sh provides helpful cross-platform guidance and the config template reflects the new watcher-only trigger architecture.
Output: Updated backup-watch.sh with platform-aware messages, updated templates/backup-config.sh without hook settings.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research:
@.planning/phases/13-native-file-watcher/13-RESEARCH.md

# Previous plan summaries:
@.planning/phases/13-native-file-watcher/13-01-SUMMARY.md
@.planning/phases/13-native-file-watcher/13-02-SUMMARY.md

# Key source files:
@bin/backup-watch.sh
@templates/backup-config.sh

**Tech stack available:** Bash 3.2+, platform/file-watcher.sh
**Constraining decisions:**
- RESEARCH config_template_inventory: Remove HOOKS_ENABLED and HOOKS_TRIGGERS, add POLL_INTERVAL
- RESEARCH exclude_improvements: WATCHER_EXCLUDES docs incomplete — update to list all default patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update backup-watch.sh for cross-platform support</name>
  <files>bin/backup-watch.sh</files>
  <action>
**A. Source the platform wrapper** (after bootstrap + config):
```bash
source "$LIB_DIR/platform/file-watcher.sh"
```

**B. Update cmd_start():**
- Replace the hardcoded fswatch check (`command -v fswatch`) with `check_watcher_available` call
- Store returned backend name, display in start message
- Change error message from "Error: fswatch not installed" to platform-aware:
  - macOS: "Install fswatch: brew install fswatch"
  - Linux: "Install inotify-tools: sudo apt install inotify-tools"
  - If poll: show warning but allow start (degraded mode)
- Update success message to show detected backend: "Watcher started for $PROJECT_NAME (PID: $pid, backend: $backend)"

**C. Update cmd_status():**
- Source platform wrapper and show detected backend
- Add backend line: "  Backend: fswatch (native)" or "inotifywait (native)" or "poll (degraded)"
- If poll mode, add warning about efficiency

**D. Update show_usage():**
- Change REQUIREMENTS section from fswatch-only to cross-platform:
```
REQUIREMENTS:
    macOS:  fswatch (brew install fswatch)
    Linux:  inotify-tools (apt install inotify-tools)
    Other:  Falls back to polling if neither available
```
- Update DESCRIPTION to mention cross-platform support
- Add POLL_INTERVAL to CONFIGURATION section:
```
    POLL_INTERVAL=30              # Seconds between polls (fallback only)
```

**E. Keep all existing functionality intact** — start/stop/status/restart logic stays the same. Only messages and checks change.
  </action>
  <verify>
bash -n bin/backup-watch.sh (syntax check passes)
grep "check_watcher_available\|detect_watcher" bin/backup-watch.sh (platform wrapper used)
grep "inotify\|poll" bin/backup-watch.sh (cross-platform references present)
grep "POLL_INTERVAL" bin/backup-watch.sh (documented in help)
  </verify>
  <done>
backup-watch.sh uses platform wrapper for watcher detection, shows platform-aware error messages and install instructions, status shows detected backend, help text is cross-platform, syntax check passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update templates/backup-config.sh — remove hooks, add poll config, update exclude docs</name>
  <files>templates/backup-config.sh</files>
  <action>
**A. Remove CLAUDE CODE HOOKS SETTINGS section** (L240-250):
Delete the entire section:
```bash
# ==============================================================================
# CLAUDE CODE HOOKS SETTINGS
# ==============================================================================
# Enable Claude Code hooks...
HOOKS_ENABLED=false
# Which events trigger backups...
HOOKS_TRIGGERS="stop,edit,commit"
```

**B. Add POLL_INTERVAL to FILE WATCHER SETTINGS section** (after WATCHER_EXCLUDES):
```bash
# Poll interval in seconds (only used when no native file watcher available)
# Native watchers (fswatch, inotifywait) don't use this — they're event-driven
# Default: 30 seconds
# POLL_INTERVAL=30
```

**C. Update WATCHER_EXCLUDES comment** to list ALL default patterns (currently lists only 10 of ~27):
```bash
# Additional paths to exclude from watching (beyond defaults)
# Defaults always excluded:
#   VCS:          .git, .hg, .svn
#   Dependencies: node_modules, vendor/, .venv, venv/, __pycache__, bower_components
#   Build output: dist/, build/, .next/, .nuxt/, .parcel-cache, coverage/
#   IDE/Editor:   .idea, .swp, .swo, 4913, .#
#   OS metadata:  .DS_Store
#   Project:      backups/, .cache, .planning/, .claudecode-backups, .terraform
#   Compiled:     .pyc
# Example: WATCHER_EXCLUDES=("vendor" "tmp" ".terraform")
# WATCHER_EXCLUDES=()
```

**D. Update FILE WATCHER SETTINGS section header comment** to note watcher is the primary trigger:
```bash
# Enable automatic file watching (primary trigger mechanism for backups)
# Uses native file system events (fswatch on macOS, inotifywait on Linux)
# with polling fallback. Triggers backup after quiet period.
WATCHER_ENABLED=false
```

**E. Do NOT modify any other sections** — keep all retention, database, cloud, drive verification settings unchanged.
  </action>
  <verify>
bash -n templates/backup-config.sh (syntax check passes)
grep "HOOKS_ENABLED\|HOOKS_TRIGGERS" templates/backup-config.sh (should return NO matches — hooks removed)
grep "POLL_INTERVAL" templates/backup-config.sh (poll setting present)
grep "\.hg\|\.svn\|vendor/\|\.venv\|inotifywait" templates/backup-config.sh (updated docs present)
  </verify>
  <done>
HOOKS_ENABLED and HOOKS_TRIGGERS removed from config template, POLL_INTERVAL added, WATCHER_EXCLUDES documentation lists all ~27 default patterns, watcher described as primary trigger mechanism, syntax check passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/backup-watch.sh` passes
- [ ] `bash -n templates/backup-config.sh` passes
- [ ] No HOOKS_ENABLED or HOOKS_TRIGGERS in config template
- [ ] POLL_INTERVAL documented in config template
- [ ] backup-watch.sh shows cross-platform install instructions
- [ ] All default exclude patterns documented in config template
</verification>

<success_criteria>

- backup-watch.sh fully cross-platform aware
- Config template reflects watcher-only architecture (no hook references)
- POLL_INTERVAL added as configurable setting
- Exclude pattern documentation complete
- Both files pass syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-file-watcher/13-03-SUMMARY.md`
</output>
