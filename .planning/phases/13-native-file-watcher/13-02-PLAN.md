---
phase: 13-native-file-watcher
plan: 02
type: execute
---

<objective>
Migrate session detection logic from smart-backup-trigger.sh into backup-watcher.sh and fix 8 existing watcher bugs.

Purpose: Make the watcher self-contained with session awareness (replacing the Claude Code hook trigger chain) and fix robustness issues in the long-running daemon process.
Output: backup-watcher.sh with session detection, interval pre-checks, drive verification, and 8 bug fixes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research (critical — trigger migration analysis, robustness bugs):
@.planning/phases/13-native-file-watcher/13-RESEARCH.md

# Previous plan summary:
@.planning/phases/13-native-file-watcher/13-01-SUMMARY.md

# Key source files:
@bin/backup-watcher.sh
@bin/smart-backup-trigger.sh

**Tech stack available:** Bash 3.2+, bootstrap.sh, platform/file-watcher.sh (from Plan 01)
**Established patterns:** Bootstrap, module loader, file-based state (.current-session-time, .last-backup-time)
**Constraining decisions:**
- RESEARCH trigger_migration: Watcher must absorb session detection + interval pre-check + drive verification from smart-backup-trigger.sh
- RESEARCH robustness_bugs: 8 specific bugs identified with fixes
- backup-daemon.sh interval check STAYS as defense-in-depth (don't remove)
- State file .current-session-time transitions from prompt-based to file-change-based tracking
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate session detection and interval logic into backup-watcher.sh</name>
  <files>bin/backup-watcher.sh</files>
  <action>
Add session detection, backup interval pre-check, and drive verification to backup-watcher.sh. This absorbs the logic from smart-backup-trigger.sh (which will be deleted in Plan 04).

**A. Add state variables** (after existing DEFAULTS section):
```bash
# Session detection (migrated from smart-backup-trigger.sh)
SESSION_FILE="$PROJECT_STATE_DIR/.current-session-time"
BACKUP_TIME_STATE="$PROJECT_STATE_DIR/.last-backup-time"
SESSION_IDLE_THRESHOLD="${SESSION_IDLE_THRESHOLD:-600}"
BACKUP_INTERVAL="${BACKUP_INTERVAL:-3600}"
DRIVE_VERIFICATION_ENABLED="${DRIVE_VERIFICATION_ENABLED:-false}"
DRIVE_MARKER_FILE="${DRIVE_MARKER_FILE:-}"
```

**B. Add session detection functions** (new section after DEFAULTS):

`check_new_session()` — Reads SESSION_FILE, compares to SESSION_IDLE_THRESHOLD. Returns 0 if idle > threshold (new session), 1 otherwise.

`should_backup_now()` — Pre-check before calling backup-daemon.sh:
1. Check BACKUP_INTERVAL against .last-backup-time (too soon → return 1)
2. Check DRIVE_VERIFICATION_ENABLED + DRIVE_MARKER_FILE existence (drive missing → return 1)
3. Return 0 if backup should proceed

`update_session_time()` — Writes current timestamp to SESSION_FILE.

**C. Add startup backup check** (in MAIN section, BEFORE starting watcher):
```bash
# Startup: trigger immediate backup if new session
if check_new_session; then
    log "New session detected (idle > ${SESSION_IDLE_THRESHOLD}s)"
    if should_backup_now; then
        log "Triggering startup backup..."
        "$SCRIPT_DIR/backup-daemon.sh" >> "$WATCHER_LOG" 2>&1 &
    else
        log "Startup backup skipped (interval not elapsed or drive unavailable)"
    fi
fi
update_session_time
```

**D. Modify the file change handler** in the main loop:
- Call `update_session_time` on each file change event (tracks user activity)
- The debounce timer's backup execution should check `should_backup_now` before calling backup-daemon.sh (saves process spawn if interval hasn't elapsed)

Modify `reset_timer()` to include the pre-check in the timer subshell:
```bash
# In the timer subshell, before calling backup-daemon.sh:
if should_backup_now; then
    log "Debounce timer expired, triggering backup..."
    "$SCRIPT_DIR/backup-daemon.sh" >> "$WATCHER_LOG" 2>&1 &
else
    log "Debounce timer expired, backup skipped (interval not elapsed or drive unavailable)"
fi
```

**E. Key differences from smart-backup-trigger.sh:**
- Session tracked by file changes (superset of Claude Code prompts) — this is better for editor-agnostic detection
- update_session_time called on file changes AND on startup
- Pre-check is advisory — daemon's own interval check remains as defense-in-depth
  </action>
  <verify>
bash -n bin/backup-watcher.sh (syntax check passes)
grep "check_new_session\|should_backup_now\|update_session_time" bin/backup-watcher.sh (all 3 functions present)
grep "SESSION_FILE\|BACKUP_TIME_STATE\|SESSION_IDLE_THRESHOLD" bin/backup-watcher.sh (state variables defined)
grep "Triggering startup backup\|New session detected" bin/backup-watcher.sh (startup logic present)
  </verify>
  <done>
backup-watcher.sh has check_new_session, should_backup_now, update_session_time functions; triggers startup backup on new session; updates session time on file changes; pre-checks interval before daemon calls; syntax check passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix 8 robustness bugs in backup-watcher.sh</name>
  <files>bin/backup-watcher.sh</files>
  <action>
Apply all 8 fixes from RESEARCH robustness_bugs section:

**Bug 1: Pipeline PID capture** — The `fswatch ... | while read` pipeline (now `start_watcher ... | while read`) captures subshell PID, not the watcher PID. Fix: Use process substitution instead:
```bash
while read -r _event; do
    update_session_time
    log "File change detected (via $WATCHER_BACKEND)"
    reset_timer
done < <(start_watcher "$PROJECT_DIR" "${DEFAULT_EXCLUDES[@]}")
```
This way the watcher runs in the current process group and gets killed by cleanup. Remove the explicit WATCHER_PID tracking and `wait` since the while loop blocks directly.

**Bug 2: Timer subshell inherits pipe FDs** — Close inherited FDs in the timer subshell:
```bash
(
    exec 0<&- 1>/dev/null  # close stdin, redirect stdout
    sleep "$DEBOUNCE_SECONDS"
    ...
) &
```
Note: log function writes to file so it still works after stdout redirect. The backup-daemon.sh output redirects to WATCHER_LOG explicitly.

**Bug 3: No SIGHUP trap** — Add SIGHUP to trap:
```bash
trap cleanup SIGTERM SIGINT SIGHUP EXIT
```

**Bug 4: Double cleanup on SIGTERM** — Add guard variable:
```bash
CLEANUP_DONE=false
cleanup() {
    [ "$CLEANUP_DONE" = true ] && return
    CLEANUP_DONE=true
    log "Watcher shutting down..."
    # ... existing cleanup ...
    # Remove exit 0 at end — let EXIT trap handle it, but guard prevents double run
}
```

**Bug 5: No log rotation** — Add at startup, before first log message:
```bash
MAX_LOG_SIZE="${MAX_LOG_SIZE:-1048576}"  # 1MB default
if [ -f "$WATCHER_LOG" ] && [ "$(wc -c < "$WATCHER_LOG" 2>/dev/null || echo 0)" -gt "$MAX_LOG_SIZE" ]; then
    mv "$WATCHER_LOG" "${WATCHER_LOG}.old"
fi
```

**Bug 6: No health check for deleted project dir** — Add periodic check. Since the main loop blocks on reading watcher output, add the check inside the event handler:
```bash
# In the while read loop, check periodically (every event is fine — events stop if dir deleted)
if [ ! -d "$PROJECT_DIR" ]; then
    log "ERROR: Project directory no longer exists: $PROJECT_DIR"
    break  # exits while loop, cleanup runs via trap
fi
```

**Bug 7: PID reuse in is_watcher_running** — This function is in backup-watch.sh (not backup-watcher.sh). Add process name verification:
```bash
# In backup-watch.sh is_watcher_running():
if kill -0 "$pid" 2>/dev/null && ps -p "$pid" -o command= 2>/dev/null | grep -q "backup-watcher"; then
    return 0
fi
```

**Bug 8: Timer subshell error handling** — Add error check in timer subshell:
```bash
if ! "$SCRIPT_DIR/backup-daemon.sh" >> "$WATCHER_LOG" 2>&1; then
    log "ERROR: backup-daemon.sh failed with exit code $?"
fi
```
(This combines with the should_backup_now pre-check from Task 1)
  </action>
  <verify>
bash -n bin/backup-watcher.sh (syntax check passes)
bash -n bin/backup-watch.sh (syntax check passes)
grep "SIGHUP" bin/backup-watcher.sh (bug 3 fixed)
grep "CLEANUP_DONE" bin/backup-watcher.sh (bug 4 fixed)
grep "MAX_LOG_SIZE" bin/backup-watcher.sh (bug 5 fixed)
grep "exec 0<&-" bin/backup-watcher.sh (bug 2 fixed)
grep "process substitution or 'done < <'" bin/backup-watcher.sh || grep "< <(start_watcher" bin/backup-watcher.sh (bug 1 fixed)
grep "backup-watcher" bin/backup-watch.sh (bug 7 - PID verification)
grep "failed with exit code" bin/backup-watcher.sh (bug 8 fixed)
  </verify>
  <done>
All 8 bugs fixed: (1) process substitution replaces pipeline, (2) FDs closed in timer subshell, (3) SIGHUP trapped, (4) double cleanup guarded, (5) log rotation on startup, (6) project dir health check, (7) PID reuse detection in backup-watch.sh, (8) timer subshell error handling. Both files pass bash -n.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/backup-watcher.sh` passes
- [ ] `bash -n bin/backup-watch.sh` passes
- [ ] Session detection functions present and functional
- [ ] Startup backup triggers on new session
- [ ] All 8 bugs addressed
- [ ] No Bash 3.2 incompatible syntax introduced
- [ ] backup-daemon.sh interval check NOT removed (defense-in-depth preserved)
</verification>

<success_criteria>

- Session detection migrated from smart-backup-trigger.sh
- Interval pre-check prevents unnecessary daemon spawns
- All 8 robustness bugs fixed
- Both scripts pass bash -n syntax check
- Bash 3.2 compatible
</success_criteria>

<output>
After completion, create `.planning/phases/13-native-file-watcher/13-02-SUMMARY.md`
</output>
