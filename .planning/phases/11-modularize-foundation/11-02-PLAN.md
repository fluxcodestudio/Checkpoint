---
phase: 11-modularize-foundation
plan: 02
type: execute
---

<objective>
Extract UI utility and feature modules from backup-lib.sh into focused files under lib/ui/ and lib/features/.

Purpose: Complete the module extraction by pulling out the UI utilities (formatting, time/size helpers) and all feature-specific code (discovery, restore, cleanup, malware, health, change detection, cloud destinations, GitHub auth). After this plan, all code from backup-lib.sh exists as standalone modules.
Output: 10 new module files in lib/ui/ and lib/features/, each with include guards and proper headers. backup-lib.sh still remains unchanged.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-modularize-foundation/11-RESEARCH.md
@.planning/phases/11-modularize-foundation/11-01-SUMMARY.md
@lib/backup-lib.sh

**Tech stack available:** Pure bash, no new dependencies
**Established patterns:** Include guards, module headers (established in plan 11-01)
**Constraining decisions:**
- Same guard pattern as plan 11-01: `[ -n "$_CHECKPOINT_*" ] && return || readonly _CHECKPOINT_*=1`
- Same dir detection: `_CHECKPOINT_LIB_DIR="${_CHECKPOINT_LIB_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"`
- Copy code exactly — no refactoring
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/ui/ modules and lib/features/ first batch (6 files)</name>
  <files>lib/ui/formatting.sh, lib/ui/time-size-utils.sh, lib/features/backup-discovery.sh, lib/features/restore.sh, lib/features/cleanup.sh, lib/features/malware.sh</files>
  <action>
Create `lib/ui/` and `lib/features/` directories. Extract 6 modules:

**lib/ui/formatting.sh** (~85 lines):
- Extract: INTERACTIVE UI COMPONENTS section (lines ~1675-1758)
- Contains: BOX_* character variables, draw_box(), draw_border(), prompt_input(), confirm_yes_no()
- Dependencies: `@requires: core/output (for COLOR_* constants)`
- Guard: `_CHECKPOINT_FORMATTING`

**lib/ui/time-size-utils.sh** (~200 lines):
- Extract: TIME UTILITIES section (lines ~1166-1231) + SIZE UTILITIES section (lines ~1232-1271) + DATE/TIME PARSING section (lines ~1759-1846)
- Contains: format_time_ago(), format_duration(), time_until_next_backup(), format_bytes(), get_dir_size_bytes(), parse_human_date(), format_relative_time()
- Dependencies: `@requires: none`
- Guard: `_CHECKPOINT_TIME_SIZE_UTILS`

**lib/features/backup-discovery.sh** (~60 lines):
- Extract: BACKUP DISCOVERY & LISTING section (lines ~1847-1907)
- Contains: list_database_backups_sorted(), list_file_versions_sorted()
- Dependencies: `@requires: none`
- Guard: `_CHECKPOINT_BACKUP_DISCOVERY`

**lib/features/restore.sh** (~160 lines):
- Extract: RESTORE OPERATIONS section (lines ~1908-2065)
- Contains: create_safety_backup(), verify_sqlite_integrity(), verify_compressed_backup(), restore_database_backup(), restore_file_from_backup()
- Dependencies: `@requires: core/output (for color functions, backup_log), ui/time-size-utils (for format_bytes)`
- Guard: `_CHECKPOINT_RESTORE`

**lib/features/cleanup.sh** (~310 lines):
- Extract: CLEANUP OPERATIONS section (lines ~2066-2182) + SINGLE-PASS CLEANUP section (lines ~2183-2298) + CLEANUP RECOMMENDATIONS section (lines ~2299-2349) + AUDIT LOGGING section (lines ~2350-2375)
- Contains: find_expired_backups(), find_duplicate_backups(), find_orphaned_archives(), calculate_file_list_size(), delete_files_with_summary(), cleanup_single_pass(), cleanup_execute(), generate_cleanup_recommendations(), log_restore_operation(), log_cleanup_operation()
- Dependencies: `@requires: core/output (for color functions), ops/file-ops (for get_file_hash)`
- Guard: `_CHECKPOINT_CLEANUP`
- NOTE: This module declares global arrays (CLEANUP_EXPIRED, CLEANUP_DUPLICATES, CLEANUP_ORPHANED, CLEANUP_EXPIRED_SIZE, CLEANUP_DUPLICATES_SIZE, CLEANUP_ORPHANED_SIZE). These array declarations should remain in this module.

**lib/features/malware.sh** (~125 lines):
- Extract: MALWARE DETECTION section (lines ~835-957)
- Contains: scan_file_for_malware(), scan_backup_for_malware(), display_malware_report()
- Dependencies: `@requires: core/output (for color functions)`
- Guard: `_CHECKPOINT_MALWARE`
- NOTE: Sets MALWARE_REASON and SUSPICIOUS_FILES globals. Document in @provides.

Same extraction rules as plan 11-01: Copy code exactly. Add module headers with include guard, @requires, @provides.
  </action>
  <verify>
For each module file:
1. `bash -n lib/ui/formatting.sh` — syntax check passes
2. `bash -n lib/ui/time-size-utils.sh` — syntax check passes
3. `bash -n lib/features/backup-discovery.sh` — syntax check passes
4. `bash -n lib/features/restore.sh` — syntax check passes
5. `bash -n lib/features/cleanup.sh` — syntax check passes
6. `bash -n lib/features/malware.sh` — syntax check passes
  </verify>
  <done>
6 files created (2 in lib/ui/, 4 in lib/features/). All pass `bash -n` syntax check. Include guards and headers present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create remaining lib/features/ modules (4 files)</name>
  <files>lib/features/health-stats.sh, lib/features/change-detection.sh, lib/features/cloud-destinations.sh, lib/features/github-auth.sh</files>
  <action>
Extract final 4 modules from backup-lib.sh:

**lib/features/health-stats.sh** (~140 lines):
- Extract: COMPONENT HEALTH CHECKS section (lines ~1372-1421) + STATISTICS GATHERING section (lines ~1422-1470) + RETENTION POLICY ANALYSIS section (lines ~1471-1510)
- Contains: check_daemon_running(), check_hooks_installed(), check_config_valid(), count_database_backups(), count_current_files(), count_archived_files(), get_total_backup_size(), get_last_backup_time(), count_expiring_soon(), days_until_next_prune()
- Dependencies: `@requires: core/config (for BACKUP_DIR, check_drive)`
- Guard: `_CHECKPOINT_HEALTH_STATS`

**lib/features/change-detection.sh** (~75 lines):
- Extract: FAST CHANGE DETECTION section (lines ~3144-3215)
- Contains: has_changes(), get_changed_files_fast()
- Dependencies: `@requires: none`
- Guard: `_CHECKPOINT_CHANGE_DETECTION`

**lib/features/cloud-destinations.sh** (~240 lines):
- Extract: CLOUD FOLDER DESTINATION RESOLUTION section (lines ~2908-3143)
- Contains: _ensure_cloud_detector_loaded(), check_cloud_folder_health(), _ensure_cloud_backup_loaded(), resolve_backup_destinations(), ensure_backup_dirs()
- Dependencies: `@requires: core/output (for color functions, backup_log), core/config (for load_backup_config)`
- Guard: `_CHECKPOINT_CLOUD_DESTINATIONS`
- NOTE: This module uses lazy-loading for cloud-folder-detector.sh and cloud-backup.sh via _ensure_*_loaded() functions. These reference `$LIB_DIR` (set by bin/ scripts) and `${_CHECKPOINT_LIB_DIR}` as fallback. Keep both references intact.

**lib/features/github-auth.sh** (~95 lines):
- Extract: GITHUB AUTHENTICATION HELPERS section (lines ~2815-2907)
- Contains: check_github_auth(), setup_github_auth(), get_github_push_status()
- Dependencies: `@requires: core/output (for color functions)`
- Guard: `_CHECKPOINT_GITHUB_AUTH`

Same extraction rules: Copy code exactly. Add module headers.
  </action>
  <verify>
For each module file:
1. `bash -n lib/features/health-stats.sh` — syntax check passes
2. `bash -n lib/features/change-detection.sh` — syntax check passes
3. `bash -n lib/features/cloud-destinations.sh` — syntax check passes
4. `bash -n lib/features/github-auth.sh` — syntax check passes
  </verify>
  <done>
4 files created in lib/features/. All pass `bash -n` syntax check. Include guards and headers present. All 16 modules now exist across lib/core/, lib/ops/, lib/ui/, lib/features/.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `lib/ui/` directory exists with 2 files
- [ ] `lib/features/` directory exists with 8 files
- [ ] All 10 files pass `bash -n` syntax check
- [ ] All 10 files have include guard as first executable line
- [ ] All 10 files have @requires/@provides documentation
- [ ] backup-lib.sh is UNCHANGED
- [ ] Total module count across all 4 directories: 16 files (3 core + 3 ops + 2 ui + 8 features)
</verification>

<success_criteria>

- 10 module files created (2 ui, 8 features)
- All pass syntax validation
- All have proper include guards and headers
- backup-lib.sh unchanged
- Combined with plan 11-01 output: all 16 modules exist
</success_criteria>

<output>
After completion, create `.planning/phases/11-modularize-foundation/11-02-SUMMARY.md`
</output>
