---
phase: 11-modularize-foundation
plan: 03
type: execute
---

<objective>
Replace backup-lib.sh monolith with thin loader that sources all 16 modules, then verify the entire system works.

Purpose: This is the critical cutover — the 3,216-line monolith becomes a ~50-line loader. All 31 bin/ scripts and the test suite must work identically after this change. This plan also adds ShellCheck configuration for the new module structure.
Output: backup-lib.sh transformed into thin loader, .shellcheckrc created, full test suite passing, all bin/ scripts verified.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-modularize-foundation/11-RESEARCH.md
@.planning/phases/11-modularize-foundation/11-01-SUMMARY.md
@.planning/phases/11-modularize-foundation/11-02-SUMMARY.md
@lib/backup-lib.sh
@lib/core/error-codes.sh
@lib/core/output.sh
@lib/core/config.sh
@lib/ops/file-ops.sh
@lib/ops/state.sh
@lib/ops/init.sh
@lib/ui/formatting.sh
@lib/ui/time-size-utils.sh
@lib/features/backup-discovery.sh
@lib/features/restore.sh
@lib/features/cleanup.sh
@lib/features/malware.sh
@lib/features/health-stats.sh
@lib/features/change-detection.sh
@lib/features/cloud-destinations.sh
@lib/features/github-auth.sh

**Tech stack available:** Pure bash, no new dependencies
**Established patterns:** Include guards on all 16 modules (plans 11-01 and 11-02)
**Constraining decisions:**
- backup-lib.sh MUST remain at the same path — all bin/ scripts source it unchanged
- BACKUP_LIB_LOADED=1 must still be exported (backward compatibility marker)
- `set -euo pipefail` stays in the loader
- Source order: core (no deps) → ops (depend on core) → ui → features (depend on core + ops)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace backup-lib.sh with thin loader and add .shellcheckrc</name>
  <files>lib/backup-lib.sh, .shellcheckrc</files>
  <action>
**Step 1: Archive the original monolith.**
Copy `lib/backup-lib.sh` to `lib/archive/backup-lib-monolith.sh` as a reference backup. This goes in the existing `lib/archive/` directory.

**Step 2: Replace lib/backup-lib.sh with the thin loader.**
The new backup-lib.sh should be approximately:

```bash
#!/usr/bin/env bash
# ==============================================================================
# Checkpoint - Core Library (Module Loader)
# ==============================================================================
# Version: 3.0.0
# Description: Thin loader that sources all Checkpoint library modules in
#              dependency order. Consumers source this single file to get
#              the full library — no changes needed to existing bin/ scripts.
#
# Usage:
#   source "$LIB_DIR/backup-lib.sh"
#
# Module structure:
#   core/     - Error codes, output/color, config management (no dependencies)
#   ops/      - File operations, state tracking, initialization (depend on core)
#   ui/       - Formatting, time/size utilities
#   features/ - Discovery, restore, cleanup, malware, health, detection, cloud, git
# ==============================================================================

# Include guard
[ -n "$_CHECKPOINT_LIB" ] && return || readonly _CHECKPOINT_LIB=1

set -euo pipefail

_CHECKPOINT_LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# === Core (no dependencies) ===
source "$_CHECKPOINT_LIB_DIR/core/error-codes.sh"
source "$_CHECKPOINT_LIB_DIR/core/output.sh"
source "$_CHECKPOINT_LIB_DIR/core/config.sh"

# === Operations (depend on core) ===
source "$_CHECKPOINT_LIB_DIR/ops/file-ops.sh"
source "$_CHECKPOINT_LIB_DIR/ops/state.sh"
source "$_CHECKPOINT_LIB_DIR/ops/init.sh"

# === UI utilities ===
source "$_CHECKPOINT_LIB_DIR/ui/formatting.sh"
source "$_CHECKPOINT_LIB_DIR/ui/time-size-utils.sh"

# === Features (depend on core + ops) ===
source "$_CHECKPOINT_LIB_DIR/features/backup-discovery.sh"
source "$_CHECKPOINT_LIB_DIR/features/restore.sh"
source "$_CHECKPOINT_LIB_DIR/features/cleanup.sh"
source "$_CHECKPOINT_LIB_DIR/features/malware.sh"
source "$_CHECKPOINT_LIB_DIR/features/health-stats.sh"
source "$_CHECKPOINT_LIB_DIR/features/change-detection.sh"
source "$_CHECKPOINT_LIB_DIR/features/cloud-destinations.sh"
source "$_CHECKPOINT_LIB_DIR/features/github-auth.sh"

# Backward compatibility marker
export BACKUP_LIB_LOADED=1
```

**CRITICAL checks before writing:**
- Verify EVERY function from the original backup-lib.sh exists in exactly one module
- Verify EVERY global variable declaration exists in exactly one module
- The source order must satisfy all @requires dependencies (core before ops, ops before features)
- Do NOT include `# shellcheck source=` directives in the loader itself — that's what .shellcheckrc handles

**Step 3: Create .shellcheckrc at project root.**
```
# ShellCheck configuration for modular library structure
external-sources=true
source-path=lib/
```

This tells ShellCheck to resolve `source "$_CHECKPOINT_LIB_DIR/core/config.sh"` paths relative to `lib/`, suppressing SC1090/SC1091 warnings.
  </action>
  <verify>
1. `bash -n lib/backup-lib.sh` — new loader passes syntax check
2. `wc -l lib/backup-lib.sh` — should be ~50 lines (not 3,216)
3. `[ -f lib/archive/backup-lib-monolith.sh ]` — archive exists
4. `wc -l lib/archive/backup-lib-monolith.sh` — archive is 3,216 lines
5. `[ -f .shellcheckrc ]` — ShellCheck config exists
6. Quick smoke test: `bash -c 'source lib/backup-lib.sh && echo "BACKUP_LIB_LOADED=$BACKUP_LIB_LOADED"'` — should print `BACKUP_LIB_LOADED=1`
  </verify>
  <done>
backup-lib.sh replaced with thin loader (~50 lines). Original archived at lib/archive/backup-lib-monolith.sh. .shellcheckrc created. Loader sources all 16 modules and exports BACKUP_LIB_LOADED=1. Smoke test passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify all bin/ scripts work</name>
  <files>lib/backup-lib.sh (fix issues if found), lib/core/*.sh, lib/ops/*.sh, lib/ui/*.sh, lib/features/*.sh</files>
  <action>
**Step 1: Run the smoke test.**
```bash
bash tests/smoke-test.sh
```
Fix any failures before proceeding.

**Step 2: Run the full test suite.**
```bash
bash tests/run-all-tests.sh
```
This runs 290+ tests across unit, integration, e2e, compatibility, and stress tests. ALL must pass. If tests fail:
- Read the error output carefully
- Common issues: missing function (wrong section boundary in extraction), missing global variable (not included in module), source order bug (module depends on something not yet loaded)
- Fix the specific module file, NOT backup-lib.sh (the loader should stay minimal)
- Re-run the failing test to confirm fix
- Re-run full suite to confirm no regressions

**Step 3: Verify critical bin/ scripts can source the library.**
Test the most important entry points:
```bash
bash -c 'source lib/backup-lib.sh && type load_backup_config && type acquire_backup_lock && type send_notification && type format_time_ago && type cleanup_single_pass && type check_github_auth && echo "All critical functions available"'
```
This verifies functions from each module layer are accessible.

**Step 4: Verify no function was lost.**
Extract all function names from the archived monolith and check they exist in the new module files:
```bash
grep -E '^[a-z_]+\(\)' lib/archive/backup-lib-monolith.sh | sed 's/().*//' | sort > /tmp/old_functions.txt
grep -rE '^[a-z_]+\(\)' lib/core/ lib/ops/ lib/ui/ lib/features/ | sed 's/.*://; s/().*//' | sort > /tmp/new_functions.txt
diff /tmp/old_functions.txt /tmp/new_functions.txt
```
The diff should be empty (all functions accounted for). If any are missing, add them to the appropriate module.

**Step 5: If any fixes were needed, re-run full test suite one final time** to confirm clean pass.
  </action>
  <verify>
1. `bash tests/smoke-test.sh` — passes
2. `bash tests/run-all-tests.sh` — all 290+ tests pass
3. Function coverage check — no functions lost in extraction
4. Critical entry points verified — all key functions available via loader
  </verify>
  <done>
Full test suite passes (290+ tests). All functions from original backup-lib.sh present in module files. All bin/ scripts can source the modular library. Phase 11 complete.
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bash tests/smoke-test.sh` passes
- [ ] `bash tests/run-all-tests.sh` — all tests pass
- [ ] backup-lib.sh is thin loader (~50 lines)
- [ ] Original archived at lib/archive/backup-lib-monolith.sh
- [ ] .shellcheckrc exists at project root
- [ ] No functions lost (diff check)
- [ ] BACKUP_LIB_LOADED=1 still exported
</verification>

<success_criteria>

- All tasks completed
- All 290+ tests pass
- backup-lib.sh is a thin loader sourcing 16 modules
- Zero bin/ script changes needed (backward compatible)
- Original monolith archived for reference
- .shellcheckrc configured for modular structure
- Phase 11 complete
</success_criteria>

<output>
After completion, create `.planning/phases/11-modularize-foundation/11-03-SUMMARY.md`:

# Phase 11 Plan 03: Cutover & Verification Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `lib/backup-lib.sh` - Thin loader replacing 3,216-line monolith
- `lib/archive/backup-lib-monolith.sh` - Archived original
- `.shellcheckrc` - ShellCheck config for modular structure

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 11 complete, ready for Phase 12: Bootstrap Deduplication
</output>
