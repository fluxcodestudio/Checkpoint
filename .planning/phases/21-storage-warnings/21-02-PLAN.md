---
phase: 21-storage-warnings
plan: 02
type: execute
---

<objective>
Integrate storage monitoring into backup pipeline and status display.

Purpose: Wire the storage monitoring library into the actual backup flow (pre-backup gate check in daemon and backup-now) and surface storage information in the checkpoint command center status display.
Output: Pre-backup disk checks active in backup pipeline, storage info visible in `checkpoint --status`.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-storage-warnings/21-RESEARCH.md
@.planning/phases/21-storage-warnings/21-01-SUMMARY.md

# Key files to modify:
@bin/backup-now.sh
@bin/backup-daemon.sh
@bin/checkpoint-watchdog.sh
@bin/checkpoint.sh
@lib/features/storage-monitor.sh

# Key files for reference:
@lib/ops/file-ops.sh
@lib/core/config.sh
@lib/features/scheduling.sh

**Tech stack available:** Pure bash, storage-monitor.sh library (from 21-01)
**Established patterns:** Source libraries with conditional guards, log_info/log_warning/log_error, notification cooldown
**Constraining decisions:**
- Phase 21-01: storage-monitor.sh provides pre_backup_storage_check() returning 0/1/2
- Warning (return 1) = notify + continue backup
- Critical (return 2) = notify + skip backup
- Caching prevents du performance overhead
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate pre-backup storage check into backup pipeline</name>
  <files>bin/backup-now.sh, bin/backup-daemon.sh, bin/checkpoint-watchdog.sh</files>
  <action>
Wire `pre_backup_storage_check()` into the backup pipeline at the right points:

**bin/backup-now.sh:**
- Source `lib/features/storage-monitor.sh` near the top where other libraries are sourced
- Call `pre_backup_storage_check "$BACKUP_DIR"` AFTER config loading and drive verification but BEFORE the actual backup work begins (before change detection / rsync). Find the pre-flight check section and add it there.
- If return code is 2 (critical): log error "Backup skipped: disk critically full" and exit with appropriate error code. Use existing error code pattern.
- If return code is 1 (warning): log warning but continue with backup normally.
- If `STORAGE_CHECK_ENABLED` is false, the function returns 0 immediately so no special handling needed.

**bin/backup-daemon.sh:**
- Source `lib/features/storage-monitor.sh`
- In the backup loop, call `pre_backup_storage_check "$BACKUP_DIR"` before triggering backup for each project. If critical, skip this cycle (log + continue loop). If warning, proceed with backup.

**bin/checkpoint-watchdog.sh:**
- Source `lib/features/storage-monitor.sh`
- In the per-project backup cycle, add the same pre-backup check before running the backup. Follow same pattern as backup-daemon.sh.

AVOID: Adding the check AFTER backup starts — it must gate the backup. AVOID: Exiting the daemon on critical — just skip that cycle and retry next time. AVOID: Double-sourcing — use include guard checks.
  </action>
  <verify>
`bash -n bin/backup-now.sh && bash -n bin/backup-daemon.sh && bash -n bin/checkpoint-watchdog.sh` — all syntax checks pass.
Grep for `pre_backup_storage_check` in all 3 files to confirm presence.
Grep for `storage-monitor.sh` source line in all 3 files.
  </verify>
  <done>
Pre-backup storage check called in backup-now.sh, backup-daemon.sh, and checkpoint-watchdog.sh. Critical threshold blocks backup (with log). Warning threshold logs but continues. Syntax valid in all files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add storage information to checkpoint status display</name>
  <files>bin/checkpoint.sh</files>
  <action>
Add a "Storage" section to the `checkpoint --status` display in `bin/checkpoint.sh`:

1. Source `lib/features/storage-monitor.sh` at the top (after existing library sources).

2. In the status display section (find where backup health / schedule info is shown), add a storage block:
   - Show volume stats: "Backup Volume: XX% used (YY.Z GB free of WW.Z GB)" using `get_volume_stats()` and `format_bytes()`
   - Color-code: green if under warning threshold, yellow if between warning and critical, red if above critical
   - If above warning: show cleanup suggestions inline using `suggest_cleanup()` output
   - Show per-project storage breakdown (top 5 by size) using `get_per_project_storage()`: "  ProjectName: XX.X MB"

3. Use existing color functions (color_green, color_yellow, color_red) for threshold-based coloring.

4. Keep display compact — this is additional info in the existing status view, not a separate screen.

AVOID: Making this the default view — only show per-project breakdown and cleanup suggestions when above warning threshold or when verbose mode is on. AVOID: Running du synchronously — use the cached per-project data from storage-monitor.sh.
  </action>
  <verify>
`bash -n bin/checkpoint.sh` — syntax check passes.
Run `checkpoint --status 2>/dev/null | head -50` to visually verify storage section appears (may not show in all environments).
  </verify>
  <done>
Checkpoint status display includes storage section with volume usage, threshold-based color coding, per-project breakdown (shown when above warning or in verbose), and cleanup suggestions when space is low. Phase 21 complete.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/backup-now.sh` passes
- [ ] `bash -n bin/backup-daemon.sh` passes
- [ ] `bash -n bin/checkpoint-watchdog.sh` passes
- [ ] `bash -n bin/checkpoint.sh` passes
- [ ] pre_backup_storage_check called before backup in all 3 pipeline files
- [ ] Storage section visible in checkpoint --status output
- [ ] No regressions — existing backup functionality unaffected
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No syntax errors introduced
- Pre-backup disk check gates backup pipeline (warning=continue, critical=skip)
- Storage info displayed in checkpoint status
- Phase 21 complete
</success_criteria>

<output>
After completion, create `.planning/phases/21-storage-warnings/21-02-SUMMARY.md`
</output>
