---
phase: 21-storage-warnings
plan: 01
type: execute
---

<objective>
Create storage monitoring library and wire config variables for disk space warnings.

Purpose: Provide reusable storage monitoring functions (pre-backup check, per-project breakdown, cleanup suggestions) and configurable thresholds that replace the current hardcoded 80/90% values.
Output: New `lib/features/storage-monitor.sh` library and STORAGE_* config variables wired across all config layers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-storage-warnings/21-RESEARCH.md

# Key files from prior phases:
@lib/ops/file-ops.sh
@lib/core/config.sh
@lib/features/health-stats.sh
@lib/ui/time-size-utils.sh
@lib/platform/compat.sh
@templates/backup-config.sh
@templates/backup-config.yaml
@templates/global-config-template.sh
@bin/backup-config.sh

# Prior phase summaries:
@.planning/phases/20-cron-style-scheduling/20-02-SUMMARY.md

**Tech stack available:** Pure bash, shell built-ins (df -P, du -s, awk)
**Established patterns:** `: "${VAR:=default}"` config defaults, config_key_to_var/config_var_to_key mappings, include guards, `@provides` headers
**Constraining decisions:**
- Phase 20: BACKUP_SCHEDULE config wiring pattern established (follow same pattern for STORAGE_* vars)
- Use `df -Pk` for POSIX-compliant cross-platform disk space
- Use existing `get_backup_disk_usage()`, `format_bytes()`, `get_dir_size_bytes()`, `send_notification()` — do NOT hand-roll replacements
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage monitoring library</name>
  <files>lib/features/storage-monitor.sh</files>
  <action>
Create `lib/features/storage-monitor.sh` with include guard and `@provides` header following existing library patterns.

Functions to implement:

1. `pre_backup_storage_check()` — Takes backup_dir as arg. Calls existing `get_backup_disk_usage()` from file-ops.sh. Compares against `STORAGE_CRITICAL_PERCENT` and `STORAGE_WARNING_PERCENT` thresholds. Returns 0 (ok), 1 (warning — log + notify but allow backup), 2 (critical — log + notify + block backup). Uses existing `send_notification()` for alerts. Implements notification cooldown using a state file at `~/.checkpoint/storage-alert-last` to prevent spam (re-notify only after NOTIFY_ESCALATION_HOURS). When `STORAGE_CHECK_ENABLED` is false, return 0 immediately.

2. `get_volume_stats()` — Takes a path, returns `total_kb|used_kb|avail_kb|pct_used` using `df -Pk`. Single awk parse (not multiple calls). Used by status display.

3. `get_per_project_storage()` — Takes backup base dir. Uses `list_projects()` from projects-registry.sh to get registered projects. For each, calculates backup dir size using existing `get_dir_size_bytes()`. Outputs `size_bytes|project_name` lines sorted by size descending. Cache results in `~/.checkpoint/storage-cache` file with 1-hour TTL (check mtime via existing `stat_mtime()`). If cache is fresh, return cached data.

4. `suggest_cleanup()` — Takes backup_dir. Counts archived files older than 30 days. Shows top 5 largest project backups (using cached per-project data). Suggests `checkpoint cleanup --dry-run`. Only displays if `STORAGE_CLEANUP_SUGGEST` is true. Output is formatted text lines suitable for display in status.

Source `file-ops.sh` for `get_backup_disk_usage()`, `time-size-utils.sh` for `format_bytes()`/`get_dir_size_bytes()`, `compat.sh` for `send_notification()`/`stat_mtime()`. Use conditional sourcing with `[ -n "${_CHECKPOINT_*:-}" ]` checks to avoid double-loading.

AVOID: Running `du` on every backup cycle — use the caching pattern. AVOID: Platform-specific df parsing without -P flag. AVOID: Blocking backup on warning level (only block on critical).
  </action>
  <verify>
`bash -n lib/features/storage-monitor.sh` — syntax check passes.
Source the file and verify functions are defined: `source lib/features/storage-monitor.sh && type pre_backup_storage_check && type get_volume_stats && type get_per_project_storage && type suggest_cleanup`
  </verify>
  <done>
All 4 functions defined and syntax-valid. Include guard present. Uses existing infrastructure (no hand-rolled replacements). Caching implemented for per-project sizes. Notification cooldown prevents spam.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire STORAGE_* config variables across all config layers</name>
  <files>lib/core/config.sh, templates/backup-config.sh, templates/backup-config.yaml, templates/global-config-template.sh, bin/backup-config.sh</files>
  <action>
Wire 4 new config variables following the exact pattern used for BACKUP_SCHEDULE and BACKUP_AI_ARTIFACTS:

Variables:
- `STORAGE_WARNING_PERCENT` (integer, 1-99, default 80) — Warn when disk usage exceeds this %
- `STORAGE_CRITICAL_PERCENT` (integer, 1-99, default 90) — Block backup when disk usage exceeds this %
- `STORAGE_CHECK_ENABLED` (boolean, default true) — Enable/disable pre-backup disk checks
- `STORAGE_CLEANUP_SUGGEST` (boolean, default true) — Show cleanup suggestions when space is low

Changes per file:

**lib/core/config.sh:**
- Add defaults in alert configuration section (after NOTIFY_SOUND line ~156): `: "${STORAGE_WARNING_PERCENT:=80}"`, `: "${STORAGE_CRITICAL_PERCENT:=90}"`, `: "${STORAGE_CHECK_ENABLED:=true}"`, `: "${STORAGE_CLEANUP_SUGGEST:=true}"`
- Add to `config_key_to_var()`: `"storage.warning_percent"` → `STORAGE_WARNING_PERCENT`, `"storage.critical_percent"` → `STORAGE_CRITICAL_PERCENT`, `"storage.check_enabled"` → `STORAGE_CHECK_ENABLED`, `"storage.cleanup_suggest"` → `STORAGE_CLEANUP_SUGGEST`
- Add to `config_var_to_key()`: reverse mappings
- Add to `apply_global_defaults()`: `DEFAULT_STORAGE_WARNING_PERCENT` → `STORAGE_WARNING_PERCENT`, etc.

**templates/backup-config.sh:**
- Add storage section after the AI artifacts section with commented explanations

**templates/backup-config.yaml:**
- Add `storage:` section with `warning_percent`, `critical_percent`, `check_enabled`, `cleanup_suggest`

**templates/global-config-template.sh:**
- Add `DEFAULT_STORAGE_WARNING_PERCENT=80`, `DEFAULT_STORAGE_CRITICAL_PERCENT=90`, `DEFAULT_STORAGE_CHECK_ENABLED=true`, `DEFAULT_STORAGE_CLEANUP_SUGGEST=true`

**bin/backup-config.sh:**
- Add validation for STORAGE_WARNING_PERCENT (integer 1-99), STORAGE_CRITICAL_PERCENT (integer 1-99), and that warning < critical. Follow existing validation patterns in `mode_validate()`.

AVOID: Adding validation for boolean vars beyond checking true/false (existing pattern doesn't validate booleans individually). AVOID: Changing existing check_disk_space() in file-ops.sh — the new library wraps it with configurable thresholds.
  </action>
  <verify>
Run `bash -n lib/core/config.sh && bash -n templates/backup-config.sh && bash -n templates/global-config-template.sh && bash -n bin/backup-config.sh` — all syntax checks pass.
Grep for all 4 variables in each file to confirm presence.
  </verify>
  <done>
All 4 STORAGE_* variables have defaults in config.sh, config_key_to_var/config_var_to_key mappings, template entries in all 3 template files, global defaults, and validation in backup-config.sh. Warning < critical validated.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n lib/features/storage-monitor.sh` passes
- [ ] `bash -n lib/core/config.sh` passes
- [ ] `bash -n bin/backup-config.sh` passes
- [ ] `bash -n templates/backup-config.sh` passes
- [ ] `bash -n templates/global-config-template.sh` passes
- [ ] All 4 storage functions defined in storage-monitor.sh
- [ ] STORAGE_* variables present in all config layers
- [ ] config_key_to_var and config_var_to_key have storage.* mappings
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No syntax errors in any modified files
- Storage monitoring library exists with pre_backup_storage_check, get_volume_stats, get_per_project_storage, suggest_cleanup
- Config variables wired end-to-end across all config layers
</success_criteria>

<output>
After completion, create `.planning/phases/21-storage-warnings/21-01-SUMMARY.md`
</output>
