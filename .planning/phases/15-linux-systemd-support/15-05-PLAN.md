---
phase: 15-linux-systemd-support
plan: 05
type: execute
---

<objective>
Complete daemon management migration across all remaining install, config, and uninstall scripts.

Purpose: After Plan 04 migrated the core daemon scripts, this plan completes the migration by updating the per-project installer, project configurator, auto-configure library, per-project uninstaller, and helper installer. This is the final plan — after completion, zero launchctl calls remain outside daemon-manager.sh.
Output: 5 remaining scripts migrated; zero direct launchctl/plist calls in the entire project outside daemon-manager.sh. Phase 15 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-linux-systemd-support/15-RESEARCH.md
@.planning/phases/15-linux-systemd-support/15-04-SUMMARY.md

# The abstraction layer:
@lib/platform/daemon-manager.sh

# Scripts to migrate:
@bin/install.sh
@bin/configure-project.sh
@bin/uninstall.sh
@bin/install-helper.sh
@lib/auto-configure.sh

**Tech stack available:** lib/platform/daemon-manager.sh with full daemon lifecycle API
**Established patterns:** daemon-manager.sh sourced directly in standalone scripts; template-based service generation
**Constraining decisions:**
- Research: install-helper.sh is inherently macOS-only (menu bar app) — daemon parts migrate, macOS UI parts get platform guard
- Research: Support both com.checkpoint.* and com.claudecode.backup.* naming for backwards compat during uninstall
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate install.sh and configure-project.sh to daemon-manager.sh</name>
  <files>bin/install.sh, bin/configure-project.sh</files>
  <action>
**bin/install.sh** (~1251 lines) — Per-project installer. Currently has:
- launchctl dependency check (~lines 81-83): `if [[ "$OSTYPE" == "darwin"* ]] && ! command -v launchctl` → Replace with daemon-manager.sh availability check. On Linux, check for systemctl instead. Or simply remove this warning since daemon-manager.sh handles fallback to cron automatically.
- Per-project daemon plist generation + launchctl load (~lines 1152-1186): Inline heredoc creates plist → Replace with `install_daemon "$PROJECT_NAME" "$DAEMON_SCRIPT" "$PROJECT_DIR" "$PROJECT_NAME" "daemon"`
- Watcher plist from template + launchctl load (~lines 1189-1204): sed template → Replace with `install_daemon "watcher-$PROJECT_NAME" "$WATCHER_SCRIPT" "$PROJECT_DIR" "$PROJECT_NAME" "watcher"`

Migrate:
1. Source daemon-manager.sh (after LIB_DIR established)
2. Replace launchctl dependency warning with platform-neutral check or remove entirely
3. Replace per-project daemon plist heredoc + launchctl with single `install_daemon` call
4. Replace watcher plist template + launchctl with single `install_daemon` call
5. Update user-facing messages: "Daemon installed" instead of "LaunchAgent loaded"
6. Remove `PLIST_FILE` variable construction — daemon-manager.sh handles paths internally

**bin/configure-project.sh** (~359 lines) — Project configuration. Currently has:
- Plist generation + launchctl load (~lines 302-327): Inline heredoc creates plist for configured daemon

Migrate:
1. Source daemon-manager.sh
2. Replace plist heredoc + launchctl with `install_daemon "$PROJECT_NAME" "$DAEMON_CMD" "$PROJECT_DIR" "$PROJECT_NAME" "daemon"`
3. Update user-facing messages

For both: grep for ALL `launchctl` calls, ALL `plist` references in heredocs, and ensure none remain (except comments explaining what the daemon-manager does).
  </action>
  <verify>grep -n "launchctl" bin/install.sh bin/configure-project.sh returns no matches; grep -n "cat.*PLIST" bin/install.sh bin/configure-project.sh returns no inline heredoc plist generation; bash -n passes for both files</verify>
  <done>Zero direct launchctl calls in install.sh and configure-project.sh; no inline plist generation; both use daemon-manager.sh API; both pass syntax check</done>
</task>

<task type="auto">
  <name>Task 2: Migrate uninstall.sh, install-helper.sh, and auto-configure.sh to daemon-manager.sh</name>
  <files>bin/uninstall.sh, bin/install-helper.sh, lib/auto-configure.sh</files>
  <action>
**bin/uninstall.sh** (~220 lines) — Per-project uninstaller. Currently has:
- Orphan cleanup loop (~lines 11-90): Iterates `~/Library/LaunchAgents/com.claudecode.backup.*.plist`, launchctl unload + rm for missing project dirs
- Watcher plist unload + rm (~lines 167-173)
- Backup daemon plist unload + rm (~lines 181-187)

Migrate:
1. Source daemon-manager.sh
2. Orphan cleanup: Replace plist file iteration with `list_daemons "checkpoint"` + `list_daemons "claudecode"` to find all checkpoint daemons, then check each project dir exists, `uninstall_daemon` for orphans. The daemon-manager handles platform-specific listing (launchd list on macOS, systemctl list on Linux, crontab list on cron).
3. Watcher removal: Replace plist unload+rm with `uninstall_daemon "watcher-$PROJECT_NAME"`
4. Daemon removal: Replace plist unload+rm with `uninstall_daemon "$PROJECT_NAME"`
5. Remove all `$HOME/Library/LaunchAgents` path references — daemon-manager handles paths

**bin/install-helper.sh** (~135 lines) — macOS menu bar helper app installer. This script is inherently macOS-only (creates a native macOS .app). Currently has:
- Plist generation for helper LaunchAgent (~lines 93-114)
- launchctl unload + load (~lines 116-117)
- osascript login item setup (~line 88)

Migrate:
1. Source daemon-manager.sh
2. Replace plist heredoc + launchctl with `install_daemon "helper" "$APP_PATH/Contents/MacOS/$APP_NAME" "$HOME" "checkpoint" "watchdog"`
3. Keep osascript login item code — this is macOS System Events automation, not daemon management. Wrap in `if [ "$(uname -s)" = "Darwin" ]` guard.
4. Add early exit at top of script if not macOS: `if [ "$(uname -s)" != "Darwin" ]; then echo "Helper app is macOS only"; exit 0; fi` — the menu bar app concept doesn't apply to Linux.

**lib/auto-configure.sh** (~1291 lines) — Auto-configure library. Currently has:
- `install_project_daemon()` function (~lines 1202-1260): Full plist generation + launchctl load

Migrate:
1. Source daemon-manager.sh (or check if it's already available via backup-lib.sh loading chain)
2. Replace the `install_project_daemon()` function body: Remove inline plist heredoc, replace with `install_daemon "$safe_name" "$daemon_script" "$project_dir" "$project_name" "daemon"` from daemon-manager.sh
3. Keep the daemon script discovery logic (finding backup-daemon.sh in ~/.local/lib or /usr/local/lib) — that's not daemon management
4. Keep the safe_name sanitization logic — that's still needed for the service name

**Project-wide final sweep:**
After all 3 files migrated, run:
`grep -rn "launchctl" bin/ lib/ integrations/` — the ONLY matches should be inside `lib/platform/daemon-manager.sh` (the launchd backend). If any other matches exist, fix them.

Also run:
`grep -rn "Library/LaunchAgents" bin/ lib/` — should only match daemon-manager.sh and comments/docs. No direct path construction outside the abstraction.
  </action>
  <verify>grep -rn "launchctl" bin/ lib/ integrations/ shows matches ONLY in lib/platform/daemon-manager.sh; grep -rn "Library/LaunchAgents" bin/ lib/ shows matches ONLY in lib/platform/daemon-manager.sh; bash -n passes for all 3 files</verify>
  <done>Zero direct launchctl calls in entire project outside daemon-manager.sh; zero direct LaunchAgent path references outside daemon-manager.sh; all scripts use abstraction layer; Phase 15 complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/install.sh` passes
- [ ] `bash -n bin/configure-project.sh` passes
- [ ] `bash -n bin/uninstall.sh` passes
- [ ] `bash -n bin/install-helper.sh` passes
- [ ] `bash -n lib/auto-configure.sh` passes
- [ ] `grep -rn "launchctl" bin/ lib/ integrations/` shows matches ONLY in lib/platform/daemon-manager.sh
- [ ] `grep -rn "stat -f" bin/ lib/ integrations/` shows matches ONLY in lib/platform/compat.sh
- [ ] `grep -rn "Library/LaunchAgents" bin/ lib/` shows matches ONLY in lib/platform/daemon-manager.sh (and possibly comments)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Zero direct launchctl calls outside daemon-manager.sh
- Zero macOS-specific stat calls outside compat.sh
- Zero direct LaunchAgent path construction outside daemon-manager.sh
- install-helper.sh has macOS-only guard
- Phase 15: Linux Systemd Support complete
</success_criteria>

<output>
After completion, create `.planning/phases/15-linux-systemd-support/15-05-SUMMARY.md`:

# Phase 15 Plan 05: Complete Daemon Migration Summary

**[Substantive one-liner]**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Phase 15 Complete

All 5 plans finished:
1. **15-01:** Platform compatibility layer (stat portability + notifications for core scripts)
2. **15-02:** stat portability across all backup operation scripts
3. **15-03:** Daemon manager abstraction + systemd/cron templates
4. **15-04:** Core daemon script migration (watchdog, pause, install-global, uninstall-global)
5. **15-05:** Complete daemon migration (install, configure, uninstall, helper, auto-configure)

Checkpoint now supports macOS (launchd), Linux (systemd user services), and universal fallback (cron).

## Next Phase Readiness
- Ready for Phase 16: Backup Verification
</output>
