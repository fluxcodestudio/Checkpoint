---
phase: 15-linux-systemd-support
plan: 01
type: execute
---

<objective>
Create cross-platform compatibility module for stat commands and integrate into core monitoring scripts.

Purpose: The project has 32+ macOS-specific `stat -f%z`/`stat -f%m` calls that will fail on Linux. This plan creates the portability foundation and migrates the most critical scripts (watchdog, health-stats, status, checkpoint).
Output: `lib/platform/compat.sh` with portable stat functions; 4 core scripts migrated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-linux-systemd-support/15-RESEARCH.md
@.planning/phases/13-native-file-watcher/13-01-SUMMARY.md

# Key files:
@lib/platform/file-watcher.sh
@bin/checkpoint-watchdog.sh
@lib/features/health-stats.sh
@bin/backup-status.sh
@bin/checkpoint.sh

**Tech stack available:** lib/platform/ directory for platform abstractions, module loader in backup-lib.sh
**Established patterns:** Platform wrapper with detect-and-dispatch (from file-watcher.sh), include-guard-standalone-module
**Constraining decisions:**
- Phase 13: lib/platform/ directory established for platform-specific abstractions
- Phase 13: Modules can be standalone (sourced directly) or loaded via backup-lib.sh
- Project uses Bash 3.2 compatibility — no associative arrays, no `[[ ]]` where `[ ]` suffices
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/platform/compat.sh with cross-platform stat and notification helpers</name>
  <files>lib/platform/compat.sh</files>
  <action>
Create `lib/platform/compat.sh` as a standalone platform compatibility module following the same pattern as `lib/platform/file-watcher.sh` (include guard, no backup-lib.sh dependency).

Functions to implement:

1. `get_file_size(file)` — Returns file size in bytes
   - Darwin: `stat -f%z "$file" 2>/dev/null || echo 0`
   - Linux/other: `stat -c%s "$file" 2>/dev/null || echo 0`

2. `get_file_mtime(file)` — Returns modification time as epoch seconds
   - Darwin: `stat -f%m "$file" 2>/dev/null || echo 0`
   - Linux/other: `stat -c%Y "$file" 2>/dev/null || echo 0`

3. `get_file_owner_uid(file)` — Returns file owner UID
   - Darwin: `stat -f "%u" "$file" 2>/dev/null || echo -1`
   - Linux/other: `stat -c "%u" "$file" 2>/dev/null || echo -1`

4. `send_notification(title, message)` — Cross-platform desktop notification
   - Darwin: `osascript -e "display notification..." 2>/dev/null || true`
   - Linux: `notify-send "$title" "$message" 2>/dev/null || true` (check command -v first)
   - Fallback: silent (no notification available)

Implementation notes:
- Use `_COMPAT_LOADED` include guard (same pattern as file-watcher.sh's approach)
- Cache `uname -s` result in a module-level variable `_COMPAT_OS` to avoid repeated subprocess calls
- All functions must work with `set -euo pipefail`
- Do NOT use `[[ ]]` — use `[ ]` for Bash 3.2 compatibility
- Do NOT use associative arrays, `${var,,}`, `|&`, or other Bash 4+ features

Also add compat.sh to backup-lib.sh's module loading so all scripts that source backup-lib.sh automatically get portable stat functions. Find where backup-lib.sh loads platform modules and add: `source "$LIB_DIR/platform/compat.sh"` (with appropriate path resolution). If backup-lib.sh doesn't have a platform loading section, add it near the end of the module loading sequence — compat.sh has no dependencies on other modules.
  </action>
  <verify>bash -n lib/platform/compat.sh passes; sourcing the file and calling get_file_size on an existing file returns a numeric value; calling get_file_mtime returns epoch seconds; send_notification runs without error</verify>
  <done>lib/platform/compat.sh exists with 4 functions; all functions dispatch correctly based on uname; backup-lib.sh sources compat.sh in its module loading</done>
</task>

<task type="auto">
  <name>Task 2: Migrate stat calls in core monitoring scripts to use compat.sh</name>
  <files>bin/checkpoint-watchdog.sh, lib/features/health-stats.sh, bin/backup-status.sh, bin/checkpoint.sh</files>
  <action>
Migrate macOS-specific stat calls and inline osascript notifications in these 4 scripts to use the new compat.sh functions.

**bin/checkpoint-watchdog.sh:**
- Line ~25: Replace `stat -f%z "$LOG_FILE"` with `get_file_size "$LOG_FILE"`
- Line ~106: Replace inline `osascript -e "display notification..."` with `send_notification "$title" "$message"`
- Add `source "$SCRIPT_DIR/../lib/platform/compat.sh"` near the top (after SCRIPT_DIR is resolved). Checkpoint-watchdog.sh is a standalone script that may not source backup-lib.sh — check and add direct source if needed.

**lib/features/health-stats.sh:**
- Line ~147: Replace `stat -f%m -t%s` with `get_file_mtime` (health-stats.sh is loaded via backup-lib.sh, so compat.sh is already available from Task 1)

**bin/backup-status.sh:**
- Find all `stat -f%m` and `stat -f%z` calls (approx lines 316-334) and replace with `get_file_mtime`/`get_file_size`
- backup-status.sh sources backup-lib.sh, so compat.sh is already available

**bin/checkpoint.sh:**
- Line ~53: Replace `stat -f "%u"` with `get_file_owner_uid`
- Line ~153: Replace `stat -f %m` with `get_file_mtime`
- checkpoint.sh sources backup-lib.sh, so compat.sh is already available

For each file: grep for `stat -f` to find ALL macOS-specific stat calls. Replace each with the appropriate compat.sh function. Do NOT leave any `stat -f` calls in these 4 files.
  </action>
  <verify>grep -rn "stat -f" bin/checkpoint-watchdog.sh lib/features/health-stats.sh bin/backup-status.sh bin/checkpoint.sh returns no matches; bash -n passes for all 4 files; grep -n "osascript" bin/checkpoint-watchdog.sh returns no matches (notification now goes through send_notification)</verify>
  <done>Zero `stat -f` calls remain in these 4 files; zero inline osascript calls in checkpoint-watchdog.sh; all files pass bash -n syntax check</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n lib/platform/compat.sh` passes
- [ ] `bash -n bin/checkpoint-watchdog.sh` passes
- [ ] `bash -n lib/features/health-stats.sh` passes
- [ ] `bash -n bin/backup-status.sh` passes
- [ ] `bash -n bin/checkpoint.sh` passes
- [ ] `grep -rn "stat -f" lib/platform/compat.sh` shows ONLY the macOS implementations inside case branches
- [ ] `grep -rn "stat -f" bin/checkpoint-watchdog.sh lib/features/health-stats.sh bin/backup-status.sh bin/checkpoint.sh` returns nothing
</verification>

<success_criteria>

- lib/platform/compat.sh created with 4 cross-platform functions
- backup-lib.sh auto-loads compat.sh
- 4 core scripts migrated — zero macOS-specific stat calls remaining in those files
- checkpoint-watchdog.sh uses send_notification instead of inline osascript
- All files pass bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/15-linux-systemd-support/15-01-SUMMARY.md`
</output>
