---
phase: 15-linux-systemd-support
plan: 04
type: execute
---

<objective>
Migrate core daemon scripts to use the daemon-manager.sh abstraction layer.

Purpose: Replace hardcoded launchctl calls in the watchdog, pause, install-global, and uninstall-global scripts with the platform-agnostic daemon-manager.sh API. These are the core daemon lifecycle scripts that must work cross-platform.
Output: 4 scripts migrated from direct launchctl calls to daemon-manager.sh dispatch.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-linux-systemd-support/15-RESEARCH.md
@.planning/phases/15-linux-systemd-support/15-03-SUMMARY.md

# The abstraction layer to use:
@lib/platform/daemon-manager.sh

# Scripts to migrate:
@bin/checkpoint-watchdog.sh
@bin/backup-pause.sh
@bin/install-global.sh
@bin/uninstall-global.sh

**Tech stack available:** lib/platform/daemon-manager.sh with install_daemon, uninstall_daemon, start_daemon, stop_daemon, restart_daemon, status_daemon, list_daemons
**Established patterns:** Source daemon-manager.sh directly in standalone scripts; scripts using backup-lib.sh may need explicit source
**Constraining decisions:**
- Research: All launchctl calls must go through daemon-manager.sh abstraction
- Research: Watchdog on Linux should focus on backup health monitoring, not process lifecycle (systemd handles restarts)
- Research: Support both com.checkpoint.* and com.claudecode.backup.* naming for backwards compat
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate checkpoint-watchdog.sh and backup-pause.sh to daemon-manager.sh</name>
  <files>bin/checkpoint-watchdog.sh, bin/backup-pause.sh</files>
  <action>
**bin/checkpoint-watchdog.sh** — The watchdog guardian process. Currently uses:
- `launchctl list | grep "com.claudecode.backup"` in `get_running_daemons()` (~line 71)
- `launchctl unload` + `launchctl load -w` in `restart_daemon()` (~lines 77-85)
- `launchctl list` to check daemon status

Migrate:
1. Add `source "$SCRIPT_DIR/../lib/platform/daemon-manager.sh"` near the top (after SCRIPT_DIR resolved)
2. Replace `get_running_daemons()` function body: use `list_daemons "checkpoint"` or `list_daemons "claudecode"` from daemon-manager.sh
3. Replace `restart_daemon()` function body: use `restart_daemon "$label"` from daemon-manager.sh
4. Replace any `launchctl list` status checks with `status_daemon`
5. Remove the `if [[ "$OSTYPE" == "darwin"* ]]` guard if it exists around launchd code — the abstraction handles platform detection

Important: The watchdog's core purpose (heartbeat monitoring, backup health checks) remains unchanged. Only the daemon lifecycle operations (list, restart, status) go through the abstraction. The watchdog's monitoring logic stays as-is.

**bin/backup-pause.sh** — Pauses/resumes backups. Currently uses:
- `launchctl unload "$plist"` (~line 40) to pause
- `launchctl load "$plist"` (~line 65) to resume

Migrate:
1. Add `source` for daemon-manager.sh (resolve path via SCRIPT_DIR or LIB_DIR)
2. Replace `launchctl unload "$plist"` with `stop_daemon "$service_name"` — derive service_name from the plist filename
3. Replace `launchctl load "$plist"` with `start_daemon "$service_name"`
4. Remove any direct plist path construction — daemon-manager.sh handles path resolution

For both files: grep for ALL `launchctl` calls and ensure none remain. Each call must go through the daemon-manager.sh API.
  </action>
  <verify>grep -n "launchctl" bin/checkpoint-watchdog.sh bin/backup-pause.sh returns no matches; bash -n passes for both files</verify>
  <done>Zero direct launchctl calls in checkpoint-watchdog.sh and backup-pause.sh; both use daemon-manager.sh API exclusively; both pass syntax check</done>
</task>

<task type="auto">
  <name>Task 2: Migrate install-global.sh and uninstall-global.sh to daemon-manager.sh</name>
  <files>bin/install-global.sh, bin/uninstall-global.sh</files>
  <action>
**bin/install-global.sh** — Global installer. Currently has:
- `if [[ "$OSTYPE" == "darwin"* ]]` guard around entire LaunchAgent section (~line 231)
- Inline plist generation via heredoc (~lines 246-271)
- `launchctl unload` + `launchctl load` (~lines 270-271)

Migrate:
1. Source daemon-manager.sh (after SCRIPT_DIR/LIB_DIR resolved)
2. Remove the `if [[ "$OSTYPE" == "darwin"* ]]` platform guard — daemon-manager.sh handles this
3. Replace the entire inline plist generation + launchctl block with:
   ```bash
   install_daemon "global-daemon" "$BIN_DIR/backup-all" "$HOME" "global" "daemon"
   ```
   The daemon-manager.sh `install_daemon` function handles template selection, placeholder replacement, and platform-specific registration (plist on macOS, systemd service on Linux, cron on fallback)
4. Keep the project registry initialization (`projects.json` creation) — that's not daemon-specific
5. Update status messages to be platform-neutral: "Global daemon installed (hourly backups)" instead of "LaunchAgent installed"

**bin/uninstall-global.sh** — Global uninstaller. Currently has:
- `launchctl unload` for helper app plist (~line 92)
- `rm -f "$HELPER_PLIST"` (~line 93)
- `osascript` for System Events login item removal (~line 94)
- `launchctl unload` for global daemon plist (~line 103)
- `rm -f "$GLOBAL_PLIST"` (~line 104)

Migrate:
1. Source daemon-manager.sh
2. Replace helper plist unload+rm with `uninstall_daemon "helper"` — the function handles stop+disable+remove for the active platform
3. Replace global daemon plist unload+rm with `uninstall_daemon "global-daemon"`
4. The `osascript` System Events login item removal is macOS-only and NOT a daemon operation — keep it but wrap in `if [ "$(uname -s)" = "Darwin" ]` guard (it's legitimate macOS-only UI cleanup, not daemon management)
5. The `pkill` for the helper app is process management, not daemon management — keep it as-is
6. The `rm -rf "$APP_PATH"` is file cleanup, not daemon management — keep it as-is
7. Update status messages to be platform-neutral

For both files: grep for ALL `launchctl` calls and ensure none remain. Grep for ALL inline plist heredocs and ensure none remain.
  </action>
  <verify>grep -n "launchctl" bin/install-global.sh bin/uninstall-global.sh returns no matches; grep -n "PLIST" bin/install-global.sh shows no inline heredoc generation; bash -n passes for both files</verify>
  <done>Zero direct launchctl calls in install-global.sh and uninstall-global.sh; no inline plist generation; both use daemon-manager.sh API; both pass syntax check</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/checkpoint-watchdog.sh` passes
- [ ] `bash -n bin/backup-pause.sh` passes
- [ ] `bash -n bin/install-global.sh` passes
- [ ] `bash -n bin/uninstall-global.sh` passes
- [ ] `grep -rn "launchctl" bin/checkpoint-watchdog.sh bin/backup-pause.sh bin/install-global.sh bin/uninstall-global.sh` returns no matches
- [ ] No inline plist generation in install-global.sh (all through templates)
</verification>

<success_criteria>

- 4 core daemon scripts migrated to daemon-manager.sh abstraction
- Zero direct launchctl calls in these files
- Watchdog uses list_daemons/restart_daemon/status_daemon
- Pause uses stop_daemon/start_daemon
- Install-global uses install_daemon with template-based generation
- Uninstall-global uses uninstall_daemon for clean removal
- All files pass bash -n syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/15-linux-systemd-support/15-04-SUMMARY.md`
</output>
