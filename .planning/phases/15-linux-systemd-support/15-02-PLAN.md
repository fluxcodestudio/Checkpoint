---
phase: 15-linux-systemd-support
plan: 02
type: execute
---

<objective>
Complete stat portability migration across all remaining backup operation scripts.

Purpose: After Plan 01 migrated core monitoring scripts, this plan migrates the remaining 4 high-traffic backup scripts that use macOS-specific stat calls. These scripts (backup-now, backup-daemon, backup-cleanup, backup-restore) handle the actual backup operations and must work on Linux.
Output: Zero macOS-specific stat calls remaining in the entire project (outside compat.sh itself).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-linux-systemd-support/15-RESEARCH.md
@.planning/phases/15-linux-systemd-support/15-01-SUMMARY.md

# Key files (all source backup-lib.sh which now auto-loads compat.sh):
@bin/backup-now.sh
@bin/backup-daemon.sh
@bin/backup-cleanup.sh
@bin/backup-restore.sh
@lib/platform/compat.sh

**Tech stack available:** lib/platform/compat.sh with get_file_size(), get_file_mtime()
**Established patterns:** compat.sh auto-loaded via backup-lib.sh — no explicit source needed in these scripts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate stat calls in backup-now.sh and backup-daemon.sh</name>
  <files>bin/backup-now.sh, bin/backup-daemon.sh</files>
  <action>
Replace all macOS-specific stat calls with compat.sh functions. Both scripts already source backup-lib.sh, so compat.sh functions are available.

**bin/backup-now.sh** (~5 stat calls):
- Line ~399: `stat -f%z "$DB_PATH"` → `get_file_size "$DB_PATH"` (database size check)
- Line ~581: `stat -f%z "$backup_file"` → `get_file_size "$backup_file"` (backup file size)
- Line ~755: `stat -f%z "$file"` → `get_file_size "$file"` (individual file size)
- Line ~791: `stat -f%z "$file"` → `get_file_size "$file"`
- Line ~951: `stat -f%z "$DB_PATH"` → `get_file_size "$DB_PATH"`
- Search for ANY other `stat -f` calls — line numbers are approximate, grep thoroughly

**bin/backup-daemon.sh** (~3 stat calls):
- Line ~194: `stat -f%z "$DB_PATH"` → `get_file_size "$DB_PATH"` (database change detection)
- Line ~195: `stat -f%z "$DB_PATH"` → `get_file_size "$DB_PATH"`
- Line ~449: `stat -f%z` → `get_file_size`
- Line ~464: `stat -f%z` → `get_file_size`
- Search for ANY other `stat -f` calls

For each replacement: ensure the surrounding code handles the return value correctly. `get_file_size` returns 0 on failure (same as the existing `|| echo 0` pattern), so comparisons should work unchanged.
  </action>
  <verify>grep -n "stat -f" bin/backup-now.sh bin/backup-daemon.sh returns no matches; bash -n passes for both files</verify>
  <done>Zero `stat -f` calls in backup-now.sh and backup-daemon.sh; both pass syntax check</done>
</task>

<task type="auto">
  <name>Task 2: Migrate stat calls in backup-cleanup.sh and backup-restore.sh</name>
  <files>bin/backup-cleanup.sh, bin/backup-restore.sh</files>
  <action>
Replace all macOS-specific stat calls with compat.sh functions. Both scripts source backup-lib.sh, so compat.sh functions are available.

**bin/backup-cleanup.sh** (~12 stat calls — highest density in project):
- Lines ~183, 195, 212, 228, 259, 269, 288, 298, 337, 386, 454, 487: All `stat -f%z` calls for file size calculations in cleanup operations
- Replace each `stat -f%z "$file"` with `get_file_size "$file"`
- Some may use `stat -f%m` for mtime — replace with `get_file_mtime`
- Search exhaustively: `grep -n "stat -f" bin/backup-cleanup.sh`

**bin/backup-restore.sh** (~6 stat calls):
- Lines ~431, 433: `stat -f%m` → `get_file_mtime` (modification time for restore point selection)
- Lines ~657, 727: `stat -f%z` → `get_file_size`
- Lines ~743, 745: `stat -f%m` / `stat -f%z` → appropriate compat function
- Search exhaustively: `grep -n "stat -f" bin/backup-restore.sh`

After migrating these 2 files, do a project-wide sweep:
`grep -rn "stat -f" bin/ lib/ integrations/` — the ONLY matches should be inside `lib/platform/compat.sh` (the macOS case branch). If any other matches exist, fix them in this task.

Do NOT modify files already migrated in Plan 15-01 (checkpoint-watchdog.sh, health-stats.sh, backup-status.sh, checkpoint.sh).
  </action>
  <verify>grep -rn "stat -f" bin/ lib/ integrations/ shows matches ONLY in lib/platform/compat.sh; bash -n passes for both files</verify>
  <done>Zero `stat -f` calls in entire project outside compat.sh; project-wide stat portability complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/backup-now.sh` passes
- [ ] `bash -n bin/backup-daemon.sh` passes
- [ ] `bash -n bin/backup-cleanup.sh` passes
- [ ] `bash -n bin/backup-restore.sh` passes
- [ ] `grep -rn "stat -f" bin/ lib/ integrations/` shows matches ONLY inside lib/platform/compat.sh
</verification>

<success_criteria>

- All 4 backup operation scripts migrated to portable stat functions
- Project-wide: zero macOS-specific stat calls outside compat.sh
- All migrated files pass bash -n syntax check
- Phase 15 stat portability objective complete
</success_criteria>

<output>
After completion, create `.planning/phases/15-linux-systemd-support/15-02-SUMMARY.md`
</output>
