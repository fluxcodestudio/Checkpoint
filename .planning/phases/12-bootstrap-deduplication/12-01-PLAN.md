---
phase: 12-bootstrap-deduplication
plan: 01
type: execute
---

<objective>
Extract the duplicated 7-line symlink resolution pattern from 18 bin/ scripts into a shared bin/bootstrap.sh file; standardize script initialization across the codebase.

Purpose: Eliminate ~200 lines of duplicated boilerplate, establish a single canonical pattern for script initialization, and make future bin/ scripts trivial to bootstrap.
Output: bin/bootstrap.sh shared file, 18 migrated bin/ scripts, updated install/uninstall for global symlink support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/11-modularize-foundation/11-03-SUMMARY.md

# Key files:
@lib/backup-lib.sh
@bin/install-global.sh
@bin/uninstall-global.sh

**Tech stack available:** Pure bash, Bash 3.2+ compatible
**Established patterns:**
- Module loader pattern (lib/backup-lib.sh sources 16 modules)
- Include guard safe form: `[ -n "${VAR:-}" ] && return || readonly VAR=1`
- `set -euo pipefail` in all scripts
- `source` keyword (not dot notation)

**Constraining decisions:**
- [Phase 11]: Thin module loader pattern established — bin/ scripts source `$LIB_DIR/backup-lib.sh` which loads all modules
- [PROJECT]: Bash 3.2+ required (macOS default), no Bash 4+ features
- [PROJECT]: `$((var + 1))` not `((var++))` for set -e compatibility

**Design decisions for this phase:**

1. **bootstrap.sh location: `bin/`** — Lives alongside the scripts it bootstraps. Scripts source it via `"$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"` which works for both per-project (direct path) and global install (when symlinked to $BIN_DIR).

2. **Uses `BASH_SOURCE[1]` to resolve the caller** — When bootstrap.sh is sourced, `BASH_SOURCE[0]` = bootstrap.sh itself, `BASH_SOURCE[1]` = the calling script. Bootstrap resolves the CALLER through symlinks. This is the key trick that eliminates duplication.

3. **Bootstrap does NOT auto-source backup-lib.sh** — Scripts explicitly source what they need after bootstrap. This keeps bootstrap minimal and handles the two script categories (those needing backup-lib.sh vs those needing config files).

4. **Global install: symlink bootstrap.sh** — `ln -s "$LIB_DIR/bin/bootstrap.sh" "$BIN_DIR/bootstrap.sh"` alongside other command symlinks. When a symlinked script does `source "$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"`, bash follows the symlink to read the real file.

**Scripts to migrate (18 with symlink resolution pattern):**
bin/backup-all-projects.sh, bin/backup-cleanup.sh, bin/backup-cloud-config.sh,
bin/backup-config.sh, bin/backup-daemon.sh, bin/backup-failures.sh,
bin/backup-now.sh, bin/backup-pause.sh, bin/backup-restore.sh,
bin/backup-scan-malware.sh, bin/backup-status.sh, bin/backup-update.sh,
bin/backup-watch.sh, bin/backup-watcher.sh, bin/checkpoint-watchdog.sh,
bin/install-integrations.sh, bin/install-skills.sh, bin/smart-backup-trigger.sh

**Scripts to leave unchanged (11 — different discovery logic or no symlink pattern):**
bin/backup-dashboard.sh, bin/backup-indicator.sh, bin/checkpoint.sh,
bin/checkpoint-dashboard.sh, bin/configure-project.sh, bin/install.sh,
bin/install-global.sh, bin/install-helper.sh, bin/uninstall.sh,
bin/uninstall-global.sh, bin/uninstall-helper.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bin/bootstrap.sh and update install/uninstall scripts</name>
  <files>bin/bootstrap.sh, bin/install-global.sh, bin/uninstall-global.sh</files>
  <action>
  **1. Create `bin/bootstrap.sh`:**

  ```bash
  #!/usr/bin/env bash
  # ==============================================================================
  # Checkpoint - Script Bootstrap
  # ==============================================================================
  # Shared initialization for bin/ scripts. Resolves the calling script's
  # real path through symlinks and sets standard path variables.
  #
  # Usage (from any bin/ script):
  #   source "$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"
  #
  # Provides:
  #   SCRIPT_DIR   - Real directory of the calling script (symlinks resolved)
  #   LIB_DIR      - Path to lib/ directory
  #   PROJECT_ROOT - Path to project root (parent of bin/)
  #
  # Works with both per-project installs and global symlinked installs.
  # Must be sourced directly from bin/ scripts (not transitively).
  # ==============================================================================

  # Include guard
  [ -n "${_CHECKPOINT_BOOTSTRAP:-}" ] && return || readonly _CHECKPOINT_BOOTSTRAP=1

  # Resolve the CALLING script's real path through symlinks.
  # BASH_SOURCE[1] is the script that sourced this file.
  _bootstrap_path="${BASH_SOURCE[1]}"
  while [ -L "$_bootstrap_path" ]; do
      _bootstrap_dir="$(cd "$(dirname "$_bootstrap_path")" && pwd)"
      _bootstrap_path="$(readlink "$_bootstrap_path")"
      [[ $_bootstrap_path != /* ]] && _bootstrap_path="$_bootstrap_dir/$_bootstrap_path"
  done

  SCRIPT_DIR="$(cd "$(dirname "$_bootstrap_path")" && pwd)"
  LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"
  PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

  unset _bootstrap_path _bootstrap_dir
  ```

  Use lowercase prefixed temp variables (`_bootstrap_path`, `_bootstrap_dir`) to avoid polluting the caller's namespace — these are cleaned up with `unset`. The exported variables (`SCRIPT_DIR`, `LIB_DIR`, `PROJECT_ROOT`) use the established SCREAMING_SNAKE_CASE convention.

  **2. Update `bin/install-global.sh`:**

  After the existing `create_symlink` calls (around line 198), add a symlink for bootstrap.sh:

  ```bash
  # Bootstrap file (sourced by all bin/ scripts for path resolution)
  ln -s "$LIB_DIR/bin/bootstrap.sh" "$BIN_DIR/bootstrap.sh"
  echo "  ✅ bootstrap.sh → $LIB_DIR/bin/bootstrap.sh"
  ```

  **3. Update `bin/uninstall-global.sh`:**

  In the symlink removal loop (line 64), add `bootstrap.sh` to the list of files to remove:

  ```bash
  for cmd in checkpoint backup-now backup-status ... bootstrap.sh; do
  ```

  Note: bootstrap.sh is a regular file name (not a command), but the removal logic (`rm -f`) handles both symlinks and regular files.
  </action>
  <verify>
  1. `bash -n bin/bootstrap.sh` — syntax check passes
  2. `head -1 bin/bootstrap.sh` shows `#!/usr/bin/env bash`
  3. `grep 'bootstrap.sh' bin/install-global.sh` shows the new symlink line
  4. `grep 'bootstrap.sh' bin/uninstall-global.sh` shows it in the removal list
  </verify>
  <done>
  - bin/bootstrap.sh exists with include guard, BASH_SOURCE[1] resolution, SCRIPT_DIR/LIB_DIR/PROJECT_ROOT exports
  - install-global.sh creates bootstrap.sh symlink during install
  - uninstall-global.sh removes bootstrap.sh during uninstall
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate 18 bin/ scripts to use bootstrap.sh</name>
  <files>
  bin/backup-all-projects.sh, bin/backup-cleanup.sh, bin/backup-cloud-config.sh,
  bin/backup-config.sh, bin/backup-daemon.sh, bin/backup-failures.sh,
  bin/backup-now.sh, bin/backup-pause.sh, bin/backup-restore.sh,
  bin/backup-scan-malware.sh, bin/backup-status.sh, bin/backup-update.sh,
  bin/backup-watch.sh, bin/backup-watcher.sh, bin/checkpoint-watchdog.sh,
  bin/install-integrations.sh, bin/install-skills.sh, bin/smart-backup-trigger.sh
  </files>
  <action>
  For each of the 18 scripts, replace the symlink resolution block + LIB_DIR computation with a single bootstrap source line. Handle two categories:

  **Category A: Scripts that source backup-lib.sh (16 scripts)**
  backup-all-projects.sh, backup-cleanup.sh, backup-cloud-config.sh,
  backup-config.sh, backup-failures.sh, backup-now.sh, backup-pause.sh,
  backup-restore.sh, backup-scan-malware.sh, backup-status.sh,
  backup-update.sh, backup-watch.sh, backup-watcher.sh,
  checkpoint-watchdog.sh, install-integrations.sh, install-skills.sh

  Replace this pattern (with minor variations per script):
  ```bash
  # Resolve symlinks to get actual script location
  SCRIPT_PATH="${BASH_SOURCE[0]}"
  while [ -L "$SCRIPT_PATH" ]; do
      SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
      SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
      [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
  done
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"

  # Source foundation library
  if [ -f "$LIB_DIR/backup-lib.sh" ]; then
      source "$LIB_DIR/backup-lib.sh"
  else
      echo "Error: Foundation library not found: $LIB_DIR/backup-lib.sh" >&2
      exit 1
  fi
  ```

  With:
  ```bash
  # Bootstrap: resolve symlinks, set SCRIPT_DIR/LIB_DIR/PROJECT_ROOT
  source "$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"

  # Source foundation library
  source "$LIB_DIR/backup-lib.sh"
  ```

  Keep any OPTIONAL library sourcing that follows (database-detector.sh, dependency-manager.sh, retention-policy.sh, etc.) — these are script-specific and stay in each script with their `if [ -f ... ]` guards.

  **Category B: Scripts that source config, not backup-lib.sh (2 scripts)**
  backup-daemon.sh, smart-backup-trigger.sh

  Replace the symlink resolution block only (these scripts don't compute LIB_DIR):
  ```bash
  # Resolve symlinks to get actual script location
  SCRIPT_PATH="${BASH_SOURCE[0]}"
  while [ -L "$SCRIPT_PATH" ]; do
      SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
      SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
      [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
  done
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  ```

  With:
  ```bash
  # Bootstrap: resolve symlinks, set SCRIPT_DIR/LIB_DIR/PROJECT_ROOT
  source "$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"
  ```

  The config-finding logic that follows stays unchanged (it uses SCRIPT_DIR which bootstrap provides).

  **Special case: backup-status.sh** uses variant variable names (`SOURCE`/`DIR` instead of `SCRIPT_PATH`/`SCRIPT_DIR`) and `cd -P` instead of `cd`. Replace the variant pattern with the standard bootstrap source line. Also normalize `LIB_DIR="$SCRIPT_DIR/../lib"` (non-pwd form) since bootstrap provides the pwd-normalized `LIB_DIR`.

  **Preservation rules:**
  - Keep `set -euo pipefail` in each script (before the bootstrap source)
  - Keep file header comments (shebang, description)
  - Keep section header comments (INITIALIZATION, LOAD LIBRARY, etc.) — update text if needed
  - Keep all code AFTER the initialization block unchanged
  - Keep optional library sourcing with `if [ -f ]` guards
  </action>
  <verify>
  1. `for f in bin/backup-*.sh bin/smart-backup-trigger.sh bin/install-integrations.sh bin/install-skills.sh bin/checkpoint-watchdog.sh; do bash -n "$f" && echo "OK: $f" || echo "FAIL: $f"; done` — all syntax checks pass
  2. `grep -l 'while \[ -L' bin/*.sh` — returns ZERO files (no remaining symlink patterns in migrated scripts)
  3. `grep -l 'bootstrap.sh' bin/*.sh` — returns exactly the 18 migrated scripts
  4. `grep -c 'BASH_SOURCE\[0\]' bin/bootstrap.sh` — returns 0 (bootstrap uses BASH_SOURCE[1], not [0])
  5. Run full test suite: `bash tests/run-all-tests.sh` — same results as Phase 11 baseline (251 passed, 7 skipped)
  6. Quick smoke test: `bin/backup-now.sh --help` and `bin/backup-status.sh --help` work correctly
  </verify>
  <done>
  - All 18 scripts migrated to use bootstrap.sh
  - No remaining symlink resolution patterns in migrated scripts
  - Each script's functional behavior unchanged
  - Full test suite passes with same results as baseline
  - ~200 lines of duplicated boilerplate eliminated
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bash -n bin/bootstrap.sh` passes
- [ ] All 18 migrated scripts pass `bash -n` syntax check
- [ ] `grep -rl 'while \[ -L' bin/*.sh` returns only unmigrated scripts (0 of the 18)
- [ ] `grep -l 'bootstrap.sh' bin/*.sh` returns exactly 18 files
- [ ] `bin/backup-now.sh --help` works (per-project path)
- [ ] `bin/backup-status.sh --help` works
- [ ] `bin/backup-daemon.sh --help` works (config-sourcing variant)
- [ ] Full test suite: `bash tests/run-all-tests.sh` — 251 passed, 7 skipped (matches Phase 11 baseline)
- [ ] Symlink smoke test: create temp symlink, verify bootstrap resolves correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No regressions in test suite
- 18 scripts use shared bootstrap.sh instead of duplicated symlink resolution
- install-global.sh creates bootstrap.sh symlink
- uninstall-global.sh removes bootstrap.sh symlink
- Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-bootstrap-deduplication/12-01-SUMMARY.md`
</output>
