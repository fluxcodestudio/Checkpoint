---
phase: 08-monitoring-enhancements
plan: 01
type: execute
---

<objective>
Add structured error codes with actionable fix suggestions to backup failure messages.

Purpose: Transform cryptic errors into self-service recovery guidance — users can fix common issues without documentation.
Output: Error code system in backup-lib.sh with categorized errors, suggested fixes, and enhanced failure state.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard-monitoring/06-01-SUMMARY.md

@lib/backup-lib.sh

**Tech available:** bash notification system, JSON state files
**Established patterns:** notify_backup_failure() escalation, backup-state.json structure
**From CONCERNS.md:** "No Error Recovery Guide" — users stuck when backups fail

**Prior decisions:**
- Health thresholds: >24h warning, >72h error
- Notifications via osascript (macOS native)
- Status file at ~/.config/checkpoint/status.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error code catalog with fix suggestions</name>
  <files>lib/backup-lib.sh</files>
  <action>
Add an ERROR CODES section to backup-lib.sh with categorized error definitions:

```bash
# ==============================================================================
# ERROR CODES AND SUGGESTED FIXES
# ==============================================================================

# Error categories: PERM (permission), DISK (storage), CONF (config), NET (network), DB (database)

# Error format: E{CATEGORY}{NUMBER} - e.g., EPERM001
declare -A ERROR_CODES ERROR_SUGGESTIONS

# Permission errors
ERROR_CODES[EPERM001]="Cannot write to backup directory"
ERROR_SUGGESTIONS[EPERM001]="Check permissions: ls -la \"\$BACKUP_DIR\" | Fix: chmod -R u+rw \"\$BACKUP_DIR\""

ERROR_CODES[EPERM002]="Cannot read source file"
ERROR_SUGGESTIONS[EPERM002]="Check file exists and is readable: ls -la \"\$FILE\""

# Disk errors
ERROR_CODES[EDISK001]="Backup directory full or quota exceeded"
ERROR_SUGGESTIONS[EDISK001]="Check disk space: df -h \"\$BACKUP_DIR\" | Free space or increase quota"

ERROR_CODES[EDISK002]="External drive not mounted"
ERROR_SUGGESTIONS[EDISK002]="Mount drive or check: ls /Volumes/ | Update BACKUP_DIR in .backup-config.sh"

# Config errors
ERROR_CODES[ECONF001]="Invalid backup configuration"
ERROR_SUGGESTIONS[ECONF001]="Validate config: cat .backup-config.sh | Check BACKUP_DIR and PROJECT_DIR"

ERROR_CODES[ECONF002]="Missing required configuration"
ERROR_SUGGESTIONS[ECONF002]="Run: checkpoint.sh init | Or create .backup-config.sh manually"

# Database errors
ERROR_CODES[EDB001]="Database connection failed"
ERROR_SUGGESTIONS[EDB001]="Check database is running | Verify credentials in .env | Test: psql/mysql/sqlite3"

ERROR_CODES[EDB002]="Database dump command failed"
ERROR_SUGGESTIONS[EDB002]="Check dump tool installed: which pg_dump mysqldump | Check permissions"

# Network errors (for cloud backup)
ERROR_CODES[ENET001]="Cloud sync destination unreachable"
ERROR_SUGGESTIONS[ENET001]="Check internet: ping -c 1 google.com | Verify cloud folder path exists"
```

Add helper functions:
```bash
# Get error description
get_error_description() {
    local code="$1"
    echo "${ERROR_CODES[$code]:-Unknown error: $code}"
}

# Get suggested fix
get_error_suggestion() {
    local code="$1"
    echo "${ERROR_SUGGESTIONS[$code]:-Check backup logs for details}"
}

# Format error with suggestion for display
format_error_with_fix() {
    local code="$1"
    local context="${2:-}"
    local desc=$(get_error_description "$code")
    local fix=$(get_error_suggestion "$code")

    echo "Error $code: $desc"
    [[ -n "$context" ]] && echo "  Context: $context"
    echo "  Fix: $fix"
}
```

NOTE: Use bash 3.2-compatible implementation if associative arrays fail (use indexed arrays with string parsing).
  </action>
  <verify>
1. Source backup-lib.sh without errors: `source lib/backup-lib.sh && echo $?`
2. Test helper: `get_error_description EPERM001` returns expected message
3. Test format: `format_error_with_fix EDISK001 "/path/to/backup"` shows code, description, fix
  </verify>
  <done>
- Error codes defined with categories
- Suggested fixes for each error
- Helper functions for formatting
- Bash 3.2 compatible
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate error codes into failure tracking</name>
  <files>lib/backup-lib.sh</files>
  <action>
Enhance `add_file_failure()` and `write_backup_state()` to include error codes and fixes:

1. Update add_file_failure() signature:
```bash
# Add file failure with error code
# Args: $1=filepath, $2=reason, $3=error_code (optional)
add_file_failure() {
    local filepath="$1"
    local reason="$2"
    local error_code="${3:-EUNK000}"  # Unknown if not provided
    local suggestion=$(get_error_suggestion "$error_code")

    # Track in global array (existing)
    BACKUP_FILE_FAILURES+=("$filepath|$reason|$error_code|$suggestion")
}
```

2. Update write_backup_state() JSON to include error codes:
```bash
# In the failures array, add error_code and suggested_fix fields:
{
  "file": "$filepath",
  "reason": "$reason",
  "error_code": "$error_code",
  "suggested_fix": "$suggestion",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
```

3. Update notify_backup_failure() to show fix suggestions:
```bash
# Include first actionable fix in notification
local first_fix=$(get_error_suggestion "$first_error_code")
send_notification \
    "Backup Failed: $PROJECT_NAME" \
    "Error: $error_desc. Fix: $first_fix" \
    "Basso"
```

4. Update file backup copy operations to use error codes:
- Permission denied → EPERM001
- Disk full → EDISK001
- File not found → EPERM002
  </action>
  <verify>
1. Force a failure (invalid path): Check backup-state.json includes error_code and suggested_fix
2. Trigger notification: Verify message includes fix suggestion
3. Run backup-status: Error codes appear in failure display
  </verify>
  <done>
- add_file_failure() accepts error codes
- backup-state.json includes structured error info
- Notifications include actionable suggestions
- Common failure paths use appropriate error codes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Source backup-lib.sh without errors
- [ ] Error codes accessible via get_error_description()
- [ ] Failures include error_code and suggested_fix in JSON
- [ ] At least 10 error codes defined covering common failure modes
</verification>

<success_criteria>
- All tasks completed
- Error code system functional
- Failures include actionable fix suggestions
- Backward compatible with existing backup-state.json consumers
</success_criteria>

<output>
After completion, create `.planning/phases/08-monitoring-enhancements/08-01-SUMMARY.md`
</output>
