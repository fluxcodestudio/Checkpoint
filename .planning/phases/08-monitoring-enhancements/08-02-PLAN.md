---
phase: 08-monitoring-enhancements
plan: 02
type: execute
---

<objective>
Enhance dashboard with error details, quick-fix commands, and trend indicators.

Purpose: Make the dashboard a self-service recovery center — users see what's wrong and how to fix it.
Output: Enhanced backup-dashboard.sh with error panel, fix commands, and health trend display.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-dashboard-monitoring/06-02-SUMMARY.md
@.planning/phases/08-monitoring-enhancements/08-01-SUMMARY.md

@lib/backup-lib.sh
@lib/global-status.sh
@bin/backup-dashboard.sh

**Tech available:** bash dashboard-ui.sh, error code system (from 08-01)
**Established patterns:** table display, interactive menus, status file caching
**From 06-02:** Dashboard table with Project, Status, Last Backup, Storage columns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error details panel to dashboard</name>
  <files>bin/backup-dashboard.sh, lib/global-status.sh</files>
  <action>
Add an error details section that shows when projects have failures:

1. Create `get_project_errors()` function in global-status.sh:
```bash
# Get recent errors for a project
# Args: $1 = project path, $2 = max errors (default 5)
# Returns: JSON-like error list
get_project_errors() {
    local project_path="$1"
    local max_errors="${2:-5}"
    local backup_dir=$(get_project_backup_dir "$project_path")
    local state_file="$backup_dir/backup-state.json"

    if [[ ! -f "$state_file" ]]; then
        echo "[]"
        return
    fi

    # Extract failures array (grep-based, no jq dependency)
    local in_failures=false
    local errors=()
    local count=0

    while IFS= read -r line; do
        if [[ "$line" =~ \"failures\": ]]; then
            in_failures=true
            continue
        fi
        if [[ "$in_failures" == "true" ]]; then
            if [[ "$line" =~ \"error_code\" ]]; then
                local code=$(echo "$line" | sed 's/.*"error_code"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
                local file=$(echo "$line" | sed 's/.*"file"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
                errors+=("$code:$file")
                ((count++))
                [[ $count -ge $max_errors ]] && break
            fi
            [[ "$line" =~ ^\] ]] && break
        fi
    done < "$state_file"

    printf '%s\n' "${errors[@]}"
}
```

2. Add `display_error_panel()` function in backup-dashboard.sh:
```bash
# Display error details panel
display_error_panel() {
    local project_path="$1"
    local name=$(basename "$project_path")

    echo ""
    echo "  Error Details for $name"
    echo "  ────────────────────────────────────────────────"

    local errors=$(get_project_errors "$project_path" 5)
    if [[ -z "$errors" ]]; then
        echo "  No recent errors"
        return
    fi

    while IFS= read -r error; do
        [[ -z "$error" ]] && continue
        local code="${error%%:*}"
        local file="${error#*:}"
        local desc=$(get_error_description "$code")
        local fix=$(get_error_suggestion "$code")

        echo "  [$code] $desc"
        echo "    File: $file"
        echo "    Fix:  $fix"
        echo ""
    done <<< "$errors"
}
```

3. Call error panel when showing project details (--project flag or interactive selection)
  </action>
  <verify>
1. `backup-dashboard --project /path/to/project` shows error panel if errors exist
2. Error codes, descriptions, and fixes display correctly
3. Empty error panel shows "No recent errors"
  </verify>
  <done>
- get_project_errors() extracts errors from state file
- Error panel shows code, description, file, and fix
- Panel integrated into project detail view
  </done>
</task>

<task type="auto">
  <name>Task 2: Add quick-fix commands and health trends</name>
  <files>bin/backup-dashboard.sh</files>
  <action>
1. Add quick-fix command suggestions after error panel:
```bash
display_quick_fixes() {
    local project_path="$1"
    local errors=$(get_project_errors "$project_path" 3)

    if [[ -z "$errors" ]]; then
        return
    fi

    echo "  Quick Fix Commands"
    echo "  ────────────────────────────────────────────────"

    # Common fixes based on error codes present
    local has_perm=false has_disk=false has_conf=false

    while IFS= read -r error; do
        local code="${error%%:*}"
        case "$code" in
            EPERM*) has_perm=true ;;
            EDISK*) has_disk=true ;;
            ECONF*) has_conf=true ;;
        esac
    done <<< "$errors"

    if [[ "$has_perm" == "true" ]]; then
        echo "  Fix permissions:"
        echo "    chmod -R u+rw \"$(get_project_backup_dir "$project_path")\""
    fi

    if [[ "$has_disk" == "true" ]]; then
        echo "  Check disk space:"
        echo "    df -h \"$(get_project_backup_dir "$project_path")\""
        echo "    backup-dashboard --cleanup-preview"
    fi

    if [[ "$has_conf" == "true" ]]; then
        echo "  Reinitialize config:"
        echo "    checkpoint.sh init"
    fi

    echo ""
}
```

2. Add health trend indicator (last 7 days):
```bash
# Get health trend from backup history
# Returns: "improving", "stable", "declining"
get_project_health_trend() {
    local project_path="$1"
    local backup_dir=$(get_project_backup_dir "$project_path")
    local log_file="$backup_dir/backup.log"

    if [[ ! -f "$log_file" ]]; then
        echo "unknown"
        return
    fi

    # Count successes vs failures in last 7 days
    local week_ago=$(date -v-7d +%Y-%m-%d 2>/dev/null || date -d "7 days ago" +%Y-%m-%d)
    local successes=$(grep -c "SUCCESS" "$log_file" 2>/dev/null | tail -1)
    local failures=$(grep -c "FAILED\|ERROR" "$log_file" 2>/dev/null | tail -1)

    local total=$((successes + failures))
    if [[ $total -eq 0 ]]; then
        echo "unknown"
    elif [[ $failures -eq 0 ]]; then
        echo "stable"
    elif [[ $((failures * 100 / total)) -gt 50 ]]; then
        echo "declining"
    elif [[ $((failures * 100 / total)) -lt 10 ]]; then
        echo "improving"
    else
        echo "stable"
    fi
}

# Format trend for display
format_health_trend() {
    local trend="$1"
    case "$trend" in
        improving) echo "↗ Improving" ;;
        stable) echo "→ Stable" ;;
        declining) echo "↘ Declining" ;;
        *) echo "- Unknown" ;;
    esac
}
```

3. Add trend column to project table (verbose mode):
```bash
# In display_projects_table(), when verbose=true:
local trend=$(get_project_health_trend "$project_path")
local trend_str=$(format_health_trend "$trend")
printf "  %-24s %-10s %-18s %-10s %s\n" "$name" "$status" "$age_str" "$storage" "$trend_str"
```
  </action>
  <verify>
1. `backup-dashboard --project /path` shows quick-fix commands for relevant errors
2. `backup-dashboard --verbose` shows trend column (↗/→/↘)
3. Trend calculation handles missing log file gracefully
  </verify>
  <done>
- Quick-fix commands generated from error types
- Health trend calculated from backup history
- Trend indicator in verbose table view
- Phase 8 Plan 2 complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Error panel displays in project detail view
- [ ] Quick-fix commands shown for permission/disk/config errors
- [ ] Health trend appears in verbose mode
- [ ] All features work without jq dependency
</verification>

<success_criteria>
- All tasks completed
- Dashboard provides actionable recovery guidance
- Trend indicators help identify degrading projects
- No new dependencies introduced
</success_criteria>

<output>
After completion, create `.planning/phases/08-monitoring-enhancements/08-02-SUMMARY.md`
</output>
