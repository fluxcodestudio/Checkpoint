---
phase: 18-daemon-lifecycle
plan: 01
type: execute
---

<objective>
Make heartbeat writes atomic and add watchdog self-monitoring.

Purpose: Prevent false daemon restarts caused by watchdog reading partially-written heartbeat JSON, and add "who watches the watchman" observability for the watchdog process itself.
Output: Atomic heartbeat writes in backup-daemon.sh, watchdog self-heartbeat in checkpoint-watchdog.sh, atomic status writes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-daemon-lifecycle/18-RESEARCH.md

# Key source files:
@bin/backup-daemon.sh
@bin/checkpoint-watchdog.sh

# Prior phase summaries:
@.planning/phases/13-native-file-watcher/13-01-SUMMARY.md
@.planning/phases/15-linux-systemd-support/15-03-SUMMARY.md
@.planning/phases/17-error-logging/17-04-SUMMARY.md

**Tech stack available:** bash 3.2+, structured logging (lib/core/logging.sh), cross-platform compat (lib/platform/compat.sh), daemon-manager (lib/platform/daemon-manager.sh)
**Established patterns:** atomic mkdir for locks (lib/ops/file-ops.sh), structured logging with log_set_context, platform wrapper dispatch

**Constraining decisions:**
- [Phase 17]: All scripts use structured logging with log_set_context + parse_log_flags
- [Phase 15]: daemon-manager.sh provides cross-platform lifecycle API
- [Phase 13]: lib/platform/ directory for platform-specific abstractions

**From research — don't hand-roll:**
- Process management → use existing daemon-manager.sh
- Notifications → use existing compat.sh send_notification()
- Log rotation → use existing logging.sh init_logging()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make heartbeat writes atomic in backup-daemon.sh</name>
  <files>bin/backup-daemon.sh</files>
  <action>
Modify the `write_heartbeat()` function (lines 151-176) to use atomic temp+rename pattern:

1. Write JSON to a temp file on the same filesystem: `${HEARTBEAT_DIR}/.heartbeat.tmp.$$` (PID suffix prevents collisions between concurrent daemons)
2. Use `mv` (POSIX atomic rename on same filesystem) to move temp file to `$HEARTBEAT_FILE`
3. Add cleanup trap to remove temp file if script exits between write and rename

Current code:
```bash
cat > "$HEARTBEAT_FILE" <<EOF
```

Replace with:
```bash
local tmp_file="${HEARTBEAT_DIR}/.heartbeat.tmp.$$"
cat > "$tmp_file" <<EOF
...
EOF
mv "$tmp_file" "$HEARTBEAT_FILE"
```

Do NOT change the JSON structure, field names, or any callers of write_heartbeat(). Only change the write mechanism.

Add a trap at the top of write_heartbeat() to clean up the temp file on unexpected exit:
```bash
trap 'rm -f "${HEARTBEAT_DIR}/.heartbeat.tmp.$$" 2>/dev/null' RETURN
```
Wait — RETURN trap would fire every time. Instead, the mv succeeds or we leave a harmless temp file. The next call overwrites it. No trap needed — the temp file is ephemeral and unique per PID.
  </action>
  <verify>
1. `bash -n bin/backup-daemon.sh` passes (syntax check)
2. `grep -c 'cat > "$HEARTBEAT_FILE"' bin/backup-daemon.sh` returns 0 (old pattern removed)
3. `grep -c 'mv.*tmp.*HEARTBEAT_FILE' bin/backup-daemon.sh` returns 1 (new pattern present)
4. `grep 'tmp_file' bin/backup-daemon.sh` shows temp file variable usage
  </verify>
  <done>write_heartbeat() uses temp+rename atomic pattern. No direct cat > to heartbeat file. JSON structure unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Add watchdog self-heartbeat and atomic status writes</name>
  <files>bin/checkpoint-watchdog.sh</files>
  <action>
Two changes to checkpoint-watchdog.sh:

**A. Make write_status() atomic (same pattern as Task 1):**

Modify `write_status()` (lines 165-179) to use temp+rename:
```bash
write_status() {
    local status="$1"
    local daemon_count="$2"
    local last_check
    last_check=$(date +%s)

    local tmp_file="${HEARTBEAT_DIR}/.watchdog-status.tmp.$$"
    cat > "$tmp_file" <<EOF
{
  "status": "$status",
  "daemon_count": $daemon_count,
  "last_check": $last_check,
  "pid": $$
}
EOF
    mv "$tmp_file" "${HEARTBEAT_DIR}/watchdog.status"
}
```

**B. Add watchdog heartbeat writing in main loop:**

Add a `write_watchdog_heartbeat()` function that writes a simple heartbeat file at `${HEARTBEAT_DIR}/watchdog.heartbeat` with atomic temp+rename:
```bash
write_watchdog_heartbeat() {
    local tmp_file="${HEARTBEAT_DIR}/.watchdog-heartbeat.tmp.$$"
    cat > "$tmp_file" <<EOF
{
  "timestamp": $(date +%s),
  "pid": $$,
  "status": "running"
}
EOF
    mv "$tmp_file" "${HEARTBEAT_DIR}/watchdog.heartbeat"
}
```

Call `write_watchdog_heartbeat` at the end of each iteration of the main `while true` loop (just before `sleep "$CHECK_INTERVAL"`).

Also clean up the watchdog heartbeat file in the existing `cleanup()` function:
```bash
rm -f "${HEARTBEAT_DIR}/watchdog.heartbeat" 2>/dev/null
```

Do NOT modify the read_heartbeat(), get_running_daemons(), restart_backup_daemon(), or trigger_backup() functions. Only add the new function and modify write_status() and the main loop.
  </action>
  <verify>
1. `bash -n bin/checkpoint-watchdog.sh` passes (syntax check)
2. `grep -c 'write_watchdog_heartbeat' bin/checkpoint-watchdog.sh` returns at least 2 (definition + call)
3. `grep 'watchdog.heartbeat' bin/checkpoint-watchdog.sh` shows heartbeat file references
4. `grep -c 'cat > "${HEARTBEAT_DIR}/watchdog.status"' bin/checkpoint-watchdog.sh` returns 0 (old non-atomic write removed)
5. `grep 'tmp_file.*watchdog-status' bin/checkpoint-watchdog.sh` shows atomic write pattern
  </verify>
  <done>Watchdog writes its own heartbeat every check cycle. write_status() uses atomic temp+rename. Watchdog heartbeat cleaned up on exit.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/backup-daemon.sh` passes
- [ ] `bash -n bin/checkpoint-watchdog.sh` passes
- [ ] No direct `cat >` writes to heartbeat or status files remain (all use temp+rename)
- [ ] Watchdog heartbeat file path: `~/.checkpoint/watchdog.heartbeat`
- [ ] JSON structures unchanged in heartbeat files
- [ ] No changes to functions other than write_heartbeat, write_status, cleanup, and main loop
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No syntax errors introduced
- Heartbeat writes are atomic (temp+rename) in both daemon and watchdog
- Watchdog writes self-heartbeat for external monitoring
</success_criteria>

<output>
After completion, create `.planning/phases/18-daemon-lifecycle/18-01-SUMMARY.md`
</output>
