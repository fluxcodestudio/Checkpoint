---
phase: 18-daemon-lifecycle
plan: 03
type: execute
---

<objective>
Fix launchd KeepAlive pattern and add auto-start behavior to install scripts.

Purpose: Allow intentional daemon stops without plist unloading (KeepAlive fix), and ensure backups start immediately after installation without requiring a reboot (auto-start).
Output: Updated plist templates with SuccessfulExit=false, install scripts that start services after registration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-daemon-lifecycle/18-RESEARCH.md

# Key source files:
@templates/com.checkpoint.watchdog.plist
@templates/launchd-watcher.plist
@bin/install-global.sh
@bin/install.sh
@lib/platform/daemon-manager.sh

# Prior plan summaries:
@.planning/phases/18-daemon-lifecycle/18-01-SUMMARY.md
@.planning/phases/18-daemon-lifecycle/18-02-SUMMARY.md

**Tech stack available:** launchd plists, systemd services, daemon-manager.sh (start_daemon API), structured logging
**Established patterns:** daemon-manager.sh dispatch (install_daemon/start_daemon), template processing with sed placeholders

**From research — key patterns:**
- KeepAlive/SuccessfulExit=false: auto-restart only on crash (non-zero exit), allows clean shutdown via exit 0
- Current KeepAlive=true: prevents intentional stops — must unload plist to stop, which launchd then re-loads on login
- install_daemon() registers but doesn't start; start_daemon() is separate call

**From research — don't hand-roll:**
- Process management → use existing daemon-manager.sh start_daemon()
- Service installation → use existing install_daemon() in daemon-manager.sh

**From research — pitfall to avoid:**
- launchd exponential backoff on crash loops: never exit non-zero for transient errors, handle retries internally
- The watchdog already handles this correctly (exit 0 in cleanup)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix KeepAlive in plist templates to use SuccessfulExit=false</name>
  <files>templates/com.checkpoint.watchdog.plist, templates/launchd-watcher.plist</files>
  <action>
Update both plist templates to replace unconditional `KeepAlive=true` with conditional `KeepAlive/SuccessfulExit=false`.

**In templates/com.checkpoint.watchdog.plist, replace:**
```xml
<key>KeepAlive</key>
<true/>
```

**With:**
```xml
<key>KeepAlive</key>
<dict>
    <key>SuccessfulExit</key>
    <false/>
</dict>
```

**In templates/launchd-watcher.plist, make the same replacement.**

This means:
- If the process exits with non-zero (crash), launchd auto-restarts it
- If the process exits with zero (intentional stop via SIGTERM → cleanup → exit 0), launchd does NOT restart it
- This matches the existing cleanup() handlers in both watchdog and watcher which `exit 0` on SIGTERM/SIGINT

Do NOT add ThrottleInterval — launchd's default 10-second throttle is sufficient and matches the systemd RestartSec=10s in the watchdog template.

Do NOT modify any other plist keys (Label, ProgramArguments, RunAtLoad, StandardOutPath, etc.).
  </action>
  <verify>
1. `xmllint --noout templates/com.checkpoint.watchdog.plist` passes (if xmllint available) OR `plutil -lint templates/com.checkpoint.watchdog.plist` passes (macOS)
2. `xmllint --noout templates/launchd-watcher.plist` passes OR `plutil -lint templates/launchd-watcher.plist` passes
3. `grep -A3 'KeepAlive' templates/com.checkpoint.watchdog.plist` shows dict with SuccessfulExit false (not bare true)
4. `grep -A3 'KeepAlive' templates/launchd-watcher.plist` shows dict with SuccessfulExit false (not bare true)
5. `grep -c '<true/>' templates/com.checkpoint.watchdog.plist` — only RunAtLoad should have true, not KeepAlive
  </verify>
  <done>Both plist templates use KeepAlive/SuccessfulExit=false. Intentional stops (exit 0) no longer trigger auto-restart. Crashes (non-zero exit) still auto-restart.</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-start behavior to install scripts</name>
  <files>bin/install-global.sh, bin/install.sh</files>
  <action>
Add explicit daemon start calls after service registration in both install scripts.

**A. In bin/install-global.sh:**

After the existing `install_daemon "global-daemon"` block (around line 248-252), add watchdog installation AND start both services:

```bash
# Install watchdog for health monitoring
WATCHDOG_PATH="$LIB_DIR/bin/checkpoint-watchdog.sh"
if install_daemon "watchdog" "$WATCHDOG_PATH" "$HOME" "global" "watcher"; then
    echo "  ✅ Watchdog installed (health monitoring)"
else
    echo "  ⚠️  Watchdog installation failed (non-critical)"
fi

# Auto-start: start services immediately (no reboot needed)
echo ""
echo "Starting services..."
if start_daemon "global-daemon"; then
    echo "  ✅ Global daemon started"
else
    echo "  ⚠️  Global daemon start failed (will start on next login)"
fi
if start_daemon "watchdog"; then
    echo "  ✅ Watchdog started"
else
    echo "  ⚠️  Watchdog start failed (will start on next login)"
fi
```

Place this BEFORE the "Installation Complete" banner (line 255).

**B. In bin/install.sh:**

After the existing daemon installation block (around line 1163-1171), add start calls:

After `install_daemon "$PROJECT_NAME" ...` succeeds, add:
```bash
    # Auto-start daemon immediately
    start_daemon "$PROJECT_NAME" 2>/dev/null && \
        echo "        ✓ Daemon started" || \
        echo "        ⚠ Daemon will start on next login"
```

After the watcher `install_daemon "watcher-$PROJECT_NAME" ...` succeeds, add:
```bash
        # Auto-start watcher immediately
        start_daemon "watcher-$PROJECT_NAME" 2>/dev/null && \
            echo "        ✓ Watcher started" || \
            echo "        ⚠ Watcher will start on next login"
```

The `2>/dev/null` on start_daemon is acceptable here because install scripts are interactive (user sees ✓/⚠ output), and start failures are non-critical (RunAtLoad will start them on next login).

Do NOT modify the install_daemon() or start_daemon() functions themselves — they are in daemon-manager.sh and already work correctly. Only add calls to them.
  </action>
  <verify>
1. `bash -n bin/install-global.sh` passes
2. `bash -n bin/install.sh` passes
3. `grep -c 'start_daemon' bin/install-global.sh` returns at least 2 (global-daemon + watchdog)
4. `grep -c 'start_daemon' bin/install.sh` returns at least 1
5. `grep 'install_daemon.*watchdog' bin/install-global.sh` shows watchdog installation
6. `grep 'Watchdog installed' bin/install-global.sh` shows success message
  </verify>
  <done>install-global.sh installs AND starts both global daemon and watchdog. install.sh starts daemon (and watcher if enabled) immediately after registration. Users get immediate backup protection without reboot.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/install-global.sh` passes
- [ ] `bash -n bin/install.sh` passes
- [ ] `plutil -lint templates/com.checkpoint.watchdog.plist` passes (or xmllint)
- [ ] `plutil -lint templates/launchd-watcher.plist` passes (or xmllint)
- [ ] Both plists use SuccessfulExit=false (not bare KeepAlive=true)
- [ ] install-global.sh installs watchdog (was missing before)
- [ ] install-global.sh starts both global-daemon and watchdog after install
- [ ] install.sh starts per-project daemon after install
- [ ] No modifications to daemon-manager.sh functions
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No syntax errors introduced
- Intentional daemon stops work cleanly (no auto-restart on exit 0)
- Services start immediately after installation
- Phase 18 complete — all 3 plans done
</success_criteria>

<output>
After completion, create `.planning/phases/18-daemon-lifecycle/18-03-SUMMARY.md`:

# Phase 18 Plan 03: Service Template Fixes + Auto-Start Summary

**[Substantive one-liner]**

## Accomplishments
## Files Created/Modified
## Decisions Made
## Issues Encountered
## Next Step

Phase 18 complete. v2.5 Architecture & Independence milestone complete.
</output>
