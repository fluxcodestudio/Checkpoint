---
phase: 16-backup-verification
plan: 02
type: execute
---

<objective>
Create the backup-verify CLI command and integrate verification into the dashboard and checkpoint command center.

Purpose: Expose the verification engine (from 16-01) to users via CLI command, TUI dashboard, and checkpoint subcommand.
Output: bin/backup-verify.sh CLI, working dashboard "Verify Backups" action, `checkpoint verify` subcommand
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-backup-verification/16-RESEARCH.md
@.planning/phases/16-backup-verification/16-01-SUMMARY.md

# Key source files (read before implementing):
@bin/backup-status.sh
@bin/checkpoint-dashboard.sh
@bin/checkpoint.sh
@bin/bootstrap.sh
@lib/features/verification.sh
@lib/core/output.sh

**Tech stack available:** bash 3.2+, dialog/whiptail (dashboard TUI)
**Established patterns:**
- CLI bootstrap: `source "$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"` then `source "$LIB_DIR/backup-lib.sh"`
- Arg parsing: while loop with case statement, OUTPUT_MODE variable
- Output modes: dashboard (default), json, compact
- Exit codes: 0=success, 1=warnings/failures, 2=cannot run
- Dashboard actions: show_msgbox for results, show_progress for loading (see existing action_* functions)
- Checkpoint subcommands: case statement in checkpoint.sh (--status, --dashboard, etc.)

**Constraining decisions:**
- Dashboard does NOT use jq — parse text/compact output, not JSON
- backup-verify.sh follows backup-status.sh as closest template
- Cloud verification is opt-in via --cloud flag (skipped by default)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bin/backup-verify.sh CLI command</name>
  <files>bin/backup-verify.sh</files>
  <action>
Create bin/backup-verify.sh following the backup-status.sh pattern exactly.

**Bootstrap (copy from backup-status.sh):**
```bash
#!/bin/bash
set -euo pipefail
source "$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"
source "$LIB_DIR/backup-lib.sh"
```

**Argument parsing:**
- `--json` — JSON output mode
- `--compact` — Single-line output mode
- `--full` — Full verification (hash checks, deep SQLite integrity). Default is quick mode.
- `--cloud` — Include cloud sync verification (skipped by default)
- `--help` / `-h` — Usage help
- First positional arg (optional): project directory (default: $PWD)
- Variable: `OUTPUT_MODE` (dashboard/json/compact), `VERIFY_MODE` (quick/full), `INCLUDE_CLOUD` (true/false)

**Help output:**
```
Checkpoint Backup Verification

Usage: backup-verify [OPTIONS] [PROJECT_DIR]

Options:
  --full          Full verification (SHA256 hashes + deep integrity)
  --cloud         Include cloud sync verification
  --json          Machine-readable JSON output
  --compact       Single-line summary output
  --help, -h      Show this help

Exit codes:
  0  All checks passed
  1  One or more checks failed
  2  Verification could not run (missing config, active backup)

Examples:
  backup-verify                    Quick verify current project
  backup-verify --full             Full integrity check with hashes
  backup-verify --json             JSON output for scripting
  backup-verify --full --cloud     Full check including cloud sync
  backup-verify /path/to/project   Verify specific project
```

**Main flow:**
1. Show help if --help
2. Load config: `load_backup_config "$PROJECT_DIR"` — exit 2 on failure with "No backup configuration found" message
3. Verify BACKUP_DIR exists — exit 2 if not
4. Check for active backup lock (if locked and PID alive, warn and exit 2)
5. Run verification:
   - If VERIFY_MODE=quick: call `verify_backup_quick "$BACKUP_DIR"`
   - If VERIFY_MODE=full: call `verify_backup_full "$BACKUP_DIR"`
   - If INCLUDE_CLOUD=true: call `verify_cloud_backup "$BACKUP_DIR"`
6. Generate report via `generate_verification_report` with appropriate output_mode
7. Save verification result to `$STATE_DIR/${PROJECT_NAME}/last-verification.json` (STATE_DIR from config, typically ~/.checkpoint/state)
8. Exit with appropriate code: 0 if all pass, 1 if any failures

**Make executable:** chmod +x

**Important:**
- Follow backup-status.sh's exact style for arg parsing, config loading, and error messages
- Use portable constructs only (Bash 3.2 compatible — `[ ]` not `[[ ]]` for simple tests, though `[[ ]]` is fine for string comparisons per existing codebase convention)
- STATE_DIR default: `${STATE_DIR:-$HOME/.checkpoint/state}`
- Create STATE_DIR/$PROJECT_NAME/ directory if it doesn't exist (`mkdir -p`)
  </action>
  <verify>
- `bash -n bin/backup-verify.sh` — syntax check passes
- `bin/backup-verify.sh --help` prints usage and exits 0
- `bin/backup-verify.sh --json` on a project with backups produces valid JSON
- `bin/backup-verify.sh` on a project with backups shows human-readable report
- `bin/backup-verify.sh /nonexistent/path` exits 2 with error message
  </verify>
  <done>
- backup-verify.sh exists, is executable, passes bash -n
- --help shows usage, --json outputs JSON, --compact outputs one line
- --full triggers hash verification, --cloud triggers rclone check
- Exit codes: 0 on pass, 1 on fail, 2 on cannot-run
- Saves last-verification.json to state directory
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard integration + checkpoint verify subcommand</name>
  <files>bin/checkpoint-dashboard.sh, bin/checkpoint.sh</files>
  <action>
**1. Implement action_verify_backups() in checkpoint-dashboard.sh:**

Replace the placeholder at ~line 430 with a working implementation. Follow existing action patterns (action_cleanup_backups, action_view_history).

Implementation:
- Show progress: `show_progress "Verifying backup integrity..."`
- Source verification.sh if not already loaded (it should be via backup-lib.sh, but defensive)
- Call `verify_backup_quick "$BACKUP_DIR"` (quick mode for dashboard — fast feedback)
- Build result display using existing dashboard UI functions (clear_screen + formatted echo, or show_msgbox)
- Format results for dialog box:
  ```
  Backup Verification Results
  ===========================

  Files
    Existence ......... PASS (47/47)
    Size match ........ PASS (47/47)

  Databases
    dev.db.gz ......... PASS (gzip OK, integrity OK)

  Result: ALL CHECKS PASSED
  ```
- If failures found, show failure details with error codes and suggestions
- Do NOT use --json output — dashboard parses direct function return values
- After showing results, offer "Run full verification?" option if dialog is available (optional enhancement — keep simple if complex)

**2. Add verify subcommand to checkpoint.sh:**

In the case statement at ~line 440, add before the `""` default case:

```bash
    verify|--verify)
        # Run backup verification
        if [ -f "$BIN_DIR/backup-verify.sh" ]; then
            shift
            exec "$BIN_DIR/backup-verify.sh" "$@"
        else
            echo "Error: backup-verify.sh not found" >&2
            exit 1
        fi
        ;;
```

Also update the --help output to include the verify subcommand:
```
  verify              Verify backup integrity
```

**Important:**
- Dashboard action should complete in seconds (quick mode only) — don't block UI
- Use show_msgbox (from dashboard-ui patterns) for result display
- checkpoint.sh's verify subcommand delegates to backup-verify.sh with all remaining args (shift + "$@")
- Test that `checkpoint verify --full` correctly passes --full to backup-verify.sh
  </action>
  <verify>
- `bash -n bin/checkpoint-dashboard.sh` — syntax check passes
- `bash -n bin/checkpoint.sh` — syntax check passes
- grep confirms action_verify_backups no longer contains "coming soon"
- grep confirms "verify" case exists in checkpoint.sh
- `checkpoint.sh --help` shows verify subcommand
  </verify>
  <done>
- action_verify_backups() shows real verification results (no more "coming soon")
- checkpoint.sh routes `verify` subcommand to backup-verify.sh
- checkpoint.sh --help lists verify command
- Both files pass bash -n syntax check
- Dashboard verification runs quick mode for fast feedback
- Phase 16 complete
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `bash -n bin/backup-verify.sh` passes
- [ ] `bash -n bin/checkpoint-dashboard.sh` passes
- [ ] `bash -n bin/checkpoint.sh` passes
- [ ] `backup-verify.sh --help` shows usage
- [ ] Dashboard "Verify Backups" shows real results
- [ ] `checkpoint verify` routes to backup-verify.sh
- [ ] All exit codes work correctly (0/1/2)
- [ ] Smoke test: `./tests/smoke-test.sh` still passes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No bash syntax errors introduced
- CLI follows backup-status.sh conventions exactly
- Dashboard placeholder replaced with working verification
- checkpoint.sh has verify subcommand
- Phase 16 complete — backup verification fully operational
</success_criteria>

<output>
After completion, create `.planning/phases/16-backup-verification/16-02-SUMMARY.md`
</output>
