---
phase: 22-checkpoint-diff
plan: 02
type: execute
---

<objective>
Create the `checkpoint diff` and `checkpoint history` CLI commands and wire them into the checkpoint.sh command router. Add unit tests for the core diff parsing functions.

Purpose: Give users a polished CLI experience for comparing their working directory against backups and browsing file version history.
Output: Working `checkpoint diff` and `checkpoint history` commands with --json support and unit tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-checkpoint-diff/22-RESEARCH.md
@.planning/phases/22-checkpoint-diff/22-01-SUMMARY.md

# Key source files:
@bin/checkpoint.sh
@lib/features/backup-diff.sh
@lib/features/backup-discovery.sh
@lib/features/cloud-destinations.sh
@lib/core/config.sh
@lib/platform/time-size-utils.sh
@tests/unit/test-scheduling.sh

**Tech stack available:** Pure bash, rsync, diff -u, find
**Established patterns:** checkpoint.sh case-statement routing, exec to standalone scripts, symlink resolution boilerplate, while/case arg parsing, --help/-h on all scripts
**Constraining decisions:**
- CLI convention: --help and -h required on all scripts
- Argument parsing: while loop with case statement
- Help format: cat <<EOF with USAGE, OPTIONS, EXAMPLES, EXIT CODES
- checkpoint.sh routes via `exec "$CHECKPOINT_LIB/bin/script.sh" "$@"`
- Test framework: tests/test-framework.sh with test_suite, test_case, assert_equals, assert_contains
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bin/checkpoint-diff.sh standalone command</name>
  <files>bin/checkpoint-diff.sh</files>
  <action>
Create `bin/checkpoint-diff.sh` — the standalone script for `checkpoint diff` and `checkpoint history` subcommands.

**Script structure:**
1. Standard shebang + header block + set -euo pipefail
2. Symlink resolution boilerplate (same pattern as other bin/ scripts)
3. Source required libraries:
   - `lib/core/config.sh` (for load_backup_config, get_backup_excludes)
   - `lib/platform/compat.sh` (for cross-platform helpers)
   - `lib/platform/time-size-utils.sh` (for format_bytes, format_relative_time)
   - `lib/features/backup-diff.sh` (for diff functions)
   - `lib/features/backup-discovery.sh` (for list_file_versions_sorted)
   - `lib/features/cloud-destinations.sh` (for resolve_backup_destinations)
4. Color definitions (same as other CLI scripts)
5. Argument parsing
6. Mode dispatch

**Subcommands/modes:**

**`checkpoint diff` (default, no file arg):**
- Load project config, resolve backup destinations
- Check FILES_DIR exists, error with helpful message if not
- Run compare_current_to_backup(PROJECT_DIR, FILES_DIR)
- Print with format_diff_text() or format_diff_json() based on --json flag
- Exit 0 if no changes, exit 0 with output if changes found

**`checkpoint diff <file>` (single file content diff):**
- Resolve file path relative to project root
- Check file exists in FILES_DIR backup
- Run `diff -u "$FILES_DIR/$file" "$PROJECT_DIR/$file"` with labels "backup" and "working"
- If --snapshot provided, diff against archived version using get_file_at_snapshot()
- Print diff output (users can pipe to delta/less)

**`checkpoint diff --snapshot <timestamp>` (backup at time vs current backup):**
- Validate timestamp format (YYYYMMDD or YYYYMMDD_HHMMSS, fuzzy match to closest snapshot)
- List available snapshots if timestamp doesn't match any
- Compare files/ state against reconstructed state at that time
- This is a stretch feature — if complex, print "Not yet implemented" and exit 0. Focus on current-vs-backup.

**`checkpoint history <file>`:**
- Resolve file path, load config, resolve destinations
- Call list_file_versions_sorted(file_path, FILES_DIR, ARCHIVED_DIR)
- Format output as table: version number, date, relative time, size, path
- Support --json for JSON output
- Support `--diff N` to show content diff between version N and current

**`checkpoint diff --list-snapshots`:**
- Call discover_snapshots(ARCHIVED_DIR)
- Print each timestamp with formatted date and relative time
- Support --json

**Arguments:**
```
--json              Output in JSON format
--snapshot TS       Compare current backup vs snapshot at timestamp
--list-snapshots    List available backup snapshots
--help, -h          Show help
```

**Help text format:** Follow existing convention with USAGE, OPTIONS, EXAMPLES sections. Examples:
```
checkpoint diff                          Show changes since last backup
checkpoint diff src/app.js               Show content diff for specific file
checkpoint diff --json                   JSON output for scripting
checkpoint diff --list-snapshots         List available snapshots
checkpoint history src/app.js            Show all versions of a file
```

**Error handling:**
- No config/backup dir: "No backup configuration found. Run 'checkpoint --project' to set up."
- File not in backup: "File 'X' not found in backup. It may not have been backed up yet."
- Empty diff: "No changes since last backup." (exit 0)
  </action>
  <verify>
1. `bash bin/checkpoint-diff.sh --help` shows help text without errors
2. `bash bin/checkpoint-diff.sh` in project root shows diff output (or "No changes")
3. `bash bin/checkpoint-diff.sh --json` outputs valid JSON
4. `bash bin/checkpoint-diff.sh --list-snapshots` shows available timestamps
5. `bash bin/checkpoint-diff.sh history bin/backup-now.sh` shows version list
  </verify>
  <done>
- checkpoint-diff.sh handles diff (default), diff <file>, history <file>, --list-snapshots modes
- --json flag works for all modes
- --help shows complete usage with examples
- Helpful error messages for missing config/backup/file
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire diff and history into checkpoint.sh routing</name>
  <files>bin/checkpoint.sh</files>
  <action>
Add `diff` and `history` subcommands to the case statement in checkpoint.sh (around line 582).

Add before the `""` (empty/default) case:

```bash
diff|--diff)
    if [[ -x "$CHECKPOINT_LIB/bin/checkpoint-diff.sh" ]]; then
        shift
        exec "$CHECKPOINT_LIB/bin/checkpoint-diff.sh" "$@"
    else
        echo "Error: checkpoint-diff.sh not found" >&2
        exit 1
    fi
    ;;
history)
    if [[ -x "$CHECKPOINT_LIB/bin/checkpoint-diff.sh" ]]; then
        shift
        exec "$CHECKPOINT_LIB/bin/checkpoint-diff.sh" "history" "$@"
    else
        echo "Error: checkpoint-diff.sh not found" >&2
        exit 1
    fi
    ;;
```

Also update the --help text to include:
```
echo "  diff                Compare working directory with backup"
echo "  history <file>      Show all versions of a file"
```

Pattern follows existing `verify|--verify` routing which does `shift; exec "$CHECKPOINT_LIB/bin/backup-verify.sh" "$@"`.
  </action>
  <verify>
1. `checkpoint diff` runs checkpoint-diff.sh
2. `checkpoint diff --json` passes --json to checkpoint-diff.sh
3. `checkpoint diff src/file.js` passes file arg correctly
4. `checkpoint history src/file.js` routes with "history" prepended
5. `checkpoint --help` shows diff and history in options list
  </verify>
  <done>
- `checkpoint diff` routes to checkpoint-diff.sh
- `checkpoint history` routes to checkpoint-diff.sh with "history" prefix
- --help updated with new subcommands
- Follows same pattern as verify subcommand
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for diff parsing and snapshot discovery</name>
  <files>tests/unit/test-diff.sh</files>
  <action>
Create `tests/unit/test-diff.sh` following the pattern from `tests/unit/test-scheduling.sh`.

**Test structure:**
```bash
#!/bin/bash
# shellcheck source=../test-framework.sh
source "$(dirname "$0")/../test-framework.sh"
test_suite "Diff Command"
```

**Test cases to cover:**

1. **extract_timestamp with PID suffix** — `extract_timestamp "app.js.20260216_043343_72545"` equals `20260216_043343`

2. **extract_timestamp without PID suffix** — `extract_timestamp "app.js.20260216_031101"` equals `20260216_031101` (the bug fix)

3. **extract_timestamp with database pattern** — `extract_timestamp "mydb_20260103_120000.db.gz"` equals `20260103_120000`

4. **extract_timestamp with no timestamp** — `extract_timestamp "README.md"` equals `""` (empty)

5. **discover_snapshots finds timestamps** — Create temp dir with mock archived files (both patterns), verify discover_snapshots returns expected timestamps sorted descending

6. **discover_snapshots empty dir** — Empty dir returns nothing (no error)

7. **get_backup_excludes returns patterns** — Output contains `--exclude=backups/` and `--exclude=.git/` and has 9 lines

8. **format_diff_json valid JSON** — Set DIFF_ADDED/MODIFIED/REMOVED arrays, call format_diff_json, pipe through `python3 -m json.tool` (or just check starts with `{` and contains expected keys)

**Setup/teardown:**
- Use `setup_test` to create temp directories with mock archived files
- Use `teardown_test` to clean up

**Source required libraries before tests:**
```bash
SCRIPT_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
source "$SCRIPT_DIR/lib/platform/compat.sh"
source "$SCRIPT_DIR/lib/platform/time-size-utils.sh"
source "$SCRIPT_DIR/lib/core/config.sh"
source "$SCRIPT_DIR/lib/retention-policy.sh"
source "$SCRIPT_DIR/lib/features/backup-diff.sh"
```
  </action>
  <verify>
1. `bash tests/unit/test-diff.sh` runs all tests and reports results
2. All test cases pass
3. No shellcheck errors in test file
  </verify>
  <done>
- tests/unit/test-diff.sh exists with 8+ test cases
- All tests pass covering: timestamp extraction (both patterns + database + none), snapshot discovery, excludes, JSON output
- Test follows existing test-framework.sh patterns
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `checkpoint diff` shows changes since last backup
- [ ] `checkpoint diff --json` outputs valid JSON
- [ ] `checkpoint diff --list-snapshots` lists available timestamps
- [ ] `checkpoint history bin/backup-now.sh` shows file versions
- [ ] `checkpoint --help` shows diff and history subcommands
- [ ] `bash tests/unit/test-diff.sh` passes all tests
- [ ] No shellcheck errors in new files
- [ ] No regressions in existing functionality
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- `checkpoint diff` and `checkpoint history` work end-to-end
- Unit tests pass with good coverage of parsing edge cases
- Phase 22 complete
</success_criteria>

<output>
After completion, create `.planning/phases/22-checkpoint-diff/22-02-SUMMARY.md`
</output>
