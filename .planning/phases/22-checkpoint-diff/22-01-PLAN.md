---
phase: 22-checkpoint-diff
plan: 01
type: execute
---

<objective>
Build the core diff library: fix the extract_timestamp() bug affecting 18% of archived files, centralize backup excludes so diff and backup always agree on scope, and create the backup-diff.sh library with snapshot discovery, rsync dry-run comparison, and restic-style output formatting.

Purpose: Establish the foundation functions that the CLI commands (Plan 02) will compose.
Output: Fixed retention-policy.sh, shared exclude function, and new lib/features/backup-diff.sh library.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-checkpoint-diff/22-RESEARCH.md

# Prior phase (directly affects this phase):
@.planning/phases/21-storage-warnings/21-02-SUMMARY.md

# Key source files:
@lib/retention-policy.sh
@lib/features/backup-discovery.sh
@lib/features/cloud-destinations.sh
@lib/core/config.sh
@lib/ops/file-ops.sh
@lib/platform/time-size-utils.sh
@bin/backup-now.sh

**Tech stack available:** Pure bash, rsync, find, diff, stat, shasum
**Established patterns:** Library include guard pattern, function documentation with Args/Returns/Sets, set -euo pipefail, conditional sourcing
**Constraining decisions:**
- Phase 21-02: Pre-flight gate check pattern in backup pipeline
- Phase 20-02: Config wiring pattern (BACKUP_SCHEDULE takes priority, empty default preserves backward compat)
- Key decision: Use $((var + 1)) not ((var++)) for set -e compat
- Key decision: BSD stat -f for mtime on macOS
- Key decision: Bash 3.2+ only — no associative arrays, no Bash 4+ parameter expansion
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix extract_timestamp() bug and centralize backup excludes</name>
  <files>lib/retention-policy.sh, lib/core/config.sh</files>
  <action>
**Fix extract_timestamp() in lib/retention-policy.sh (line 81):**

The current function only handles `.YYYYMMDD_HHMMSS_PID` and `_YYYYMMDD_HHMMSS.ext` patterns. It's missing `.YYYYMMDD_HHMMSS` (no PID) — used by backup-daemon.sh. 11 of 62 archived files in real data are affected.

Add a third pattern branch between the two existing ones:
```
# Pattern: name.ext.YYYYMMDD_HHMMSS (daemon backups, no PID)
elif [[ "$filename" =~ \.([0-9]{8}_[0-9]{6})$ ]]; then
    echo "${BASH_REMATCH[1]}"
```

Order matters: check with-PID first (more specific), then no-PID, then database pattern.

**Centralize backup excludes in lib/core/config.sh:**

Add a function `get_backup_excludes()` that returns the standard exclude list used by both backup-now.sh and the diff command. This prevents drift between what gets backed up and what gets diffed.

```bash
# Get standard backup exclude patterns for rsync
# Returns: newline-separated list of --exclude arguments
# Used by: backup-now.sh (fallback mode), backup-diff.sh
get_backup_excludes() {
    local excludes=(
        'backups/'
        '.git/'
        'node_modules/'
        '.venv/'
        '__pycache__/'
        'dist/'
        'build/'
        '.next/'
        '.DS_Store'
    )
    local e
    for e in "${excludes[@]}"; do
        echo "--exclude=$e"
    done
}
```

Do NOT refactor backup-now.sh to use this function yet — that's a separate concern and would expand blast radius. The diff command will use it from day one; backup-now.sh can adopt it later.
  </action>
  <verify>
1. Source lib/retention-policy.sh and test extract_timestamp with both patterns:
   - `extract_timestamp "app.js.20260216_043343_72545"` → `20260216_043343`
   - `extract_timestamp "app.js.20260216_031101"` → `20260216_031101`
   - `extract_timestamp "mydb_20260103_120000.db.gz"` → `20260103_120000`
2. Source lib/core/config.sh and test: `get_backup_excludes | head -3` returns `--exclude=backups/` etc.
3. Existing tests still pass (retention logic unchanged for files it already handled)
  </verify>
  <done>
- extract_timestamp() handles both `.YYYYMMDD_HHMMSS_PID` and `.YYYYMMDD_HHMMSS` patterns
- get_backup_excludes() function exists in config.sh and returns 9 exclude patterns
- No regressions in existing retention behavior
  </done>
</task>

<task type="auto">
  <name>Task 2: Create backup-diff.sh library with core diff functions</name>
  <files>lib/features/backup-diff.sh</files>
  <action>
Create `lib/features/backup-diff.sh` following existing library patterns (include guard, header block, function documentation).

**Required functions:**

1. `discover_snapshots(archived_dir)` — Extract unique backup timestamps from archived/ file suffixes. Must handle both PID and no-PID patterns. Returns newline-separated timestamps (YYYYMMDD_HHMMSS), most recent first. Use `find + sed + sort -u -r`.

2. `compare_current_to_backup(project_dir, files_dir)` — Run `rsync --archive --no-links --dry-run --delete --itemize-changes --out-format="%i %n"` with excludes from `get_backup_excludes()`. Parse output:
   - `>f++++++++` lines → added files (`+`)
   - Other `>f` lines → modified files (`M`)
   - `*deleting` lines → removed files (`-`)
   - Ignore `.d` (directory) and other non-file lines
   Sets global arrays: `DIFF_ADDED=()`, `DIFF_MODIFIED=()`, `DIFF_REMOVED=()` (bash can't return arrays from functions).

3. `format_diff_text()` — Print restic-style output from the DIFF_* arrays:
   ```
   +  src/new-feature.js
   -  src/old-module.js
   M  src/app.js

   Files: 1 new, 1 removed, 1 modified
   ```
   Print added first, then removed, then modified. End with summary line.

4. `format_diff_json()` — Print JSON output from DIFF_* arrays:
   ```json
   {"added":["src/new.js"],"removed":["src/old.js"],"modified":["src/app.js"],"summary":{"added":1,"removed":1,"modified":1}}
   ```
   Use printf for JSON construction (no jq dependency).

5. `get_file_at_snapshot(file_path, target_timestamp, files_dir, archived_dir)` — Reconstruct which version of a file existed at a given snapshot time. Find archived version closest to but not after target timestamp. Return path to the version file, or return 1 if file didn't exist.

**Implementation notes:**
- Source dependencies: `_CHECKPOINT_LIB_DIR` for loading config.sh (for get_backup_excludes)
- Follow include guard pattern: `[ -n "${_CHECKPOINT_BACKUP_DIFF:-}" ] && return || readonly _CHECKPOINT_BACKUP_DIFF=1`
- Use `local` for all function variables
- No Bash 4+ features (no associative arrays)
- Global arrays DIFF_ADDED, DIFF_MODIFIED, DIFF_REMOVED are the interface (bash limitation — functions can't return arrays)
- Handle missing directories gracefully (return 1 with no output)
  </action>
  <verify>
1. Source the library without errors: `source lib/features/backup-diff.sh`
2. Test discover_snapshots against real archived/ dir: should return 10+ unique timestamps
3. Test compare_current_to_backup against real project: should populate DIFF_* arrays
4. Test format_diff_text: should print +/-/M indicators with summary
5. Test format_diff_json: should print valid JSON (pipe through `python3 -m json.tool` to validate)
  </verify>
  <done>
- lib/features/backup-diff.sh exists with include guard and all 5 functions
- discover_snapshots returns unique timestamps from archived/
- compare_current_to_backup parses rsync dry-run output into DIFF_* arrays
- format_diff_text prints restic-style +/-/M output with summary
- format_diff_json prints valid JSON
- get_file_at_snapshot locates correct version at a given time
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `source lib/retention-policy.sh` — no errors
- [ ] `source lib/features/backup-diff.sh` — no errors
- [ ] extract_timestamp handles both timestamp suffix patterns
- [ ] get_backup_excludes returns 9 patterns
- [ ] discover_snapshots finds real snapshots in archived/
- [ ] compare_current_to_backup produces non-empty DIFF_* arrays
- [ ] format_diff_json output is valid JSON
- [ ] No shellcheck errors in new/modified files
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors in existing tests (retention-policy.sh change is backward compatible)
- Library functions ready for CLI wiring in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/22-checkpoint-diff/22-01-SUMMARY.md`
</output>
