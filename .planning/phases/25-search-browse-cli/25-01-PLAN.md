---
phase: 25-search-browse-cli
plan: 01
type: execute
---

<objective>
Create checkpoint-search.sh CLI with search and browse commands for exploring backups interactively.

Purpose: Give developers a fast way to find files across backup snapshots (search) and interactively explore snapshot contents (browse) — completing the Checkpoint CLI toolkit.
Output: Working `checkpoint search` and `checkpoint browse` commands with fzf interactive mode and bash select fallback.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-search-browse-cli/25-RESEARCH.md

# Key source files to reference:
@bin/checkpoint-diff.sh
@lib/features/backup-discovery.sh
@lib/features/backup-diff.sh
@bin/bootstrap.sh

# Auto-selected based on dependency graph:
@.planning/phases/22-checkpoint-diff/22-02-SUMMARY.md
@.planning/phases/23-encryption-at-rest/23-03-SUMMARY.md

**Tech stack available:** fzf (optional, with bash select fallback), grep/ripgrep, diff
**Established patterns:** bootstrap.sh sourcing, backup-lib.sh module loader, subcommand routing with mode dispatch, .age suffix handling throughout discovery/diff
**Constraining decisions:**
- [Phase 22]: Used bootstrap.sh + backup-lib.sh module loader for all bin/ scripts
- [Phase 23]: .age suffix stripping in all discovery/diff paths — must handle encrypted files in search/browse
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create checkpoint-search.sh with search mode</name>
  <files>bin/checkpoint-search.sh</files>
  <action>
Create bin/checkpoint-search.sh following the established bin/ script pattern:
- Shebang: `#!/usr/bin/env bash` with `set -euo pipefail`
- Bootstrap: `source "$(dirname "${BASH_SOURCE[0]}")/bootstrap.sh"` then `source "$LIB_DIR/backup-lib.sh"` and `source "$LIB_DIR/retention-policy.sh"` and `source "$LIB_DIR/features/backup-diff.sh"` and `source "$LIB_DIR/features/backup-discovery.sh"`
- Color detection: same TTY-conditional pattern as checkpoint-diff.sh
- Help text: USAGE, OPTIONS, EXAMPLES, EXIT CODES sections via `cat <<EOF`
- Argument parsing: while+case loop

**Modes:** search (default), browse

**Search mode (`checkpoint search <pattern>`):**
- Default: search file PATHS in archived/ directory matching pattern (fast, uses find)
- `--content` flag: grep file CONTENTS (slower, skip .age files by default, warn about encrypted files)
- `--decrypt` flag: when combined with --content, decrypt .age files to temp before grepping (source encryption.sh, use decrypt_file)
- `--since YYYYMMDD` / `--last N`: filter results by date range (compare extracted timestamps)
- `--json` flag: output as JSON array of objects `{path, timestamp, size, encrypted}`
- `--plain` flag: one path per line, no color (for piping)
- Default (TTY): colored table output with path, timestamp, relative time, size
- Limit: default --limit 50 results for non-interactive; show "N more results, use --limit 0 for all"
- If fzf available AND stdout is TTY AND not --json/--plain: pipe results into fzf with preview showing file content (cat or decrypt+cat for .age)
- If fzf NOT available: print table output

**Search helper function `search_backup_paths()`:**
- Args: pattern, archived_dir, since_ts (optional), limit
- Uses find with -name "*pattern*" to match paths
- Extracts timestamp from each result using sed pattern from discover_snapshots (handle .age suffix)
- Filters by --since/--last if specified
- Returns pipe-delimited: `timestamp|size_human|relative|encrypted|relpath|fullpath`

**Search helper function `search_backup_content()`:**
- Args: pattern, archived_dir, decrypt_flag, since_ts (optional), limit
- Uses `grep -rl` (or `rg -l` if available) with --exclude='*.age' by default
- If decrypt_flag: also search .age files by decrypting to temp, grep, cleanup
- Same output format as search_backup_paths

**Important:** Use `format_relative_time` and `format_bytes` from existing libs (loaded via backup-lib.sh). Use `get_file_mtime` and `get_file_size` from core/file-ops.sh (loaded via backup-lib.sh). Handle Bash 3.2 compatibility — no associative arrays, use $((x + 1)) not ((x++)).

Make script executable: chmod +x.
  </action>
  <verify>bash -n bin/checkpoint-search.sh (syntax check passes), chmod +x confirmed, bin/checkpoint-search.sh --help shows usage</verify>
  <done>checkpoint-search.sh exists, is executable, passes syntax check, shows help text, search mode with path/content search works with --json/--plain/--limit/--since flags</done>
</task>

<task type="auto">
  <name>Task 2: Add browse mode to checkpoint-search.sh</name>
  <files>bin/checkpoint-search.sh</files>
  <action>
Add browse mode to the existing checkpoint-search.sh.

**Browse mode (`checkpoint browse`):**

Implements two-level snapshot explorer: Level 1 = select snapshot, Level 2 = browse files in that snapshot.

**Helper function `list_files_at_snapshot()`:**
- Args: archived_dir, timestamp
- Find all files matching `*.TIMESTAMP*` pattern (with or without _PID suffix, with or without .age suffix)
- For each file: extract original filename (strip timestamp+pid+.age suffixes), get size, check if encrypted
- Output pipe-delimited: `original_relpath|size_human|encrypted_flag|full_path`
- Sort output by original_relpath

**Browse flow (fzf available):**
1. Call `discover_snapshots "$ARCHIVED_DIR"` to get timestamps
2. Format each timestamp as "YYYY-MM-DD HH:MM:SS (relative_time)" with tab-delimited raw timestamp
3. Pipe into fzf:
   - `--prompt "Select snapshot > "`
   - `--header "ENTER: browse files | ESC: quit"`
   - Preview: count of files at that snapshot (`find "$ARCHIVED_DIR" -name "*{timestamp}*" | wc -l`)
   - `--delimiter '\t'` with `--with-nth 1` to show formatted date, extract raw timestamp from selection
4. On selection: call `list_files_at_snapshot` for chosen timestamp
5. Pipe file list into second fzf:
   - `--prompt "Files > "`
   - `--header "ENTER: view | CTRL-D: diff vs current | ESC: back"`
   - Preview: `cat {4}` (full_path field) for unencrypted, or "Encrypted file — use --decrypt to view" for .age files
   - `--delimiter '|'` with `--with-nth 1,2,3` to show filename, size, encrypted status
6. On file selection: output the full path

**Browse flow (no fzf — select fallback):**
1. Get snapshots, format with numbers
2. Use bash `select` for snapshot selection (with `PS3` prompt)
3. On selection: list files at that snapshot in table format
4. Use bash `select` for file selection
5. On selection: output the full path

**Browse flags:**
- `--json`: skip interactive, output all snapshots as JSON with file counts
- No TARGET_FILE needed for browse (it's always project-wide)

**Important:** Chain two separate fzf calls (not fzf reload) — simpler, more maintainable, and the research concluded this works well for 2 levels. For the select fallback, limit displayed items to 50 with a "more available" note.
  </action>
  <verify>bash -n bin/checkpoint-search.sh (syntax check passes), bin/checkpoint-search.sh browse --help shows browse usage</verify>
  <done>Browse mode works with both fzf (two-level drill-down) and select fallback; --json flag outputs snapshot listing; list_files_at_snapshot() correctly extracts original filenames from archived paths</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/checkpoint-search.sh` passes (no syntax errors)
- [ ] `bin/checkpoint-search.sh --help` shows comprehensive help
- [ ] `bin/checkpoint-search.sh search --help` or default shows search usage
- [ ] `bin/checkpoint-search.sh browse --json` produces valid JSON snapshot listing
- [ ] Script handles missing backup dir gracefully (informative error message)
- [ ] No Bash 4+ features used (no associative arrays, no ${var,,})
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- checkpoint-search.sh is executable and syntax-valid
- Search mode handles path and content search with proper filtering
- Browse mode provides two-level interactive exploration
- Graceful fallback when fzf not available
- Encrypted .age files handled correctly (skipped in content search by default, flagged in browse)
</success_criteria>

<output>
After completion, create `.planning/phases/25-search-browse-cli/25-01-SUMMARY.md`
</output>
