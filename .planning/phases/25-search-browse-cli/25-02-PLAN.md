---
phase: 25-search-browse-cli
plan: 02
type: execute
---

<objective>
Add interactive fzf mode to existing history command and wire search/browse into checkpoint.sh routing.

Purpose: Complete the search/browse CLI by connecting it to the main checkpoint command router and upgrading the existing history command with interactive file version browsing.
Output: `checkpoint search`, `checkpoint browse` routed through checkpoint.sh; `checkpoint history <file> --interactive` launches fzf version picker with diff preview.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-search-browse-cli/25-RESEARCH.md

# Key source files:
@bin/checkpoint-diff.sh
@bin/checkpoint.sh
@bin/checkpoint-search.sh
@lib/features/backup-discovery.sh

# Prior plan in this phase:
@.planning/phases/25-search-browse-cli/25-01-SUMMARY.md

**Established patterns:** Subcommand routing in checkpoint.sh case statement, bootstrap.sh + backup-lib.sh loading
**Constraining decisions:**
- [Phase 22]: history routes through checkpoint-diff.sh with "history" prefix
- [Phase 22]: checkpoint-diff.sh uses bootstrap.sh + backup-lib.sh pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --interactive fzf mode to checkpoint-diff.sh history</name>
  <files>bin/checkpoint-diff.sh</files>
  <action>
Add `--interactive` / `-i` flag to checkpoint-diff.sh that, when used with history mode, launches an fzf-powered version picker.

**Argument parsing changes:**
- Add `INTERACTIVE=false` variable
- Add case for `--interactive|-i` that sets `INTERACTIVE=true`

**History mode changes (in the `MODE == "history"` block):**
When INTERACTIVE is true AND fzf is available AND stdout is TTY:

1. Collect versions from `list_file_versions_sorted` (already done in existing code)
2. Format each version as tab-delimited: `num\tversion_label\tdate\trelative\tsize\tpath`
3. Pipe into fzf:
   - `--prompt "Version > "`
   - `--header "ENTER: view diff vs current | CTRL-C: cancel"`
   - `--header-first`
   - `--delimiter '\t'`
   - `--with-nth 1,2,3,4,5` (show all fields except raw path)
   - `--ansi`
   - Preview: `diff --color=always "$PROJECT_DIR/$TARGET_FILE" {6} 2>/dev/null || cat {6}` — shows diff between current working file and the selected version. If current file doesn't exist, just cat the backup version.
   - `--preview-window "right:60%:wrap"`
4. On selection: print the selected version path and run `diff -u --label "current" --label "version {2}" "$PROJECT_DIR/$TARGET_FILE" {selected_path}`

**Fallback:** If --interactive but fzf not available, print warning "fzf not installed — showing table output instead. Install fzf for interactive browsing." and fall through to normal table output.

**Update help text:** Add `--interactive, -i` to OPTIONS and add example: `checkpoint history src/app.js --interactive`

**Important:** Do NOT restructure the existing history output code. Add the interactive block as an early return BEFORE the existing JSON/table output block, guarded by `if [[ "$INTERACTIVE" == "true" ]]`.
  </action>
  <verify>bash -n bin/checkpoint-diff.sh (syntax check), checkpoint-diff.sh --help shows --interactive flag</verify>
  <done>--interactive flag recognized in history mode, launches fzf with version picker and diff preview when fzf available, graceful fallback message when fzf not available</done>
</task>

<task type="auto">
  <name>Task 2: Wire search and browse into checkpoint.sh routing</name>
  <files>bin/checkpoint.sh</files>
  <action>
Add routing for search and browse commands in checkpoint.sh's main case statement.

**Add before the `--dashboard` case (around line 673):**

```bash
search|--search)
    # Search across backup snapshots
    if [[ -x "$CHECKPOINT_LIB/bin/checkpoint-search.sh" ]]; then
        shift
        exec "$CHECKPOINT_LIB/bin/checkpoint-search.sh" "$@"
    else
        echo "Error: checkpoint-search.sh not found" >&2
        exit 1
    fi
    ;;
browse|--browse)
    # Interactive backup snapshot browser
    if [[ -x "$CHECKPOINT_LIB/bin/checkpoint-search.sh" ]]; then
        shift
        exec "$CHECKPOINT_LIB/bin/checkpoint-search.sh" "browse" "$@"
    else
        echo "Error: checkpoint-search.sh not found" >&2
        exit 1
    fi
    ;;
```

**Update help text** in the `--help|-h` case to include:
```
  search <pattern>    Search backup file paths and content
  browse              Interactive backup snapshot browser
  history <file> -i   Interactive file version browser (fzf)
```

Update the `history <file>` line to mention `-i` flag.
  </action>
  <verify>bash -n bin/checkpoint.sh (syntax check passes), checkpoint --help shows search/browse/history -i entries</verify>
  <done>checkpoint search routes to checkpoint-search.sh, checkpoint browse routes to checkpoint-search.sh browse, help text updated with all new commands</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/checkpoint-diff.sh` passes
- [ ] `bash -n bin/checkpoint.sh` passes
- [ ] `checkpoint --help` shows search, browse, and updated history entries
- [ ] `checkpoint search --help` works (routes correctly)
- [ ] `checkpoint browse --help` works (routes correctly)
- [ ] `checkpoint history --help` shows --interactive flag
- [ ] Phase 25 complete — all search/browse/history interactive features working
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No syntax errors in modified files
- Routing works for search, browse, and history --interactive
- Help text is comprehensive and consistent
- Phase 25: Backup Search & Browse CLI fully complete
</success_criteria>

<output>
After completion, create `.planning/phases/25-search-browse-cli/25-02-SUMMARY.md`:

# Phase 25 Plan 02: History Interactive + Routing Summary

**[Substantive one-liner]**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Step

Phase 25 complete. v3.0 milestone complete — all 7 phases (19-25) delivered.
</output>
