---
phase: 23-encryption-at-rest
plan: 02
type: execute
---

<objective>
Integrate encryption into the backup pipeline — encrypt files and databases when syncing to cloud destinations.

Purpose: Cloud-destined backups get encrypted transparently during the normal backup cycle.
Output: Modified backup-now.sh that encrypts cloud folder copies when encryption is enabled.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-encryption-at-rest/23-RESEARCH.md
@.planning/phases/23-encryption-at-rest/23-01-SUMMARY.md

# Key source files:
@bin/backup-now.sh
@lib/features/encryption.sh
@lib/features/cloud-destinations.sh

**From RESEARCH.md architecture:**
- Cloud folder sync section in backup-now.sh (~line 1540-1599) does rsync to CLOUD_FOLDER_PATH
- Databases: rsync -a --delete DATABASE_DIR/ → CLOUD_FOLDER_PATH/PROJECT_NAME/databases/
- Files: rsync -a with filters → CLOUD_FOLDER_PATH/PROJECT_NAME/files/
- State file: cp to CLOUD_FOLDER_PATH/PROJECT_NAME/.checkpoint-state.json
- Encryption happens AFTER rsync to cloud destination (post-rsync encrypt pass)
- Only encrypt files that actually changed (don't re-encrypt unchanged .age files)
- Nondeterministic age output means full re-encryption of unchanged files wastes bandwidth
- Databases: chain gzip | age for cloud copies OR encrypt the already-gzipped file

**Anti-patterns to avoid:**
- Do NOT encrypt local backups (PRIMARY_BACKUP_DIR when local)
- Do NOT encrypt-then-compress (compress-then-encrypt only)
- Do NOT re-encrypt files that haven't changed since last backup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add encryption to cloud folder database sync</name>
  <files>bin/backup-now.sh</files>
  <action>
In the CLOUD FOLDER SYNC section (~line 1545-1599), modify the database sync block:

After the existing rsync of DATABASE_DIR to cloud databases folder succeeds, add an encryption pass:

```bash
# Encrypt cloud database backups if encryption enabled
if encryption_enabled 2>/dev/null; then
    local cloud_db_dir="$CLOUD_FOLDER_PATH/$PROJECT_NAME/databases"
    local age_recipient
    age_recipient="$(get_age_recipient)"
    if [[ -n "$age_recipient" ]]; then
        # Encrypt any unencrypted .db.gz files
        while IFS= read -r -d '' db_file; do
            if [[ ! -f "${db_file}.age" ]] || [[ "$db_file" -nt "${db_file}.age" ]]; then
                if age -r "$age_recipient" "$db_file" -o "${db_file}.age" 2>>"${_CHECKPOINT_LOG_FILE:-/dev/null}"; then
                    rm "$db_file"
                else
                    log_warn "Encryption failed for: $db_file"
                fi
            fi
        done < <(find "$cloud_db_dir" -name "*.db.gz" ! -name "*.age" -print0 2>/dev/null)
        cli_info "   Databases encrypted"
    fi
fi
```

Key considerations:
- Use `find -print0` + `read -d ''` for safe filename handling
- Only encrypt files where .age version doesn't exist or source is newer (-nt)
- Remove unencrypted original after successful encryption
- Log failures but don't abort the backup (warn only)
- Guard with `encryption_enabled` which checks all prerequisites
  </action>
  <verify>
bash -n bin/backup-now.sh — syntax check passes.
grep -c "encryption_enabled\|encrypt.*cloud\|\.age" bin/backup-now.sh — shows encryption integration points.
  </verify>
  <done>Cloud database backups encrypted with .age extension when encryption enabled. Unencrypted originals removed from cloud destination.</done>
</task>

<task type="auto">
  <name>Task 2: Add encryption to cloud folder file sync + status display</name>
  <files>bin/backup-now.sh</files>
  <action>
1. In the CLOUD FOLDER SYNC section, after the existing rsync of FILES_DIR to cloud files folder succeeds, add encryption pass:

```bash
# Encrypt cloud file backups if encryption enabled
if encryption_enabled 2>/dev/null; then
    local cloud_files_dir="$CLOUD_FOLDER_PATH/$PROJECT_NAME/files"
    local age_recipient
    age_recipient="$(get_age_recipient)"
    if [[ -n "$age_recipient" ]]; then
        local encrypted_count=0
        while IFS= read -r -d '' src_file; do
            if [[ ! -f "${src_file}.age" ]] || [[ "$src_file" -nt "${src_file}.age" ]]; then
                if age -r "$age_recipient" "$src_file" -o "${src_file}.age" 2>>"${_CHECKPOINT_LOG_FILE:-/dev/null}"; then
                    rm "$src_file"
                    encrypted_count=$((encrypted_count + 1))
                else
                    log_warn "Encryption failed for: $src_file"
                fi
            fi
        done < <(find "$cloud_files_dir" -type f ! -name "*.age" -print0 2>/dev/null)
        if [[ $encrypted_count -gt 0 ]]; then
            cli_info "   Files encrypted ($encrypted_count files)"
        fi
    fi
fi
```

Same pattern as database encryption — encrypt after rsync, only changed files, remove unencrypted originals.

2. In the backup summary section (near the end of backup-now.sh where it prints summary stats), add encryption indicator if enabled:

```bash
if encryption_enabled 2>/dev/null; then
    cli_info "   Encryption: enabled (cloud backups)"
fi
```

3. Source the encryption library early in backup-now.sh. The bootstrap.sh + backup-lib.sh module loader should handle this if encryption.sh follows the standard lib/features/ pattern. If not auto-loaded, add conditional source after the other feature library loads:

```bash
if [ -f "$LIB_DIR/features/encryption.sh" ]; then
    source "$LIB_DIR/features/encryption.sh"
fi
```

Verify whether backup-lib.sh's module loader auto-sources lib/features/*.sh. If yes, no manual source needed. If no, add the conditional source.
  </action>
  <verify>
bash -n bin/backup-now.sh — syntax check passes.
grep -c "encrypt" bin/backup-now.sh — shows all encryption integration points (expect 10+).
  </verify>
  <done>Cloud file backups encrypted. Backup summary shows encryption status. Encryption library loaded in backup pipeline.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/backup-now.sh` passes
- [ ] Cloud database sync section has encryption post-pass
- [ ] Cloud file sync section has encryption post-pass
- [ ] Encryption only triggers when `encryption_enabled` returns 0
- [ ] Unencrypted originals removed from cloud destination after successful encryption
- [ ] Summary shows encryption status
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No syntax errors in backup-now.sh
- Encryption is opt-in (off by default, only activates when ENCRYPTION_ENABLED=true + key exists + age installed)
- Local backups untouched
- Cloud backups get .age extension
</success_criteria>

<output>
After completion, create `.planning/phases/23-encryption-at-rest/23-02-SUMMARY.md`
</output>
