---
phase: 14-security-hardening
plan: 01
type: execute
---

<objective>
Create secure download library and replace all curl|bash rclone installation patterns with download-verify-execute.

Purpose: Eliminate the highest-priority security vulnerability — 3 instances of `curl|bash` (including one `curl|sudo bash`) that enable MITM, truncation, and supply chain attacks during rclone installation.
Output: New `lib/security/secure-download.sh` module + all rclone install sites migrated to secure pattern.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research findings:
@.planning/phases/14-security-hardening/14-RESEARCH.md

# Prior phase context (Phase 13 directly affects Phase 14):
@.planning/phases/13-native-file-watcher/13-04-SUMMARY.md

# Key source files to modify:
@lib/backup-lib.sh
@lib/ops/file-ops.sh
@lib/dependency-manager.sh
@lib/cloud-backup.sh
@bin/backup-cloud-config.sh

**Tech stack available:** modular bash library (core/, ops/, ui/, features/, platform/), include guards, bootstrap.sh pattern
**Established patterns:** include-guard-pattern, module-header-template, lib-dir-resolution, cross-platform shasum -a 256
**Constraining decisions:**
- Phase 11: Module loader pattern — new modules use include guards, `_CHECKPOINT_LIB_DIR` resolution
- Phase 11: file-ops.sh already has `shasum -a 256` cross-platform SHA256
- Phase 12: bootstrap.sh provides SCRIPT_DIR/LIB_DIR exports
- Research: SHA256 only (no GPG) for v1. Keep function signature `install_rclone()` for backward compat.
- Research: rclone publishes SHA256SUMS at predictable URLs (GPG clearsigned — strip signature before parsing)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/security/secure-download.sh module</name>
  <files>lib/security/secure-download.sh</files>
  <action>
Create new security module following established module patterns (include guard, module header with @requires/@provides).

Functions to implement:

1. `compute_sha256()` — Cross-platform SHA256 wrapper. Try `shasum -a 256` first (macOS), fall back to `sha256sum` (Linux). Accept file path arg, output hash to stdout. Return 1 on failure.

2. `download_and_verify()` — Download file + verify SHA256 checksum.
   Args: $1=url, $2=expected_hash, $3=output_path
   - Download to temp file with `curl -fsSL`
   - Compute SHA256 via `compute_sha256()`
   - Compare against expected_hash
   - On match: mv to output_path, return 0
   - On mismatch: log "SECURITY: Hash mismatch" with expected/actual, rm temp, return 1
   - Use mktemp for temp file, trap cleanup on failure

3. `download_with_checksums()` — Download file + fetch checksums file + verify.
   Args: $1=file_url, $2=checksums_url, $3=output_path, $4=filename_in_checksums
   - Download both file and checksums to temp dir
   - Strip GPG clearsigned wrapper from checksums file if present (sed to remove lines between `-----BEGIN PGP` and `-----END PGP`, plus `Hash:` header line)
   - Extract expected hash by grepping for filename_in_checksums
   - Delegate to `download_and_verify()` logic
   - Return 1 if checksums file can't be fetched or hash not found (with clear error messages)

4. `secure_install_rclone()` — Replace curl|bash rclone installation.
   - Detect platform: `uname -s` → darwin/linux
   - Detect arch: `uname -m` → amd64/arm64 (map x86_64→amd64, aarch64/arm64→arm64)
   - Map platform: Darwin→osx, Linux→linux
   - Construct URLs using rclone's "current" symlink:
     - Binary: `https://downloads.rclone.org/current/rclone-current-{platform}-{arch}.zip`
     - Checksums: `https://downloads.rclone.org/current/SHA256SUMS`
   - Download and verify via `download_with_checksums()`
   - Extract zip to temp dir
   - Find rclone binary in extracted contents
   - Copy to appropriate location:
     - If `sudo` available and user consents: `/usr/local/bin/rclone`
     - Otherwise: `$HOME/.local/bin/rclone` (create dir if needed, warn about PATH)
   - chmod +x the binary
   - Verify with `rclone version`
   - Clean up temp dir via trap

Include module header:
```
# @requires: none (standalone security module)
# @provides: compute_sha256, download_and_verify, download_with_checksums, secure_install_rclone
```

Do NOT add this module to backup-lib.sh loader — it's standalone like lib/platform/file-watcher.sh (loaded on-demand by scripts that need it).
  </action>
  <verify>
    - File exists at lib/security/secure-download.sh
    - bash -n lib/security/secure-download.sh passes (syntax check)
    - Module has include guard pattern
    - compute_sha256 function exists and works: `source lib/security/secure-download.sh && echo "test" > /tmp/test-hash && compute_sha256 /tmp/test-hash && rm /tmp/test-hash`
  </verify>
  <done>lib/security/secure-download.sh exists with 4 functions, passes syntax check, include guard present, compute_sha256 produces valid SHA256 output</done>
</task>

<task type="auto">
  <name>Task 2: Replace all curl|bash rclone patterns with secure installer</name>
  <files>lib/dependency-manager.sh, lib/cloud-backup.sh, bin/backup-cloud-config.sh</files>
  <action>
Replace all 3 active `curl|bash` rclone installation patterns:

**lib/dependency-manager.sh (~line 273, 284):**
- Add `source "$_CHECKPOINT_LIB_DIR/security/secure-download.sh"` at top (after include guard, using the existing `_CHECKPOINT_LIB_DIR` or computing it)
- Replace the `install_rclone()` function body:
  - Keep Homebrew path for macOS (safe — package manager has its own verification)
  - Replace `curl https://rclone.org/install.sh | bash` (line 273) with `secure_install_rclone`
  - Replace `curl https://rclone.org/install.sh | sudo bash` (line 284) with `secure_install_rclone`
- Update the manual install suggestion (line 250) from `curl https://rclone.org/install.sh | sudo bash` to `Visit https://rclone.org/install/ for platform-specific instructions`

**lib/cloud-backup.sh (~line 34-47):**
- Source secure-download.sh at function level (inside install_rclone, to avoid loading for all cloud-backup operations)
- Replace `curl https://rclone.org/install.sh | bash` (lines 42, 46) with calls to `secure_install_rclone`
- Keep Homebrew path for macOS

**bin/backup-cloud-config.sh (~line 136):**
- Replace the fallback message `"curl https://rclone.org/install.sh | bash"` with `"Visit https://rclone.org/install/ for instructions"`

Ensure the function signature `install_rclone()` is preserved in both files — callers don't need to change.
  </action>
  <verify>
    - `grep -r 'curl.*rclone.org/install.sh.*|.*bash' lib/ bin/` returns NO results
    - `grep -r 'secure_install_rclone\|secure-download.sh' lib/ bin/` shows the new references
    - bash -n lib/dependency-manager.sh passes
    - bash -n lib/cloud-backup.sh passes
    - bash -n bin/backup-cloud-config.sh passes
  </verify>
  <done>Zero instances of curl|bash for rclone in codebase. All 3 files use secure_install_rclone(). All pass syntax check.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `grep -r 'curl.*|.*bash' lib/ bin/` returns only the direnv install suggestion (which is an echo for user reference, not executed code)
- [ ] `bash -n lib/security/secure-download.sh` passes
- [ ] `bash -n lib/dependency-manager.sh` passes
- [ ] `bash -n lib/cloud-backup.sh` passes
- [ ] `bash -n bin/backup-cloud-config.sh` passes
- [ ] lib/security/secure-download.sh has include guard
</verification>

<success_criteria>

- lib/security/secure-download.sh created with download-verify-execute pattern
- All 3 curl|bash rclone installations replaced with secure_install_rclone()
- Homebrew path preserved (already safe)
- Manual install suggestions updated to website URL
- All modified files pass bash syntax check
- No new dependencies introduced
</success_criteria>

<output>
After completion, create `.planning/phases/14-security-hardening/14-01-SUMMARY.md`
</output>
