---
phase: 01-cloud-destination
plan: 01
type: execute
---

<objective>
Detect cloud-synced folder locations and add configuration options for cloud destination backup.

Purpose: Enable automatic cloud backup by writing to Dropbox/GDrive/iCloud/OneDrive local folders that sync automatically.
Output: Cloud folder detection library and updated config template.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Existing patterns:**
- Library functions in `lib/*.sh`
- Config template in `templates/backup-config.sh`
- Detection pattern from `lib/database-detector.sh`

**Key files:**
@lib/cloud-backup.sh (existing rclone-based cloud backup)
@templates/backup-config.sh (config template)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cloud folder detection library</name>
  <files>lib/cloud-folder-detector.sh</files>
  <action>
Create `lib/cloud-folder-detector.sh` with functions to detect cloud-synced folders on macOS:

1. `detect_dropbox_folder()` - Check standard paths:
   - `$HOME/Dropbox`
   - `$HOME/Library/CloudStorage/Dropbox`
   - Parse `~/.dropbox/info.json` if exists for custom path

2. `detect_gdrive_folder()` - Check standard paths:
   - `$HOME/Google Drive`
   - `$HOME/Library/CloudStorage/GoogleDrive-*`
   - Look for "My Drive" subdirectory

3. `detect_icloud_folder()` - Check:
   - `$HOME/Library/Mobile Documents/com~apple~CloudDocs`

4. `detect_onedrive_folder()` - Check:
   - `$HOME/OneDrive`
   - `$HOME/Library/CloudStorage/OneDrive-*`

5. `detect_all_cloud_folders()` - Return array of all detected cloud services with paths

6. `get_cloud_backup_root()` - Given a cloud folder path, return the backup root (e.g., `$CLOUD_FOLDER/Backups/Checkpoint`)

Each function should:
- Return 0 and echo path if found
- Return 1 if not found
- Validate folder is writable before returning

Follow existing patterns from `lib/database-detector.sh` for structure.
  </action>
  <verify>
    source lib/cloud-folder-detector.sh && detect_all_cloud_folders
  </verify>
  <done>
    - Functions detect Dropbox, GDrive, iCloud, OneDrive paths
    - Returns valid paths only (writable directories)
    - Follows existing lib/*.sh conventions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cloud destination config options</name>
  <files>templates/backup-config.sh</files>
  <action>
Add new config section to `templates/backup-config.sh` BEFORE the existing "CLOUD BACKUP (via rclone)" section:

```bash
# ==============================================================================
# CLOUD FOLDER DESTINATION (auto-sync via desktop app)
# ==============================================================================

# Enable cloud folder backup (true/false)
# When enabled, backups write to a cloud-synced folder (Dropbox/GDrive/iCloud/OneDrive)
# This provides automatic cloud backup via the desktop sync app - no API calls needed
CLOUD_FOLDER_ENABLED=false

# Cloud folder path (auto-detected if empty)
# Examples:
#   "$HOME/Dropbox/Backups/Checkpoint"
#   "$HOME/Google Drive/Backups/Checkpoint"
#   "$HOME/Library/Mobile Documents/com~apple~CloudDocs/Backups/Checkpoint"
# Leave empty to auto-detect first available cloud folder
CLOUD_FOLDER_PATH=""

# Project subfolder within cloud backup (uses PROJECT_NAME by default)
# Backups will be stored at: $CLOUD_FOLDER_PATH/$CLOUD_PROJECT_FOLDER/
CLOUD_PROJECT_FOLDER="${PROJECT_NAME:-$(basename "$PROJECT_DIR")}"

# Keep local backup in addition to cloud folder (true/false)
# If true, maintains backup in both PROJECT/backups/ and cloud folder
# If false, only backs up to cloud folder (saves local disk space)
CLOUD_FOLDER_ALSO_LOCAL=true
```

Also add a comment to the existing rclone section clarifying:
```bash
# Note: Cloud folder backup (above) is preferred when available.
# rclone is used as fallback when cloud folder is unavailable or for additional remotes.
```
  </action>
  <verify>
    grep -A 5 "CLOUD FOLDER DESTINATION" templates/backup-config.sh
  </verify>
  <done>
    - New config section added with CLOUD_FOLDER_ENABLED, CLOUD_FOLDER_PATH, CLOUD_PROJECT_FOLDER, CLOUD_FOLDER_ALSO_LOCAL
    - Existing rclone section updated with fallback note
    - Config follows existing template conventions
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `lib/cloud-folder-detector.sh` exists with detection functions
- [ ] `source lib/cloud-folder-detector.sh` works without errors
- [ ] `templates/backup-config.sh` has new cloud folder config section
- [ ] New config variables documented with examples
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Cloud folder detection works on macOS
- Config template updated with cloud folder options
</success_criteria>

<output>
After completion, create `.planning/phases/01-cloud-destination/01-01-SUMMARY.md`
</output>
