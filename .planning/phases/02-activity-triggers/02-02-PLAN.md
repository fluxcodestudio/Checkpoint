---
phase: 02-activity-triggers
plan: 02
type: execute
---

<objective>
Integrate watcher with backup engine for persistent operation.

Purpose: Make file watcher survive terminal close and integrate with existing install/uninstall lifecycle.
Output: LaunchAgent template for watcher persistence, updated install/uninstall scripts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-activity-triggers/02-RESEARCH.md
@.planning/phases/02-activity-triggers/02-01-SUMMARY.md (when available)

**Key files:**
@bin/install.sh
@bin/uninstall.sh
@templates/backup-config.sh

**Established patterns:**
- LaunchAgent plist in templates/ for daemon
- install.sh copies templates and loads LaunchAgent
- uninstall.sh unloads and removes

**From RESEARCH.md:**
- LaunchAgent with KeepAlive for watcher persistence
- Per-project LaunchAgents match existing daemon pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LaunchAgent template for watcher</name>
  <files>templates/launchd-watcher.plist</files>
  <action>
Create LaunchAgent plist template for file watcher:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.claudecode.backup-watcher.PROJECT_NAME_PLACEHOLDER</string>
    <key>ProgramArguments</key>
    <array>
        <string>PROJECT_DIR_PLACEHOLDER/bin/backup-watcher.sh</string>
    </array>
    <key>WorkingDirectory</key>
    <string>PROJECT_DIR_PLACEHOLDER</string>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>HOME_PLACEHOLDER/.claudecode-backups/logs/watcher-PROJECT_NAME_PLACEHOLDER.log</string>
    <key>StandardErrorPath</key>
    <string>HOME_PLACEHOLDER/.claudecode-backups/logs/watcher-PROJECT_NAME_PLACEHOLDER.err</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin</string>
    </dict>
</dict>
</plist>
```

Key points:
- KeepAlive=true ensures watcher restarts if it dies
- RunAtLoad=true starts on login
- Includes PATH for fswatch (homebrew locations)
- Uses same placeholder pattern as existing launchd templates (PROJECT_NAME_PLACEHOLDER, etc.)
- Log files go to ~/.claudecode-backups/logs/
  </action>
  <verify>
plutil -lint templates/launchd-watcher.plist (validates XML)
grep -q "KeepAlive" templates/launchd-watcher.plist && echo "KeepAlive present"
  </verify>
  <done>
- launchd-watcher.plist template created
- Uses same placeholder pattern as existing templates
- KeepAlive and RunAtLoad enabled
- PATH includes homebrew for fswatch
  </done>
</task>

<task type="auto">
  <name>Task 2: Update config template with watcher options</name>
  <files>templates/backup-config.sh</files>
  <action>
Add watcher configuration options to templates/backup-config.sh:

```bash
# ==============================================================================
# FILE WATCHER SETTINGS
# ==============================================================================

# Enable automatic file watching (triggers backup after quiet period)
WATCHER_ENABLED=false

# Seconds of inactivity before triggering backup (default: 60)
DEBOUNCE_SECONDS=60

# Additional paths to exclude from watching (beyond defaults)
# Defaults always excluded: node_modules, .git, backups/, .cache, __pycache__, dist/, build/, .next/, coverage/
# WATCHER_EXCLUDES=("vendor" "tmp")
```

Add this section AFTER the existing sections (after CLOUD_BACKUP_SETTINGS or similar).

Do NOT modify any existing settings - only ADD new section.
  </action>
  <verify>
grep -q "WATCHER_ENABLED" templates/backup-config.sh && echo "Watcher config added"
grep -q "DEBOUNCE_SECONDS" templates/backup-config.sh && echo "Debounce config added"
  </verify>
  <done>
- templates/backup-config.sh updated with watcher section
- WATCHER_ENABLED, DEBOUNCE_SECONDS, WATCHER_EXCLUDES documented
- Existing settings unchanged
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate watcher with install/uninstall lifecycle</name>
  <files>bin/install.sh, bin/uninstall.sh</files>
  <action>
Update install.sh to optionally install watcher LaunchAgent:

1. After existing LaunchAgent installation, add:
```bash
# Install watcher LaunchAgent if enabled
if [ "${WATCHER_ENABLED:-false}" = "true" ]; then
    WATCHER_PLIST_NAME="com.claudecode.backup-watcher.${PROJECT_NAME}.plist"
    WATCHER_PLIST_PATH="$HOME/Library/LaunchAgents/$WATCHER_PLIST_NAME"

    # Create from template
    sed -e "s|PROJECT_NAME_PLACEHOLDER|$PROJECT_NAME|g" \
        -e "s|PROJECT_DIR_PLACEHOLDER|$PROJECT_DIR|g" \
        -e "s|HOME_PLACEHOLDER|$HOME|g" \
        "$TEMPLATE_DIR/launchd-watcher.plist" > "$WATCHER_PLIST_PATH"

    # Load LaunchAgent
    launchctl load "$WATCHER_PLIST_PATH"
    echo "  File watcher installed (debounce: ${DEBOUNCE_SECONDS:-60}s)"
fi
```

Update uninstall.sh to remove watcher LaunchAgent:

1. Before or with existing LaunchAgent removal, add:
```bash
# Unload and remove watcher LaunchAgent if exists
WATCHER_PLIST_NAME="com.claudecode.backup-watcher.${PROJECT_NAME}.plist"
WATCHER_PLIST_PATH="$HOME/Library/LaunchAgents/$WATCHER_PLIST_NAME"
if [ -f "$WATCHER_PLIST_PATH" ]; then
    launchctl unload "$WATCHER_PLIST_PATH" 2>/dev/null || true
    rm -f "$WATCHER_PLIST_PATH"
    echo "  File watcher removed"
fi

# Clean up watcher PID files
rm -f "$STATE_DIR/.watcher.pid" "$STATE_DIR/.watcher-timer.pid"
```

Key constraints:
- Do NOT break existing install/uninstall logic
- Watcher install is OPTIONAL (only if WATCHER_ENABLED=true)
- Watcher uninstall is ALWAYS attempted (cleanup)
- Use same sed placeholder pattern as existing code
  </action>
  <verify>
grep -q "backup-watcher" bin/install.sh && echo "Watcher in install.sh"
grep -q "backup-watcher" bin/uninstall.sh && echo "Watcher in uninstall.sh"
bash -n bin/install.sh && bash -n bin/uninstall.sh && echo "Both scripts valid"
  </verify>
  <done>
- install.sh installs watcher LaunchAgent when WATCHER_ENABLED=true
- uninstall.sh removes watcher LaunchAgent and PID files
- Existing functionality unchanged
- Both scripts pass syntax check
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] plutil -lint templates/launchd-watcher.plist passes
- [ ] bash -n bin/install.sh passes
- [ ] bash -n bin/uninstall.sh passes
- [ ] templates/backup-config.sh has watcher settings section
- [ ] Watcher LaunchAgent has KeepAlive=true
</verification>

<success_criteria>

- LaunchAgent template created for watcher persistence
- Config template updated with watcher options
- install.sh conditionally installs watcher
- uninstall.sh cleans up watcher
- Phase 2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-activity-triggers/02-02-SUMMARY.md`

Mark Phase 2 complete in ROADMAP.md and STATE.md
</output>
