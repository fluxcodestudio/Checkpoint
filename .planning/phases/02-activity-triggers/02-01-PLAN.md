---
phase: 02-activity-triggers
plan: 01
type: execute
---

<objective>
Create file watcher with debounced backup triggering.

Purpose: Automatically trigger backups after 60s of file inactivity, capturing natural "pause points" in development.
Output: backup-watcher.sh script with fswatch integration and debounce logic, plus management commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-activity-triggers/02-RESEARCH.md
@.planning/phases/01-cloud-destination/01-02-SUMMARY.md

**Key files:**
@bin/backup-daemon.sh
@bin/smart-backup-trigger.sh
@lib/backup-lib.sh

**Tech stack available:** Pure bash, fswatch (to install via brew)

**Established patterns from Phase 1:**
- resolve_backup_destinations() for destination routing
- File locking in backup-daemon.sh prevents concurrent backups
- State files in ~/.claudecode-backups/state/${PROJECT_NAME}/

**From RESEARCH.md - Don't hand-roll:**
- File system events (use fswatch, not polling)
- Exclude patterns (use fswatch -e, not grep filters)

**From RESEARCH.md - Key patterns:**
- fswatch -o -r with --one-per-batch for event batching
- PID file for debounce timer tracking
- Kill/restart timer on each event
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file watcher script with debounce</name>
  <files>bin/backup-watcher.sh</files>
  <action>
Create backup-watcher.sh that:

1. Sources project config from .backup-config.sh
2. Uses fswatch with FSEvents backend (macOS default)
3. Excludes: node_modules, .git, backups/, .cache, __pycache__, dist/, build/, .next/, coverage/
4. Uses -o (one-per-batch) mode for event batching
5. Implements debounce with PID file tracking:
   - On event: kill existing timer PID, start new background sleep + trigger
   - Timer PID stored in STATE_DIR/.watcher-timer.pid
   - After DEBOUNCE_SECONDS (default 60), triggers backup-daemon.sh
6. Trap SIGTERM/SIGINT for clean shutdown (kills fswatch and timer)
7. Logs to STATE_DIR/watcher.log

Key constraints:
- Do NOT poll or use find/stat - fswatch handles events
- Do NOT trigger backup on every event - only after quiet period
- Do NOT run backup-daemon.sh directly in foreground - background it
- Use existing backup-daemon.sh which already has file locking

Config variables to read from .backup-config.sh:
- DEBOUNCE_SECONDS (default: 60)
- WATCHER_ENABLED (default: false)
- WATCHER_EXCLUDES (optional array to extend defaults)

Script should be executable and follow existing bin/*.sh patterns (symlink resolution, config loading, set -euo pipefail).
  </action>
  <verify>
bash -n bin/backup-watcher.sh (syntax check passes)
head -50 bin/backup-watcher.sh (shows fswatch command with excludes and debounce logic)
  </verify>
  <done>
- backup-watcher.sh exists with fswatch integration
- Debounce logic uses PID file for timer management
- Excludes match RESEARCH.md recommendations
- Clean shutdown via trap
  </done>
</task>

<task type="auto">
  <name>Task 2: Add watcher management commands</name>
  <files>bin/backup-watch.sh</files>
  <action>
Create backup-watch.sh management command with subcommands:

1. `backup-watch start` - Start watcher for current project
   - Check fswatch installed (brew install fswatch if missing - warn only, don't auto-install)
   - Check WATCHER_ENABLED=true in config (warn if not)
   - Check not already running (PID file check)
   - Run backup-watcher.sh in background, save PID
   - PID file: STATE_DIR/.watcher.pid

2. `backup-watch stop` - Stop watcher for current project
   - Read PID from STATE_DIR/.watcher.pid
   - Kill process (SIGTERM)
   - Remove PID file
   - Clean up timer PID file if exists

3. `backup-watch status` - Show watcher status
   - Check if watcher running (PID file + process exists)
   - Show last trigger time if available
   - Show current debounce setting

4. `backup-watch restart` - Stop then start

Follow existing command patterns from backup-status.sh, backup-pause.sh.

Output format:
- start: "Watcher started for PROJECT_NAME (PID: XXXX)"
- stop: "Watcher stopped for PROJECT_NAME"
- status: "Watcher: running/stopped, Debounce: 60s, Last trigger: timestamp"
  </action>
  <verify>
bash -n bin/backup-watch.sh (syntax check)
bin/backup-watch.sh --help or bin/backup-watch.sh (shows usage)
  </verify>
  <done>
- backup-watch.sh exists with start/stop/status/restart subcommands
- Uses PID file for process management
- Follows existing command output patterns
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] bash -n bin/backup-watcher.sh passes
- [ ] bash -n bin/backup-watch.sh passes
- [ ] backup-watch.sh shows help/usage when run without args
- [ ] Scripts follow existing patterns (symlink resolution, set -euo pipefail)
- [ ] fswatch excludes match RESEARCH.md recommendations
</verification>

<success_criteria>

- backup-watcher.sh created with fswatch + debounce
- backup-watch.sh created with start/stop/status/restart
- No syntax errors in either script
- Debounce uses PID file pattern (not polling)
- Excludes include: node_modules, .git, backups/, .cache
</success_criteria>

<output>
After completion, create `.planning/phases/02-activity-triggers/02-01-SUMMARY.md`
</output>
