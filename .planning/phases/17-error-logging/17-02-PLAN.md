---
phase: 17-error-logging
plan: 02
type: execute
---

<objective>
Migrate the core backup scripts (backup-now.sh, backup-daemon.sh, checkpoint-watchdog.sh) from scattered 2>/dev/null to structured logging.

Purpose: These three scripts are the most critical backup execution paths and have the highest concentration of error suppression (~170 combined occurrences). Migrating them first provides the most diagnostic value.
Output: Core backup scripts using structured logging with proper error capture, debug mode support via --debug/--trace flags, SIGUSR1 toggle in daemon.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-error-logging/17-RESEARCH.md
@.planning/phases/17-error-logging/17-01-SUMMARY.md

# Key files to read and modify:
@bin/backup-now.sh
@bin/backup-daemon.sh
@bin/checkpoint-watchdog.sh
@lib/core/logging.sh

**Tech stack available:** lib/core/logging.sh (log_error/warn/info/debug/trace, init_logging, parse_log_flags, log_set_context, _toggle_debug_level)
**Established patterns:** Categorize 2>/dev/null into KEEP (idiomatic) / REPLACE (capture stderr to log_debug) / REDIRECT (log the error)

**Categorization rules (from 17-RESEARCH.md):**
- KEEP: `command -v X 2>/dev/null`, `type X &>/dev/null`, `hash X 2>/dev/null`, `cat file 2>/dev/null || default`, `date +format 2>/dev/null || fallback`, platform detection fallbacks
- REPLACE: git operations, rsync, cp, find with -delete, file operations where stderr has diagnostic value
- REDIRECT: launchctl, mkdir -p (expected to sometimes fail), operations with handled error paths
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate bin/backup-now.sh to structured logging</name>
  <files>bin/backup-now.sh</files>
  <action>
Read bin/backup-now.sh fully. It has ~73 occurrences of 2>/dev/null. Categorize each and apply:

**1. Add logging initialization at script start:**
- After sourcing backup-lib.sh and loading config, call `_init_checkpoint_logging`
- Call `log_set_context "backup-now"`
- Add `parse_log_flags "$@"` before the main argument parsing loop
- Add --debug and --trace to the case statement in argument parsing (set CHECKPOINT_LOG_LEVEL)
- Replace existing VERBOSE and BACKUP_DEBUG flag logic with CHECKPOINT_LOG_LEVEL checks
  - `VERBOSE=true` becomes `CHECKPOINT_LOG_LEVEL=$LOG_LEVEL_DEBUG`
  - Any `if [ "$VERBOSE" = true ]` checks become `if (( CHECKPOINT_LOG_LEVEL >= LOG_LEVEL_DEBUG ))`
  - Any `verbose_log` calls become `log_debug`

**2. Categorize and migrate each 2>/dev/null:**

KEEP (do not change):
- `command -v X 2>/dev/null` — command existence checks
- `type X &>/dev/null` — function existence checks
- `cat "$file" 2>/dev/null || echo ""` — read-with-fallback
- `date` format fallbacks
- `tput` terminal queries
- `kill -0 "$pid" 2>/dev/null` — PID existence check (expected to fail for dead PIDs)

REPLACE with log_debug (capture stderr):
- Git operations: `git diff 2>/dev/null`, `git branch 2>/dev/null`, `git add/commit 2>/dev/null`, `git push 2>/dev/null`
  - Pattern: `if ! git_out=$(git diff --name-only 2>&1); then log_debug "git diff failed: $git_out"; fi`
  - For fire-and-forget: `git add -A 2>&1 | while IFS= read -r line; do log_trace "git: $line"; done` — but only where the output isn't needed for logic. Simpler: just do `some_command 2>>"${_CHECKPOINT_LOG_FILE:-/dev/null}"` to redirect stderr to log file directly when TRACE/DEBUG isn't needed
- rsync operations: capture stderr to log_debug on failure
- find -delete operations: `find ... -delete 2>>"${_CHECKPOINT_LOG_FILE:-/dev/null}"` — redirect stderr to log file instead of /dev/null
- cp/mv operations in backup paths

REDIRECT (log the outcome):
- mkdir -p for backup directories: keep 2>/dev/null but add log_debug on failure path
- File stat operations

**3. Replace existing ad-hoc log functions:**
- Remove local `log_info()`, `log_success()`, `log_error()`, `log_warn()`, `log_verbose()` function definitions IF they conflict with the module's functions
- If script defines its own `log_info` etc. for colored terminal output, rename them to `cli_info`, `cli_success`, `cli_error`, `cli_warn` to avoid shadowing the logging module's file-logging functions
- Or better: keep the CLI output functions for user-facing terminal output, and use the module's log_* functions for file logging. They serve different purposes. Rename the script-local ones to avoid name collision.

**What to avoid and WHY:**
- Do NOT change the logic flow — only change where stderr goes
- Do NOT add log_debug calls in tight loops (file-by-file backup loop) — use log_trace there, or redirect stderr to log file directly
- Do NOT remove the `|| true` after find -delete — still needed for set -e safety
- Do NOT break the existing colored terminal output — keep cli_* functions for user display
  </action>
  <verify>
1. Run `bin/backup-now.sh --help` — should still work, now shows --debug/--trace options
2. Run `bin/backup-now.sh --debug --dry-run` (if dry-run exists) or in a test project — should produce debug log entries
3. Check log file after a backup: should contain timestamped entries with [INFO], [DEBUG] levels
4. Verify no bash errors: `bash -n bin/backup-now.sh` — syntax check passes
5. Grep for remaining 2>/dev/null — only KEEP-category occurrences should remain
  </verify>
  <done>
- backup-now.sh uses structured logging via lib/core/logging.sh
- --debug and --trace CLI flags work
- VERBOSE/BACKUP_DEBUG replaced with CHECKPOINT_LOG_LEVEL
- ~50+ 2>/dev/null occurrences replaced with log_debug/stderr-to-log-file
- ~20 legitimate 2>/dev/null retained (command -v, pid checks, etc.)
- Colored terminal output preserved via renamed cli_* functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate bin/backup-daemon.sh and bin/checkpoint-watchdog.sh</name>
  <files>bin/backup-daemon.sh, bin/checkpoint-watchdog.sh</files>
  <action>
**bin/backup-daemon.sh (~48 occurrences):**

1. Add logging initialization after sourcing backup-lib.sh:
   - `log_set_context "daemon"`
   - `_init_checkpoint_logging`
   - Add `trap '_toggle_debug_level' USR1` for runtime debug toggle

2. Replace custom log functions with module functions:
   - The daemon likely has its own `log()` function — rename to `daemon_cli_log()` or remove if log_info covers the use case
   - Replace `echo "[timestamp] message" >> "$LOG_FILE"` patterns with `log_info "message"`

3. Categorize and migrate 2>/dev/null occurrences (same rules as Task 1):
   - KEEP: command -v, pid checks, platform detection
   - REPLACE: backup operations, cleanup, file operations → log_debug
   - REDIRECT: mkdir, config loading → log on failure

4. Add --debug flag support to daemon argument parsing

**bin/checkpoint-watchdog.sh:**

1. Replace the custom `log()` function (which has its own manual rotation at 1MB):
   - The watchdog's existing rotation logic should be REMOVED — logging.sh handles rotation
   - Replace `log "message"` calls with `log_info "message"`
   - `log_set_context "watchdog"`

2. Add SIGUSR1 trap for debug toggle:
   - `trap '_toggle_debug_level' USR1`
   - Log the PID to a known location so users can send signals: `echo $$ > "${STATE_DIR:-$HOME/.checkpoint}/watchdog.pid"`

3. Migrate 2>/dev/null occurrences — watchdog has fewer but they're in the critical monitoring loop

**What to avoid and WHY:**
- Do NOT change the daemon's backup scheduling logic — only change logging
- Do NOT remove the watchdog's heartbeat mechanism — it's separate from logging
- Do NOT use log_debug in the main daemon loop body for every iteration — use log_trace for per-cycle noise, log_debug for per-backup-operation details
  </action>
  <verify>
1. `bash -n bin/backup-daemon.sh` — syntax check
2. `bash -n bin/checkpoint-watchdog.sh` — syntax check
3. Start watchdog briefly, check log file format matches structured format
4. Verify SIGUSR1 toggle: start daemon, send USR1, check log level changes
5. Verify watchdog no longer uses its own log rotation (rotation comes from logging.sh)
  </verify>
  <done>
- backup-daemon.sh and checkpoint-watchdog.sh use structured logging
- Custom log() functions removed/replaced with module log_* functions
- SIGUSR1 debug toggle works in both daemon scripts
- Watchdog PID written to known location for signal delivery
- --debug flag support in daemon
- Old manual log rotation in watchdog removed (replaced by logging.sh rotation)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/backup-now.sh` passes
- [ ] `bash -n bin/backup-daemon.sh` passes
- [ ] `bash -n bin/checkpoint-watchdog.sh` passes
- [ ] backup-now.sh --debug produces structured log output
- [ ] Daemon SIGUSR1 toggle works
- [ ] No regressions in terminal output (colored user-facing output preserved)
- [ ] Grep for 2>/dev/null in these 3 files shows only KEEP-category occurrences
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Core backup scripts fully migrated to structured logging
- Debug mode accessible via --debug flag and SIGUSR1 signal
</success_criteria>

<output>
After completion, create `.planning/phases/17-error-logging/17-02-SUMMARY.md`
</output>
