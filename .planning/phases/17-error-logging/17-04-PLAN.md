---
phase: 17-error-logging
plan: 04
type: execute
---

<objective>
Migrate remaining bin/ scripts and integrations/ to structured logging, then run end-to-end verification of the entire logging overhaul.

Purpose: Complete the migration across all remaining scripts and verify the system works end-to-end — log rotation, debug mode, daemon toggle, and no regressions in backup functionality.
Output: All scripts migrated; Phase 17 complete with full structured logging across the codebase.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-error-logging/17-RESEARCH.md
@.planning/phases/17-error-logging/17-01-SUMMARY.md
@.planning/phases/17-error-logging/17-02-SUMMARY.md
@.planning/phases/17-error-logging/17-03-SUMMARY.md

# Key files to modify:
@bin/backup-restore.sh
@bin/backup-config.sh
@bin/checkpoint-dashboard.sh
@bin/backup-status.sh
@bin/install.sh
@bin/install-global.sh
@bin/backup-all-projects.sh
@bin/checkpoint.sh
@bin/backup-verify.sh
@lib/core/logging.sh

**Categorization rules (from 17-RESEARCH.md):**
- KEEP: command -v, type, hash, read-with-fallback, platform detection, tput queries, dialog/whiptail checks
- REPLACE: file operations, git operations, service management operations → capture stderr to log_debug
- REDIRECT: mkdir -p, stat → keep 2>/dev/null but add log_debug on failure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate remaining bin/ scripts and integrations/</name>
  <files>bin/backup-restore.sh, bin/backup-config.sh, bin/checkpoint-dashboard.sh, bin/backup-status.sh, bin/install.sh, bin/install-global.sh, bin/backup-all-projects.sh, bin/checkpoint.sh, bin/backup-verify.sh, bin/smart-backup-trigger.sh, bin/backup-pause.sh, bin/backup-update.sh, bin/uninstall.sh, bin/uninstall-global.sh, bin/configure-integrations.sh, integrations/shell/backup-shell-integration.sh, integrations/lib/notification.sh, integrations/lib/integration-core.sh</files>
  <action>
Migrate all remaining bin/ scripts and integrations/ files. These are lower volume than the core scripts (Plans 02-03 handled the heaviest files).

**For each bin/ script:**
1. Add logging initialization after sourcing backup-lib.sh:
   - `log_set_context "script-name"` (e.g., "restore", "config", "dashboard")
   - Add --debug/--trace to argument parsing if the script has a CLI interface
2. Categorize and migrate 2>/dev/null occurrences
3. If script defines its own log_info/log_error functions that conflict with the module, rename them (cli_info, cli_error, etc.) — same pattern as Plan 02

**Priority scripts (more occurrences or user-facing):**
- bin/backup-restore.sh (~16 occ) — restore failures should log_error, not suppress
- bin/backup-config.sh — config validation errors should log_debug
- bin/checkpoint-dashboard.sh (~16 occ) — mostly KEEP (tput queries, dialog checks)
- bin/install.sh — mostly KEEP (command -v checks for dependencies)
- bin/install-global.sh — service installation errors should log_debug
- bin/backup-all-projects.sh — multi-project loop, log_set_context per project

**Lower priority:**
- bin/backup-status.sh — mostly read operations, KEEP
- bin/checkpoint.sh — routing script, minimal 2>/dev/null
- bin/backup-verify.sh — recently created (Phase 16), few occurrences
- bin/smart-backup-trigger.sh — trigger script, few occurrences
- Remaining bin/ scripts: backup-pause, backup-update, uninstall, uninstall-global, configure-integrations

**Integrations (minimal changes):**
- integrations/shell/backup-shell-integration.sh — shell integration, likely KEEP (platform detection)
- integrations/lib/notification.sh — notification dispatch, KEEP (command -v for osascript/notify-send)
- integrations/lib/integration-core.sh — integration utilities, likely KEEP

**What to avoid and WHY:**
- Do NOT add logging initialization to integrations/ scripts that are sourced into user shells — they must stay lightweight
- Do NOT add --debug flags to scripts that don't parse arguments (like hook scripts)
- Do NOT modify .claude/ hook files — they're separate from the main codebase
  </action>
  <verify>
1. `bash -n` syntax check on all modified bin/ files
2. `bin/backup-restore.sh --help` works (if it has --help)
3. `bin/backup-config.sh --help` works
4. `bash -c 'source integrations/lib/notification.sh && echo OK'` — integration libs load
5. Grep 2>/dev/null across all bin/ and integrations/ — only KEEP-category remains
  </verify>
  <done>
- All remaining bin/ scripts migrated
- integrations/ scripts reviewed (mostly KEEP, minimal changes)
- --debug/--trace flags added to major CLI scripts (restore, config, dashboard)
- Conflicting log function names resolved
- Only legitimate 2>/dev/null retained
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end verification and CONCERNS.md update</name>
  <files>.planning/codebase/CONCERNS.md</files>
  <action>
**1. Audit 2>/dev/null reduction:**
Run a final count of 2>/dev/null across the codebase (excluding lib/archive/, tests/):
```bash
# Count remaining in active code
grep -r '2>/dev/null' lib/ bin/ integrations/ --include='*.sh' | grep -v 'lib/archive/' | wc -l
```
Compare to baseline (~780 in active code before migration). The count should drop significantly — remaining should be ~200 legitimate uses.

**2. Test log rotation:**
- Set CHECKPOINT_LOG_MAX_SIZE to a small value (e.g., 1024 bytes)
- Run a backup that generates log output
- Verify rotation files appear (.1, .2, etc.)
- Verify no rotation file exceeds max size
- Reset to default size

**3. Test debug mode end-to-end:**
- Run `checkpoint backup --debug` on a test project
- Verify DEBUG-level messages appear in log file
- Verify normal INFO run produces fewer log entries
- Verify --quiet suppresses non-error output

**4. Test daemon SIGUSR1 toggle:**
- Check that watchdog.pid file is created
- Document the signal-based debug toggle for users

**5. Verify no backup regressions:**
- Run a test backup and verify it completes successfully
- Check that backup files are created correctly
- Verify cloud sync still works (if configured)
- Verify status command shows correct information

**6. Update .planning/codebase/CONCERNS.md:**
- Update the "Silent error suppression" entry:
  - Mark as RESOLVED
  - Note: "Replaced with structured logging in Phase 17. Remaining 2>/dev/null are legitimate (command existence checks, platform detection)."
  - Update the occurrence count to the new (lower) number
- Add any new concerns discovered during migration (if any)

**What to avoid and WHY:**
- Do NOT run destructive tests — use a test project directory, not real backups
- Do NOT change functionality during verification — just verify existing behavior
  </action>
  <verify>
1. 2>/dev/null count in active code is ~200 or less (down from ~780)
2. Log rotation creates .1 file when max size exceeded
3. --debug flag produces DEBUG-level entries in log file
4. --quiet suppresses non-error output
5. Test backup completes without errors
6. CONCERNS.md updated with resolution
  </verify>
  <done>
- 2>/dev/null count reduced from ~780 to ~200 (legitimate uses only)
- Log rotation verified working
- Debug mode verified working (--debug flag, SIGUSR1 toggle)
- No backup regressions
- CONCERNS.md updated — "Silent error suppression" marked resolved
- Phase 17 complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All bin/ scripts pass `bash -n` syntax check
- [ ] 2>/dev/null count in active code reduced by ~70-75%
- [ ] Log rotation works end-to-end
- [ ] Debug mode works via --debug flag
- [ ] Daemon SIGUSR1 toggle works
- [ ] Test backup completes successfully
- [ ] CONCERNS.md updated
- [ ] No regressions in backup functionality
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Phase 17 fully complete — all scripts use structured logging
- CONCERNS.md reflects the resolved error suppression
- Phase 17 complete, ready for Phase 18
</success_criteria>

<output>
After completion, create `.planning/phases/17-error-logging/17-04-SUMMARY.md`:

# Phase 17 Plan 04: CLI Migration & Verification Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- [files]

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 17 complete, ready for Phase 18: Daemon Lifecycle & Health Monitoring
</output>
