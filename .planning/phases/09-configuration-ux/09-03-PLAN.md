---
phase: 09-configuration-ux
plan: 03
type: execute
---

<objective>
Add configuration validation for new options and inline help system.

Purpose: Help users understand configuration options and catch invalid settings early.
Output: Enhanced mode_validate() and new `backup-config help <topic>` command.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-configuration-ux/09-01-SUMMARY.md
@.planning/phases/09-configuration-ux/09-02-SUMMARY.md

**Current validation:**
- mode_validate() exists but doesn't cover Phase 5-8 options
- No topic-based help system

**Source files:**
@bin/backup-config.sh (mode_validate, show_help functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance configuration validation for new options</name>
  <files>bin/backup-config.sh</files>
  <action>
Add validation rules for Phase 5-8 options. Either enhance mode_validate() or the underlying config_validate_file() function.

Add validation for:

1. **Alert thresholds:**
   - ALERT_WARNING_HOURS must be positive integer
   - ALERT_ERROR_HOURS must be > ALERT_WARNING_HOURS (or warn)

2. **Quiet hours format:**
   - If QUIET_HOURS is set, must match pattern: ^[0-9]{1,2}-[0-9]{1,2}$
   - Hours must be 0-23

3. **Notification sound:**
   - NOTIFY_SOUND must be one of: default, Basso, Glass, Hero, Pop, none

4. **Cloud folder:**
   - If CLOUD_FOLDER_ENABLED=true, warn if CLOUD_FOLDER_PATH doesn't exist

Example validation additions (in mode_validate or config_validate_file):

```bash
# Validate alert thresholds
local warning_hours error_hours
warning_hours="$(config_get_value "alerts.warning_hours" 2>/dev/null || echo "24")"
error_hours="$(config_get_value "alerts.error_hours" 2>/dev/null || echo "72")"

if ! [[ "$warning_hours" =~ ^[0-9]+$ ]]; then
    color_red "✗ alerts.warning_hours must be a positive integer"
    errors=$((errors + 1))
fi

if [[ "$error_hours" -le "$warning_hours" ]]; then
    color_yellow "⚠ alerts.error_hours ($error_hours) should be > alerts.warning_hours ($warning_hours)"
    warnings=$((warnings + 1))
fi

# Validate quiet hours format
local quiet_hours
quiet_hours="$(config_get_value "alerts.quiet_hours" 2>/dev/null || echo "")"
if [[ -n "$quiet_hours" ]]; then
    if ! [[ "$quiet_hours" =~ ^[0-9]{1,2}-[0-9]{1,2}$ ]]; then
        color_red "✗ alerts.quiet_hours format invalid (expected: HH-HH, got: $quiet_hours)"
        errors=$((errors + 1))
    fi
fi

# Validate cloud folder exists
local cloud_enabled cloud_path
cloud_enabled="$(config_get_value "cloud_folder.enabled" 2>/dev/null || echo "false")"
cloud_path="$(config_get_value "cloud_folder.path" 2>/dev/null || echo "")"
if [[ "$cloud_enabled" == "true" && -n "$cloud_path" && ! -d "$cloud_path" ]]; then
    color_yellow "⚠ Cloud folder does not exist: $cloud_path"
    warnings=$((warnings + 1))
fi
```

Integrate into existing validation flow.
  </action>
  <verify>bash bin/backup-config.sh validate 2>&1 | head -20</verify>
  <done>Validation covers alert thresholds, quiet hours format, notification sound, and cloud folder existence</done>
</task>

<task type="auto">
  <name>Task 2: Add help command with topic-based documentation</name>
  <files>bin/backup-config.sh</files>
  <action>
Add a new mode_help() function and wire it up in main().

1. Add to help text:
```
    help [topic]              Show help (optional: alerts, cloud, hooks, retention)
```

2. Create mode_help() function:

```bash
mode_help() {
    local topic="${1:-}"

    if [[ -z "$topic" ]]; then
        show_help
        return 0
    fi

    case "$topic" in
        "alerts"|"notifications")
            cat << 'EOF'
ALERTS & NOTIFICATIONS
═══════════════════════════════════════════════

Alert Thresholds:
  ALERT_WARNING_HOURS (default: 24)
    Hours without backup before warning state. Dashboard shows yellow.

  ALERT_ERROR_HOURS (default: 72)
    Hours without backup before error state. Dashboard shows red.

Notification Controls:
  NOTIFY_ON_SUCCESS (default: false)
    Notify after successful backup. Useful after fixing issues.

  NOTIFY_ON_WARNING (default: true)
    Notify when backup becomes stale (warning threshold).

  NOTIFY_ON_ERROR (default: true)
    Notify on backup failures.

  NOTIFY_ESCALATION_HOURS (default: 3)
    Hours between repeated notifications for same issue.

  NOTIFY_SOUND (default: default)
    Sound for notifications: default, Basso, Glass, Hero, Pop, none

  PROJECT_NOTIFY_ENABLED (default: true)
    Per-project override. Set false to silence this project.

Quiet Hours:
  QUIET_HOURS (default: empty)
    Suppress non-critical notifications. Format: HH-HH (24-hour).
    Example: "22-07" for 10pm to 7am (supports overnight ranges).

  QUIET_HOURS_BLOCK_ERRORS (default: false)
    If true, even critical errors respect quiet hours.

Examples:
  backup-config set alerts.warning_hours 12
  backup-config set alerts.quiet_hours "22-07"
  backup-config set notifications.sound none
EOF
            ;;

        "cloud")
            cat << 'EOF'
CLOUD BACKUP
═══════════════════════════════════════════════

Cloud Folder (Recommended):
  Syncs via desktop app (Dropbox, Google Drive, iCloud).
  Zero API calls - instant, reliable, automatic.

  CLOUD_FOLDER_ENABLED (default: true)
    Enable cloud folder backup.

  CLOUD_FOLDER_PATH (auto-detected)
    Path to cloud-synced folder.
    Examples:
      $HOME/Dropbox/Backups/Checkpoint
      $HOME/Google Drive/Backups/Checkpoint
      $HOME/Library/Mobile Documents/com~apple~CloudDocs/Backups

  CLOUD_FOLDER_ALSO_LOCAL (default: true)
    Keep local backup in addition to cloud folder.

rclone Fallback:
  Used when cloud folder unavailable or for additional remotes.

  CLOUD_ENABLED (default: false)
    Enable rclone backup.

  CLOUD_REMOTE_NAME
    Remote name from 'rclone config'.

  CLOUD_BACKUP_PATH
    Path on cloud storage.

Examples:
  backup-config set cloud_folder.enabled true
  backup-config set cloud_folder.path "$HOME/Dropbox/Backups/Checkpoint"
EOF
            ;;

        "hooks")
            cat << 'EOF'
CLAUDE CODE INTEGRATION
═══════════════════════════════════════════════

Automatically trigger backups from Claude Code events.

  HOOKS_ENABLED (default: false)
    Enable Claude Code hooks.

  HOOKS_TRIGGERS (default: "stop,edit,commit")
    Which events trigger backups:
    - stop: Conversation end
    - edit: File changes
    - commit: Git commits

Requirements:
  - Claude Code CLI installed (claude command)
  - Run 'backup-config wizard' to set up

Examples:
  backup-config set hooks.enabled true
  backup-config set hooks.triggers "stop,edit"
EOF
            ;;

        "retention")
            cat << 'EOF'
RETENTION POLICIES
═══════════════════════════════════════════════

Basic Retention:
  DB_RETENTION_DAYS (default: 30)
    Days to keep database backups.

  FILE_RETENTION_DAYS (default: 60)
    Days to keep archived file versions.

Tiered Retention (Smart Space Management):
  TIERED_RETENTION_ENABLED (default: true)
    Enable intelligent tiered retention like Time Machine.

  Keeps:
    - All backups from last 24 hours
    - Hourly backups for days 1-7
    - Daily backups for days 7-30
    - Weekly backups for days 30-90
    - Monthly backups beyond 90 days

Examples:
  backup-config set retention.database.time_based 60
  backup-config set retention.tiered_enabled true
EOF
            ;;

        *)
            echo "Unknown topic: $topic"
            echo ""
            echo "Available topics:"
            echo "  alerts      - Alert thresholds and notifications"
            echo "  cloud       - Cloud folder and rclone backup"
            echo "  hooks       - Claude Code integration"
            echo "  retention   - Backup retention policies"
            echo ""
            echo "Usage: backup-config help <topic>"
            return 1
            ;;
    esac
}
```

3. Add case in main():
```bash
"help")
    mode_help "${2:-}"
    ;;
```
  </action>
  <verify>bash bin/backup-config.sh help alerts 2>&1 | head -10</verify>
  <done>Help command provides topic-based documentation for alerts, cloud, hooks, retention</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `backup-config validate` validates new Phase 5-8 options
- [ ] Invalid quiet hours format produces error
- [ ] `backup-config help` shows usage
- [ ] `backup-config help alerts` shows alert documentation
- [ ] `backup-config help cloud` shows cloud documentation
- [ ] `backup-config help hooks` shows hooks documentation
- [ ] bash -n bin/backup-config.sh passes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Users can validate their full configuration
- Users can get inline help on any config topic
- Phase 9: Configuration UX complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-configuration-ux/09-03-SUMMARY.md`

Final success criteria includes: Phase 9 complete, ready for v1.1 milestone completion
</output>
