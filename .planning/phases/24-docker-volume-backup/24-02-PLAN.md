---
phase: 24-docker-volume-backup
plan: 02
type: execute
---

<objective>
Integrate Docker volume backup into the backup pipeline and create the CLI command.

Purpose: Wire the docker-volumes.sh library into backup-now.sh so volumes are backed up automatically, add the `checkpoint docker-volumes` CLI subcommand for manual operations, and update the checkpoint.sh router.
Output: Docker volume backup runs as part of the standard backup pipeline; CLI available for manual backup/restore/list.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-docker-volume-backup/24-RESEARCH.md
@.planning/phases/24-docker-volume-backup/24-01-SUMMARY.md

# Key source files:
@bin/backup-now.sh
@bin/checkpoint.sh
@bin/checkpoint-encrypt.sh
@lib/features/docker-volumes.sh

**Tech stack available:** Docker CLI, busybox, existing encryption pipeline
**Established patterns:** Feature sourcing in backup-now.sh (storage-monitor, encryption), subcommand routing in checkpoint.sh (verify, diff, encrypt pattern), CLI help with cat <<EOF
**Constraining decisions:**
- Pipeline insertion: after database backup, before file backup (research recommendation)
- Docker lifecycle managed by database-detector.sh — don't duplicate start/stop logic
- Skip gracefully when Docker not running (don't auto-start for volume backups — reuse existing AUTO_START_DOCKER behavior)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate into backup-now.sh pipeline</name>
  <files>bin/backup-now.sh</files>
  <action>
Two changes to backup-now.sh:

**1. Source the module** — Add after the existing encryption.sh sourcing (near the other feature module sources at the top):
```bash
# Source Docker volume backup
if [ -f "$LIB_DIR/features/docker-volumes.sh" ]; then
    source "$LIB_DIR/features/docker-volumes.sh"
fi
```

**2. Add pipeline step** — Insert a new section AFTER the DATABASE BACKUP section and BEFORE the FILE BACKUP section. Follow the exact same pattern as database backup:
```bash
# ==============================================================================
# DOCKER VOLUME BACKUP
# ==============================================================================

if [ "$FILES_ONLY" = false ]; then
    if command -v backup_docker_volumes &>/dev/null && docker_volumes_enabled; then
        cli_info "   Docker Volumes: Detecting..."
        if backup_docker_volumes "$PROJECT_DIR" "$BACKUP_DIR"; then
            cli_success "   Docker Volumes: Backup complete"
            log_info "Docker volume backup complete"
        else
            cli_info "   Docker Volumes: Some backups failed (see above)"
            log_warn "Some Docker volume backups failed"
            backup_errors=$((backup_errors + 1))
        fi
    fi
fi
```

Do NOT modify the Docker cleanup section at the end — the existing `did_we_start_docker`/`stop_docker` pattern already handles lifecycle correctly for both database and volume backups.
  </action>
  <verify>grep -n "docker-volumes.sh" bin/backup-now.sh shows sourcing line; grep -n "DOCKER VOLUME BACKUP" bin/backup-now.sh shows pipeline section; bash -n bin/backup-now.sh passes</verify>
  <done>backup-now.sh sources docker-volumes.sh and calls backup_docker_volumes in the pipeline between database and file backup steps</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI command and wire into router</name>
  <files>bin/checkpoint-docker-volumes.sh, bin/checkpoint.sh</files>
  <action>
**1. Create bin/checkpoint-docker-volumes.sh** — CLI for manual Docker volume operations. Follow checkpoint-encrypt.sh pattern:

Standard shebang, set -euo pipefail, symlink resolution, LIB_DIR setup.

Source required libraries:
- lib/backup-lib.sh (for config loading)
- lib/features/docker-volumes.sh

Subcommands:
- `list` (default) — Show detected volumes for current project. Call detect_compose_file + discover_project_volumes. Display volume name, whether it has existing backups, backup size/date.
- `backup [--all | volume_name]` — Manual backup. `--all` backs up all detected volumes. Otherwise backup named volume. Call backup_volume_safely.
- `restore volume_name [--from backup_file]` — Restore a volume from backup. If no --from, use latest backup. Call restore_single_volume.
- `status` — Show Docker volume backup config status (enabled/disabled, Docker running, compose file found, volumes detected, include/exclude patterns active).
- `--help|-h` — Standard help text with USAGE, COMMANDS, EXAMPLES sections.

Load project config via load_backup_config before executing subcommands.

Make executable: chmod +x.

**2. Update bin/checkpoint.sh** — Add routing entry in the subcommand case statement, following the verify/diff/encrypt pattern:

```bash
    docker-volumes|--docker-volumes|volumes)
        # Manage Docker volume backups
        if [[ -x "$CHECKPOINT_LIB/bin/checkpoint-docker-volumes.sh" ]]; then
            shift
            exec "$CHECKPOINT_LIB/bin/checkpoint-docker-volumes.sh" "$@"
        else
            echo "Error: checkpoint-docker-volumes.sh not found" >&2
            exit 1
        fi
        ;;
```

Also add to the help text: `echo "  docker-volumes      Manage Docker volume backups (list, backup, restore)"`
  </action>
  <verify>bash -n bin/checkpoint-docker-volumes.sh passes; grep "docker-volumes" bin/checkpoint.sh shows routing entry; chmod check: ls -la bin/checkpoint-docker-volumes.sh shows executable</verify>
  <done>checkpoint-docker-volumes.sh exists with list/backup/restore/status subcommands; checkpoint.sh routes docker-volumes subcommand; both pass bash -n syntax check</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bash -n bin/backup-now.sh` passes
- [ ] `bash -n bin/checkpoint-docker-volumes.sh` passes
- [ ] `bash -n bin/checkpoint.sh` passes
- [ ] Docker volume backup sourced in backup-now.sh
- [ ] Pipeline step placed between database and file backup
- [ ] checkpoint.sh routes `docker-volumes` subcommand
- [ ] CLI has list, backup, restore, status subcommands
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Docker volume backup integrated into automatic backup pipeline
- CLI subcommand available via `checkpoint docker-volumes`
- No bash syntax errors introduced
- Phase 24 complete
</success_criteria>

<output>
After completion, create `.planning/phases/24-docker-volume-backup/24-02-SUMMARY.md`
</output>
