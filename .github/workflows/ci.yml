name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test:
    name: Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 gzip

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew list sqlite3 &>/dev/null || brew install sqlite3
          brew list gzip &>/dev/null || brew install gzip

      - name: Bash syntax check
        run: |
          echo "Checking bash syntax for all .sh files in bin/ and lib/..."
          errors=0
          while IFS= read -r file; do
            if ! bash -n "$file"; then
              echo "FAIL: $file"
              errors=$((errors + 1))
            fi
          done < <(find bin/ lib/ -name '*.sh' -type f)
          if [ "$errors" -gt 0 ]; then
            echo "$errors file(s) with syntax errors"
            exit 1
          fi
          echo "All files passed syntax check."

      - name: Run test suite
        run: |
          chmod +x ./tests/run-all-tests.sh
          # Integration tests (shell integrations, git hooks, tmux, direnv)
          # require a full install and fail in CI â€” capture output for threshold check
          ./tests/run-all-tests.sh 2>&1 | tee /tmp/test-output.txt || true

      - name: Check test results
        run: |
          # Parse pass rate from test summary output
          rate_line=$(grep "Success Rate:" /tmp/test-output.txt | tail -1)
          if [ -z "$rate_line" ]; then
            echo "::error::Could not find test results"
            exit 1
          fi
          pass_rate=$(echo "$rate_line" | grep -oE '[0-9]+%' | tr -d '%')
          echo "Pass rate: ${pass_rate}%"
          if [ "$pass_rate" -lt 90 ]; then
            echo "::error::Pass rate ${pass_rate}% is below 90% threshold"
            exit 1
          fi
          echo "Tests passed threshold (${pass_rate}% >= 90%)"

  deploy:
    name: Deploy to Vercel
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@50.19.1

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: website
        run: vercel --prod --token "$VERCEL_TOKEN"
