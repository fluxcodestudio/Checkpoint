#!/usr/bin/env bash
# Checkpoint - Malware Scanner
# Scan backup for suspicious files before cloud upload

set -euo pipefail

# ==============================================================================
# INITIALIZATION
# ==============================================================================

# Resolve symlinks to get actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"

# Source foundation library
if [ -f "$LIB_DIR/backup-lib.sh" ]; then
    source "$LIB_DIR/backup-lib.sh"
else
    echo "Error: Foundation library not found: $LIB_DIR/backup-lib.sh" >&2
    exit 1
fi

# ==============================================================================
# COMMAND LINE OPTIONS
# ==============================================================================

PROJECT_DIR="${1:-${PWD}}"
SHOW_HELP=false

if [ "$PROJECT_DIR" = "--help" ] || [ "$PROJECT_DIR" = "-h" ]; then
    SHOW_HELP=true
fi

# ==============================================================================
# HELP TEXT
# ==============================================================================

if [ "$SHOW_HELP" = true ]; then
    cat <<EOF
Checkpoint - Malware Scanner

Scan backup files for malware indicators before cloud upload.

USAGE:
    backup-scan-malware.sh [PROJECT_DIR]

EXAMPLES:
    backup-scan-malware.sh              # Scan current project backup
    backup-scan-malware.sh /path/to/project

WHAT IT CHECKS:
    ‚úì macOS quarantine flags (files downloaded from internet)
    ‚úì Unsigned executables (potential trojans)
    ‚úì Suspicious file extensions (.exe, .bat, .vbs, etc.)

WHEN TO USE:
    - Before cloud backups (rclone, rsync to remote)
    - After cloning untrusted repositories
    - Periodically for peace of mind

WORKFLOW:
    1. Run backup-scan-malware.sh
    2. Review any suspicious files
    3. Remove/quarantine malware
    4. Proceed with cloud backup

NOTE: This is NOT a full antivirus scanner. For comprehensive scanning,
      use dedicated tools like ClamAV or macOS built-in XProtect.

EOF
    exit 0
fi

# ==============================================================================
# LOAD CONFIGURATION
# ==============================================================================

if ! load_backup_config "$PROJECT_DIR"; then
    echo "Error: No backup configuration found in: $PROJECT_DIR" >&2
    echo "This project is not configured for backups." >&2
    echo "Run install.sh first." >&2
    exit 1
fi

# ==============================================================================
# SCAN BACKUP
# ==============================================================================

echo ""
echo "üîç Scanning backup for malware indicators..."
echo ""

# Show what we're scanning
echo "Backup directory: $BACKUP_DIR"
echo ""

# Run scan and show report
if show_malware_report "$BACKUP_DIR"; then
    echo "‚úÖ Safe to proceed with cloud backup"
    exit 0
else
    echo "‚ö†Ô∏è  Review suspicious files before cloud backup"
    echo ""
    echo "To remove quarantine flags from safe files:"
    echo "  xattr -d com.apple.quarantine /path/to/file"
    echo ""
    exit 1
fi
