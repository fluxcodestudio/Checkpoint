#!/usr/bin/env bash
# ==============================================================================
# Checkpoint - Malware Detection
# macOS native malware scanning using quarantine flags, code signing, and
# suspicious extension detection
# ==============================================================================
# @requires: core/output (for color functions)
# @provides: scan_file_for_malware, scan_backup_for_malware,
#            show_malware_report, MALWARE_REASON, SUSPICIOUS_FILES
# ==============================================================================

# Include guard
[ -n "$_CHECKPOINT_MALWARE" ] && return || readonly _CHECKPOINT_MALWARE=1

# Lib directory (set by loader, fallback for standalone sourcing)
_CHECKPOINT_LIB_DIR="${_CHECKPOINT_LIB_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)}"

# ==============================================================================
# MALWARE DETECTION (macOS native tools)
# ==============================================================================

# Scan file for malware indicators using macOS built-in tools
# Args: $1 = file path
# Returns: 0 if clean, 1 if suspicious
# Sets: MALWARE_REASON (quarantine_flag|unsigned_executable|suspicious_extension)
scan_file_for_malware() {
    local file="$1"
    MALWARE_REASON=""

    # Skip directories
    [ ! -f "$file" ] && return 0

    # Check 1: macOS quarantine flag (file downloaded from internet and flagged)
    if xattr -l "$file" 2>/dev/null | grep -q "com.apple.quarantine"; then
        MALWARE_REASON="quarantine_flag"
        return 1
    fi

    # Check 2: Unsigned executable (potential risk)
    if [ -x "$file" ] && file "$file" | grep -qi "executable"; then
        # Check if it's signed
        if ! codesign -v "$file" 2>/dev/null; then
            MALWARE_REASON="unsigned_executable"
            return 1
        fi
    fi

    # Check 3: Suspicious file extensions
    case "$file" in
        *.exe|*.bat|*.cmd|*.scr|*.vbs|*.js|*.jar|*.app.zip)
            # Only flag if not from known safe locations
            if [[ "$file" != */node_modules/* ]] && [[ "$file" != */venv/* ]]; then
                MALWARE_REASON="suspicious_extension"
                return 1
            fi
            ;;
    esac

    # File appears clean
    return 0
}

# Scan all files in backup for malware
# Args: $1 = backup directory
# Returns: 0 if all clean, 1 if suspicious files found
# Sets: SUSPICIOUS_FILES (newline-separated list)
scan_backup_for_malware() {
    local backup_dir="$1"
    local suspicious_count=0
    SUSPICIOUS_FILES=""

    [ ! -d "$backup_dir" ] && return 0

    # Scan all files in backup
    while IFS= read -r file; do
        if ! scan_file_for_malware "$file"; then
            suspicious_count=$((suspicious_count + 1))
            SUSPICIOUS_FILES+="$file|$MALWARE_REASON"$'\n'
        fi
    done < <(find "$backup_dir" -type f 2>/dev/null)

    if [ $suspicious_count -gt 0 ]; then
        return 1
    fi

    return 0
}

# Display malware scan report
# Shows suspicious files with reasons and suggested actions
show_malware_report() {
    local backup_dir="$1"

    echo ""
    echo "ğŸ” MALWARE SCAN REPORT"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    if scan_backup_for_malware "$backup_dir"; then
        echo "âœ… No suspicious files detected"
        echo ""
        return 0
    fi

    echo "âš ï¸  SUSPICIOUS FILES DETECTED"
    echo ""

    local count=0
    while IFS='|' read -r file reason; do
        [ -z "$file" ] && continue
        count=$((count + 1))

        echo "$count. $file"
        case "$reason" in
            "quarantine_flag")
                echo "   âš ï¸  File has macOS quarantine flag (downloaded from internet)"
                echo "   Action: Review file, remove quarantine if safe: xattr -d com.apple.quarantine \"$file\""
                ;;
            "unsigned_executable")
                echo "   âš ï¸  Unsigned executable (potential risk)"
                echo "   Action: Verify source, consider deleting if unknown origin"
                ;;
            "suspicious_extension")
                echo "   âš ï¸  Suspicious file extension (.exe, .bat, .vbs, etc.)"
                echo "   Action: Review file, delete if not needed"
                ;;
        esac
        echo ""
    done <<< "$SUSPICIOUS_FILES"

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "RECOMMENDATION:"
    echo "  - Review suspicious files before cloud backup"
    echo "  - Remove malware/unwanted files from project"
    echo "  - Re-run backup after cleanup"
    echo "  - Use --skip-malware-scan to proceed anyway (NOT recommended)"
    echo ""

    return 1
}
